/*! For license information please see LICENSES */
(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{261:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return Mh})),n.d(e,"b",(function(){return Rc})),n.d(e,"c",(function(){return vc})),n.d(e,"d",(function(){return Gu})),n.d(e,"e",(function(){return Ph})),n.d(e,"f",(function(){return Mc})),n.d(e,"g",(function(){return A})),n.d(e,"h",(function(){return Lc})),n.d(e,"i",(function(){return qh})),n.d(e,"j",(function(){return Uh})),n.d(e,"k",(function(){return G})),n.d(e,"l",(function(){return il})),n.d(e,"m",(function(){return Et})),n.d(e,"n",(function(){return H})),n.d(e,"o",(function(){return W})),n.d(e,"p",(function(){return Pu})),n.d(e,"q",(function(){return x})),n.d(e,"r",(function(){return kt})),n.d(e,"s",(function(){return T})),n.d(e,"t",(function(){return Mu})),n.d(e,"u",(function(){return Zh})),n.d(e,"v",(function(){return gl})),n.d(e,"w",(function(){return ml})),n.d(e,"x",(function(){return xc})),n.d(e,"y",(function(){return zu})),n.d(e,"z",(function(){return Wu})),n.d(e,"A",(function(){return Ku})),n.d(e,"B",(function(){return Jh})),n.d(e,"C",(function(){return ll})),n.d(e,"D",(function(){return Ac})),n.d(e,"E",(function(){return Hu})),n.d(e,"F",(function(){return Ec})),n.d(e,"G",(function(){return _c})),n.d(e,"H",(function(){return Cc})),n.d(e,"I",(function(){return Ch})),n.d(e,"J",(function(){return Dh})),n.d(e,"K",(function(){return Ic})),n.d(e,"L",(function(){return nl})),n.d(e,"M",(function(){return Kh})),n.d(e,"N",(function(){return $h})),n.d(e,"O",(function(){return Qh})),n.d(e,"P",(function(){return zh})),n.d(e,"Q",(function(){return Wh})),n.d(e,"R",(function(){return Hh})),n.d(e,"S",(function(){return pl})),n.d(e,"T",(function(){return Th})),n.d(e,"U",(function(){return dl})),n.d(e,"V",(function(){return kc})),n.d(e,"W",(function(){return Nc})),n.d(e,"X",(function(){return tl})),n.d(e,"Y",(function(){return el})),n.d(e,"Z",(function(){return bh})),n.d(e,"ab",(function(){return ph})),n.d(e,"bb",(function(){return Xu})),n.d(e,"cb",(function(){return Yu})),n.d(e,"db",(function(){return hl})),n.d(e,"eb",(function(){return fl})),n.d(e,"fb",(function(){return Yh})),n.d(e,"gb",(function(){return w})),n.d(e,"hb",(function(){return jh})),n.d(e,"ib",(function(){return Sh})),n.d(e,"jb",(function(){return _h})),n.d(e,"kb",(function(){return Xh})),n.d(e,"lb",(function(){return Dc})),n.d(e,"mb",(function(){return wh}));var r=n(259),o=n(255),c=n(258),h=n(253),l=n(262);const b="@firebase/firestore";class d{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}d.UNAUTHENTICATED=new d(null),d.GOOGLE_CREDENTIALS=new d("google-credentials-uid"),d.FIRST_PARTY=new d("first-party-uid"),d.MOCK_USER=new d("mock-user");let f="9.15.0";const m=new c.b("@firebase/firestore");function y(){return m.logLevel}function w(t){m.setLogLevel(t)}function v(t,...e){if(m.logLevel<=c.a.DEBUG){const n=e.map(E);m.debug(`Firestore (${f}): ${t}`,...n)}}function I(t,...e){if(m.logLevel<=c.a.ERROR){const n=e.map(E);m.error(`Firestore (${f}): ${t}`,...n)}}function T(t,...e){if(m.logLevel<=c.a.WARN){const n=e.map(E);m.warn(`Firestore (${f}): ${t}`,...n)}}function E(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function _(t="Unexpected state"){const e=`FIRESTORE (${f}) INTERNAL ASSERTION FAILED: `+t;throw I(e),new Error(e)}function S(t,e){t||_()}function x(t,e){t||_()}function D(t,e){return t}const C={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class A extends h.c{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class q{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class k{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class N{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(d.UNAUTHENTICATED)))}shutdown(){}}class O{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class R{constructor(t){this.t=t,this.currentUser=d.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let i=new q;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new q,t.enqueueRetryable((()=>s(this.currentUser)))};const r=()=>{const e=i;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{v("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),r()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(v("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new q)}}),0),r()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(v("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(S("string"==typeof e.accessToken),new k(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return S(null===t||"string"==typeof t),new d(t)}}class M{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s,this.type="FirstParty",this.user=d.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(S(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const t=this.I();return t&&this.p.set("Authorization",t),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class F{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s}getToken(){return Promise.resolve(new M(this.h,this.l,this.m,this.g))}start(t,e){t.enqueueRetryable((()=>e(d.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class L{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class V{constructor(t){this.T=t,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,e){const n=t=>{null!=t.error&&v("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.A;return this.A=t.token,v("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{v("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.T.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.T.getImmediate({optional:!0});t?s(t):v("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(S("string"==typeof t.token),this.A=t.token,new L(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function P(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class U{static R(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=P(40);for(let i=0;i<s.length;++i)n.length<20&&s[i]<e&&(n+=t.charAt(s[i]%t.length))}return n}}function B(t,e){return t<e?-1:t>e?1:0}function j(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function K(t){return t+"\0"}class G{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new A(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new A(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new A(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new A(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return G.fromMillis(Date.now())}static fromDate(t){return G.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new G(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?B(this.nanoseconds,t.nanoseconds):B(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ${constructor(t){this.timestamp=t}static fromTimestamp(t){return new $(t)}static min(){return new $(new G(0,0))}static max(){return new $(new G(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Q{constructor(t,e,n){void 0===e?e=0:e>t.length&&_(),void 0===n?n=t.length-e:n>t.length-e&&_(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Q.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Q?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),i=e.get(s);if(n<i)return-1;if(n>i)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class rt extends Q{construct(t,e,n){return new rt(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new A(C.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new rt(e)}static emptyPath(){return new rt([])}}const z=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends Q{construct(t,e,n){return new W(t,e,n)}static isValidIdentifier(t){return z.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const i=()=>{if(0===n.length)throw new A(C.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let r=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new A(C.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new A(C.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(r=!r,s++):"."!==e||r?(n+=e,s++):(i(),s++)}if(i(),r)throw new A(C.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new W(e)}static emptyPath(){return new W([])}}class H{constructor(t){this.path=t}static fromPath(t){return new H(rt.fromString(t))}static fromName(t){return new H(rt.fromString(t).popFirst(5))}static empty(){return new H(rt.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===rt.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return rt.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new H(new rt(t.slice()))}}class Y{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function X(t){return t.fields.find((t=>2===t.kind))}function J(t){return t.fields.filter((t=>2!==t.kind))}Y.UNKNOWN_ID=-1;class dt{constructor(t,e){this.fieldPath=t,this.kind=e}}class Z{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Z(0,nt.min())}}function tt(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,i=$.fromTimestamp(1e9===s?new G(n+1,0):new G(n,s));return new nt(i,H.empty(),e)}function et(t){return new nt(t.readTime,t.key,-1)}class nt{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new nt($.min(),H.empty(),-1)}static max(){return new nt($.max(),H.empty(),-1)}}function st(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=H.comparator(t.documentKey,e.documentKey),0!==n?n:B(t.largestBatchId,e.largestBatchId))}const it="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ot{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function at(t){if(t.code!==C.FAILED_PRECONDITION||t.message!==it)throw t;v("LocalStore","Unexpectedly lost primary lease")}class ut{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&_(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new ut(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof ut?e:ut.resolve(e)}catch(t){return ut.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):ut.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):ut.reject(e)}static resolve(t){return new ut(((e,n)=>{e(t)}))}static reject(t){return new ut(((e,n)=>{n(t)}))}static waitFor(t){return new ut(((e,n)=>{let s=0,i=0,r=!1;t.forEach((t=>{++s,t.next((()=>{++i,r&&i===s&&e()}),(t=>n(t)))})),r=!0,i===s&&e()}))}static or(t){let e=ut.resolve(!1);for(const n of t)e=e.next((t=>t?ut.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}static mapArray(t,e){return new ut(((n,s)=>{const i=t.length,r=new Array(i);let o=0;for(let u=0;u<i;u++){const c=u;e(t[c]).next((t=>{r[c]=t,++o,o===i&&n(r)}),(t=>s(t)))}}))}static doWhile(t,e){return new ut(((n,s)=>{const i=()=>{!0===t()?e().next((()=>{i()}),s):n()};i()}))}}class ct{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.P=new q,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new ft(t,e.error)):this.P.resolve()},this.transaction.onerror=e=>{const n=wt(e.target.error);this.P.reject(new ft(t,n))}}static open(t,e,n,s){try{return new ct(e,t.transaction(s,n))}catch(t){throw new ft(e,t)}}get v(){return this.P.promise}abort(t){t&&this.P.reject(t),this.aborted||(v("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new gt(e)}}class ht{constructor(t,e,n){this.name=t,this.version=e,this.S=n,12.2===ht.D(Object(h.m)())&&I("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return v("SimpleDb","Removing database:",t),pt(window.indexedDB.deleteDatabase(t)).toPromise()}static C(){if(!Object(h.o)())return!1;if(ht.N())return!0;const t=Object(h.m)(),e=ht.D(t),n=0<e&&e<10,s=ht.k(t),i=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||i)}static N(){var e;return void 0!==t&&"YES"===(null===(e=t.env)||void 0===e?void 0:e.O)}static M(t,e){return t.store(e)}static D(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(t){return this.db||(v("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new ft(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new A(C.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new A(C.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new ft(t,s))},s.onupgradeneeded=t=>{v("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.S.$(e,s.transaction,t.oldVersion,this.version).next((()=>{v("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const i="readonly"===e;let r=0;for(;;){++r;try{this.db=await this.F(t);const e=ct.open(this.db,t,i?"readonly":"readwrite",n),r=s(e).next((t=>(e.V(),t))).catch((t=>(e.abort(t),ut.reject(t)))).toPromise();return r.catch((()=>{})),await e.v,r}catch(t){const e=t,n="FirebaseError"!==e.name&&r<3;if(v("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class lt{constructor(t){this.q=t,this.U=!1,this.K=null}get isDone(){return this.U}get G(){return this.K}set cursor(t){this.q=t}done(){this.U=!0}j(t){this.K=t}delete(){return pt(this.q.delete())}}class ft extends A{constructor(t,e){super(C.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function mt(t){return"IndexedDbTransactionError"===t.name}class gt{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(v("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(v("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),pt(n)}add(t){return v("SimpleDb","ADD",this.store.name,t,t),pt(this.store.add(t))}get(t){return pt(this.store.get(t)).next((e=>(void 0===e&&(e=null),v("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return v("SimpleDb","DELETE",this.store.name,t),pt(this.store.delete(t))}count(){return v("SimpleDb","COUNT",this.store.name),pt(this.store.count())}W(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.H(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new ut(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}J(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new ut(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}Y(t,e){v("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.X=!1;const s=this.cursor(n);return this.H(s,((t,e,n)=>n.delete()))}Z(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.H(s,e)}tt(t){const e=this.cursor({});return new ut(((n,s)=>{e.onerror=t=>{const e=wt(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}H(t,e){const n=[];return new ut(((s,i)=>{t.onerror=t=>{i(t.target.error)},t.onsuccess=t=>{const i=t.target.result;if(!i)return void s();const r=new lt(i),o=e(i.primaryKey,i.value,r);if(o instanceof ut){const t=o.catch((t=>(r.done(),ut.reject(t))));n.push(t)}r.isDone?s():null===r.G?i.continue():i.continue(r.G)}})).next((()=>ut.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.X?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function pt(t){return new ut(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=wt(t.target.error);n(e)}}))}let yt=!1;function wt(t){const e=ht.D(Object(h.m)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new A("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return yt||(yt=!0,setTimeout((()=>{throw t}),0)),t}}return t}class vt{constructor(t,e){this.asyncQueue=t,this.et=e,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(t){v("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{v("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(t){mt(t)?v("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await at(t)}await this.nt(6e4)}))}}class bt{constructor(t,e){this.localStore=t,this.persistence=e}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.it(e,t)))}it(t,e){const n=new Set;let s=e,i=!0;return ut.doWhile((()=>!0===i&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return v("IndexBackiller",`Processing collection: ${e}`),this.rt(t,e,s).next((t=>{s-=t,n.add(e)}));i=!1})))).next((()=>e-s))}rt(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((s=>this.localStore.localDocuments.getNextDocuments(t,e,s,n).next((n=>{const i=n.changes;return this.localStore.indexManager.updateIndexEntries(t,i).next((()=>this.ot(s,n))).next((n=>(v("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>i.size))}))))}ot(t,e){let n=t;return e.changes.forEach(((t,e)=>{const s=et(e);st(s,n)>0&&(n=s)})),new nt(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class It{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.ut(t),this.ct=t=>e.writeSequenceNumber(t))}ut(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ct&&this.ct(t),t}}It.at=-1;class Tt{constructor(t,e,n,s,i,r,o,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=i,this.forceLongPolling=r,this.autoDetectLongPolling=o,this.useFetchStreams=u}}class Et{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Et("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Et&&t.projectId===this.projectId&&t.database===this.database}}function _t(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function St(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function xt(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function Dt(t){return null==t}function Ct(t){return 0===t&&1/t==-1/0}function At(t){return"number"==typeof t&&Number.isInteger(t)&&!Ct(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function kt(){return"undefined"!=typeof atob}class Nt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new Nt(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Nt(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return B(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Nt.EMPTY_BYTE_STRING=new Nt("");const Ot=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Rt(t){if(S(!!t),"string"==typeof t){let e=0;const n=Ot.exec(t);if(S(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:Mt(t.seconds),nanos:Mt(t.nanos)}}function Mt(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Ft(t){return"string"==typeof t?Nt.fromBase64String(t):Nt.fromUint8Array(t)}function Lt(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Vt(t){const e=t.mapValue.fields.__previous_value__;return Lt(e)?Vt(e):e}function Pt(t){const e=Rt(t.mapValue.fields.__local_write_time__.timestampValue);return new G(e.seconds,e.nanos)}const qt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ut={nullValue:"NULL_VALUE"};function Bt(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Lt(t)?4:ee(t)?9007199254740991:10:_()}function jt(t,e){if(t===e)return!0;const n=Bt(t);if(n!==Bt(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Pt(t).isEqual(Pt(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Rt(t.timestampValue),s=Rt(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Ft(t.bytesValue).isEqual(Ft(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Mt(t.geoPointValue.latitude)===Mt(e.geoPointValue.latitude)&&Mt(t.geoPointValue.longitude)===Mt(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Mt(t.integerValue)===Mt(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Mt(t.doubleValue),s=Mt(e.doubleValue);return n===s?Ct(n)===Ct(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return j(t.arrayValue.values||[],e.arrayValue.values||[],jt);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(_t(n)!==_t(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!jt(n[t],s[t])))return!1;return!0}(t,e);default:return _()}}function Kt(t,e){return void 0!==(t.values||[]).find((t=>jt(t,e)))}function Gt(t,e){if(t===e)return 0;const n=Bt(t),s=Bt(e);if(n!==s)return B(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return B(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Mt(t.integerValue||t.doubleValue),s=Mt(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return $t(t.timestampValue,e.timestampValue);case 4:return $t(Pt(t),Pt(e));case 5:return B(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Ft(t),s=Ft(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=B(n[t],s[t]);if(0!==e)return e}return B(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=B(Mt(t.latitude),Mt(e.latitude));return 0!==n?n:B(Mt(t.longitude),Mt(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=Gt(n[t],s[t]);if(e)return e}return B(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===qt.mapValue&&e===qt.mapValue)return 0;if(t===qt.mapValue)return 1;if(e===qt.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),i=e.fields||{},r=Object.keys(i);s.sort(),r.sort();for(let t=0;t<s.length&&t<r.length;++t){const e=B(s[t],r[t]);if(0!==e)return e;const o=Gt(n[s[t]],i[r[t]]);if(0!==o)return o}return B(s.length,r.length)}(t.mapValue,e.mapValue);default:throw _()}}function $t(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return B(t,e);const n=Rt(t),s=Rt(e),i=B(n.seconds,s.seconds);return 0!==i?i:B(n.nanos,s.nanos)}function Qt(t){return zt(t)}function zt(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Rt(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Ft(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,H.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=zt(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const i of e)s?s=!1:n+=",",n+=`${i}:${zt(t.fields[i])}`;return n+"}"}(t.mapValue):_();var e,n}function Wt(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Ht(t){return!!t&&"integerValue"in t}function Yt(t){return!!t&&"arrayValue"in t}function Xt(t){return!!t&&"nullValue"in t}function Jt(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Zt(t){return!!t&&"mapValue"in t}function te(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return St(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=te(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=te(t.arrayValue.values[n]);return e}return Object.assign({},t)}function ee(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function ne(t){return"nullValue"in t?Ut:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Wt(Et.empty(),H.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:_()}function re(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Wt(Et.empty(),H.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?qt:_()}function se(t,e){const n=Gt(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function ie(t,e){const n=Gt(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class oe{constructor(t,e){this.position=t,this.inclusive=e}}function ae(t,e,n){let s=0;for(let i=0;i<t.position.length;i++){const r=e[i],o=t.position[i];if(s=r.field.isKeyField()?H.comparator(H.fromName(o.referenceValue),n.key):Gt(o,n.data.field(r.field)),"desc"===r.dir&&(s*=-1),0!==s)break}return s}function ue(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!jt(t.position[n],e.position[n]))return!1;return!0}class ce{}class he extends ce{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new be(t,e,n):"array-contains"===e?new _e(t,n):"in"===e?new Se(t,n):"not-in"===e?new xe(t,n):"array-contains-any"===e?new De(t,n):new he(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Ie(t,n):new Te(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Gt(e,this.value)):null!==e&&Bt(this.value)===Bt(e)&&this.matchesComparison(Gt(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return _()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class le extends ce{constructor(t,e){super(),this.filters=t,this.op=e,this.ht=null}static create(t,e){return new le(t,e)}matches(t){return de(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const t=this.lt((t=>t.isInequality()));return null!==t?t.field:null}lt(t){for(const e of this.getFlattenedFilters())if(t(e))return e;return null}}function de(t){return"and"===t.op}function fe(t){return"or"===t.op}function me(t){return ge(t)&&de(t)}function ge(t){for(const e of t.filters)if(e instanceof le)return!1;return!0}function pe(t){if(t instanceof he)return t.field.canonicalString()+t.op.toString()+Qt(t.value);{const e=t.filters.map((t=>pe(t))).join(",");return`${t.op}(${e})`}}function ye(t,e){return t instanceof he?function(t,e){return e instanceof he&&t.op===e.op&&t.field.isEqual(e.field)&&jt(t.value,e.value)}(t,e):t instanceof le?function(t,e){return e instanceof le&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,s)=>t&&ye(n,e.filters[s])),!0)}(t,e):void _()}function we(t,e){const n=t.filters.concat(e);return le.create(n,t.op)}function ve(t){return t instanceof he?function(t){return`${t.field.canonicalString()} ${t.op} ${Qt(t.value)}`}(t):t instanceof le?function(t){return t.op.toString()+" {"+t.getFilters().map(ve).join(" ,")+"}"}(t):"Filter"}class be extends he{constructor(t,e,n){super(t,e,n),this.key=H.fromName(n.referenceValue)}matches(t){const e=H.comparator(t.key,this.key);return this.matchesComparison(e)}}class Ie extends he{constructor(t,e){super(t,"in",e),this.keys=Ee("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Te extends he{constructor(t,e){super(t,"not-in",e),this.keys=Ee("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Ee(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>H.fromName(t.referenceValue)))}class _e extends he{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Yt(e)&&Kt(e.arrayValue,this.value)}}class Se extends he{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&Kt(this.value.arrayValue,e)}}class xe extends he{constructor(t,e){super(t,"not-in",e)}matches(t){if(Kt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!Kt(this.value.arrayValue,e)}}class De extends he{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Yt(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>Kt(this.value.arrayValue,t)))}}class Ce{constructor(t,e="asc"){this.field=t,this.dir=e}}function Ae(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class ke{constructor(t,e){this.comparator=t,this.root=e||Oe.EMPTY}insert(t,e){return new ke(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Oe.BLACK,null,null))}remove(t){return new ke(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Oe.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Ne(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Ne(this.root,t,this.comparator,!1)}getReverseIterator(){return new Ne(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Ne(this.root,t,this.comparator,!0)}}class Ne{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let i=1;for(;!t.isEmpty();)if(i=e?n(t.key,e):1,e&&s&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Oe{constructor(t,e,n,s,i){this.key=t,this.value=e,this.color=null!=n?n:Oe.RED,this.left=null!=s?s:Oe.EMPTY,this.right=null!=i?i:Oe.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,i){return new Oe(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const i=n(t,s.key);return s=i<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===i?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return Oe.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return Oe.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Oe.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Oe.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw _();if(this.right.isRed())throw _();const t=this.left.check();if(t!==this.right.check())throw _();return t+(this.isRed()?0:1)}}Oe.EMPTY=null,Oe.RED=!0,Oe.BLACK=!1,Oe.EMPTY=new class{constructor(){this.size=0}get key(){throw _()}get value(){throw _()}get color(){throw _()}get left(){throw _()}get right(){throw _()}copy(t,e,n,s,i){return this}insert(t,e,n){return new Oe(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Re{constructor(t){this.comparator=t,this.data=new ke(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Me(this.data.getIterator())}getIteratorFrom(t){return new Me(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Re))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Re(this.comparator);return e.data=t,e}}class Me{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Fe(t){return t.hasNext()?t.getNext():void 0}class Le{constructor(t){this.fields=t,t.sort(W.comparator)}static empty(){return new Le([])}unionWith(t){let e=new Re(W.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Le(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return j(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class Ve{constructor(t){this.value=t}static empty(){return new Ve({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Zt(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=te(e)}setAll(t){let e=W.emptyPath(),n={},s=[];t.forEach(((t,i)=>{if(!e.isImmediateParentOf(i)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=i.popLast()}t?n[i.lastSegment()]=te(t):s.push(i.lastSegment())}));const i=this.getFieldsMap(e);this.applyChanges(i,n,s)}delete(t){const e=this.field(t.popLast());Zt(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return jt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Zt(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){St(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Ve(te(this.value))}}function Pe(t){const e=[];return St(t.fields,((t,n)=>{const s=new W([t]);if(Zt(n)){const t=Pe(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new Le(e)}class qe{constructor(t,e,n,s,i,r,o){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.createTime=i,this.data=r,this.documentState=o}static newInvalidDocument(t){return new qe(t,0,$.min(),$.min(),$.min(),Ve.empty(),0)}static newFoundDocument(t,e,n,s){return new qe(t,1,e,$.min(),n,s,0)}static newNoDocument(t,e){return new qe(t,2,e,$.min(),$.min(),Ve.empty(),0)}static newUnknownDocument(t,e){return new qe(t,3,e,$.min(),$.min(),Ve.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual($.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Ve.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Ve.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=$.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof qe&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new qe(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ue{constructor(t,e=null,n=[],s=[],i=null,r=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=i,this.startAt=r,this.endAt=o,this.ft=null}}function Be(t,e=null,n=[],s=[],i=null,r=null,o=null){return new Ue(t,e,n,s,i,r,o)}function je(t){const e=D(t);if(null===e.ft){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>pe(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Dt(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>Qt(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>Qt(t))).join(",")),e.ft=t}return e.ft}function Ke(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Ae(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!ye(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!ue(t.startAt,e.startAt)&&ue(t.endAt,e.endAt)}function Ge(t){return H.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function $e(t,e){return t.filters.filter((t=>t instanceof he&&t.field.isEqual(e)))}function Qe(t,e,n){let s=Ut,i=!0;for(const n of $e(t,e)){let t=Ut,e=!0;switch(n.op){case"<":case"<=":t=ne(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Ut}se({value:s,inclusive:i},{value:t,inclusive:e})<0&&(s=t,i=e)}if(null!==n)for(let r=0;r<t.orderBy.length;++r)if(t.orderBy[r].field.isEqual(e)){const t=n.position[r];se({value:s,inclusive:i},{value:t,inclusive:n.inclusive})<0&&(s=t,i=n.inclusive);break}return{value:s,inclusive:i}}function ze(t,e,n){let s=qt,i=!0;for(const n of $e(t,e)){let t=qt,e=!0;switch(n.op){case">=":case">":t=re(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=qt}ie({value:s,inclusive:i},{value:t,inclusive:e})>0&&(s=t,i=e)}if(null!==n)for(let r=0;r<t.orderBy.length;++r)if(t.orderBy[r].field.isEqual(e)){const t=n.position[r];ie({value:s,inclusive:i},{value:t,inclusive:n.inclusive})>0&&(s=t,i=n.inclusive);break}return{value:s,inclusive:i}}class We{constructor(t,e=null,n=[],s=[],i=null,r="F",o=null,u=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=i,this.limitType=r,this.startAt=o,this.endAt=u,this.dt=null,this._t=null,this.startAt,this.endAt}}function He(t,e,n,s,i,r,o,u){return new We(t,e,n,s,i,r,o,u)}function Ye(t){return new We(t)}function Xe(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function Je(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Ze(t){for(const e of t.filters){const t=e.getFirstInequalityField();if(null!==t)return t}return null}function tn(t){return null!==t.collectionGroup}function en(t){const e=D(t);if(null===e.dt){e.dt=[];const t=Ze(e),n=Je(e);if(null!==t&&null===n)t.isKeyField()||e.dt.push(new Ce(t)),e.dt.push(new Ce(W.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.dt.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.dt.push(new Ce(W.keyField(),t))}}}return e.dt}function nn(t){const e=D(t);if(!e._t)if("F"===e.limitType)e._t=Be(e.path,e.collectionGroup,en(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of en(e)){const e="desc"===n.dir?"asc":"desc";t.push(new Ce(n.field,e))}const n=e.endAt?new oe(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new oe(e.startAt.position,e.startAt.inclusive):null;e._t=Be(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e._t}function rn(t,e){e.getFirstInequalityField(),Ze(t);const n=t.filters.concat([e]);return new We(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function sn(t,e,n){return new We(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function on(t,e){return Ke(nn(t),nn(e))&&t.limitType===e.limitType}function an(t){return`${je(nn(t))}|lt:${t.limitType}`}function un(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>ve(t))).join(", ")}]`),Dt(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>Qt(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>Qt(t))).join(",")),`Target(${e})`}(nn(t))}; limitType=${t.limitType})`}function cn(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):H.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of en(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=ae(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,en(t),e))&&!(t.endAt&&!function(t,e,n){const s=ae(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,en(t),e))}(t,e)}function hn(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function ln(t){return(e,n)=>{let s=!1;for(const i of en(t)){const t=dn(i,e,n);if(0!==t)return t;s=s||i.field.isKeyField()}return 0}}function dn(t,e,n){const s=t.field.isKeyField()?H.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),i=n.data.field(t);return null!==s&&null!==i?Gt(s,i):_()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return _()}}function fn(t,e){if(t.wt){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ct(e)?"-0":e}}function mn(t){return{integerValue:""+t}}function gn(t,e){return At(e)?mn(e):fn(t,e)}class pn{constructor(){this._=void 0}}function yn(t,e,n){return t instanceof bn?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof In?Tn(t,e):t instanceof En?_n(t,e):function(t,e){const n=vn(t,e),s=xn(n)+xn(t.gt);return Ht(n)&&Ht(t.gt)?mn(s):fn(t.yt,s)}(t,e)}function wn(t,e,n){return t instanceof In?Tn(t,e):t instanceof En?_n(t,e):n}function vn(t,e){return t instanceof Sn?Ht(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class bn extends pn{}class In extends pn{constructor(t){super(),this.elements=t}}function Tn(t,e){const n=Dn(e);for(const e of t.elements)n.some((t=>jt(t,e)))||n.push(e);return{arrayValue:{values:n}}}class En extends pn{constructor(t){super(),this.elements=t}}function _n(t,e){let n=Dn(e);for(const e of t.elements)n=n.filter((t=>!jt(t,e)));return{arrayValue:{values:n}}}class Sn extends pn{constructor(t,e){super(),this.yt=t,this.gt=e}}function xn(t){return Mt(t.integerValue||t.doubleValue)}function Dn(t){return Yt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Cn{constructor(t,e){this.field=t,this.transform=e}}class An{constructor(t,e){this.version=t,this.transformResults=e}}class kn{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new kn}static exists(t){return new kn(void 0,t)}static updateTime(t){return new kn(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Nn(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class On{}function Rn(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Kn(t.key,kn.none()):new Pn(t.key,t.data,kn.none());{const n=t.data,s=Ve.empty();let i=new Re(W.comparator);for(let t of e.fields)if(!i.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?s.delete(t):s.set(t,e),i=i.add(t)}return new qn(t.key,s,new Le(i.toArray()),kn.none())}}function Mn(t,e,n){t instanceof Pn?function(t,e,n){const s=t.value.clone(),i=Bn(t.fieldTransforms,e,n.transformResults);s.setAll(i),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof qn?function(t,e,n){if(!Nn(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=Bn(t.fieldTransforms,e,n.transformResults),i=e.data;i.setAll(Un(t)),i.setAll(s),e.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Fn(t,e,n,s){return t instanceof Pn?function(t,e,n,s){if(!Nn(t.precondition,e))return n;const i=t.value.clone(),r=jn(t.fieldTransforms,s,e);return i.setAll(r),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null}(t,e,n,s):t instanceof qn?function(t,e,n,s){if(!Nn(t.precondition,e))return n;const i=jn(t.fieldTransforms,s,e),r=e.data;return r.setAll(Un(t)),r.setAll(i),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,s):function(t,e,n){return Nn(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Ln(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),i=vn(s.transform,t||null);null!=i&&(null===n&&(n=Ve.empty()),n.set(s.field,i))}return n||null}function Vn(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&j(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof In&&e instanceof In||t instanceof En&&e instanceof En?j(t.elements,e.elements,jt):t instanceof Sn&&e instanceof Sn?jt(t.gt,e.gt):t instanceof bn&&e instanceof bn}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Pn extends On{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class qn extends On{constructor(t,e,n,s,i=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Un(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function Bn(t,e,n){const s=new Map;S(t.length===n.length);for(let i=0;i<n.length;i++){const r=t[i],o=r.transform,u=e.data.field(r.field);s.set(r.field,wn(o,u,n[i]))}return s}function jn(t,e,n){const s=new Map;for(const i of t){const t=i.transform,r=n.data.field(i.field);s.set(i.field,yn(t,r,e))}return s}class Kn extends On{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Gn extends On{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class $n{constructor(t){this.count=t}}var Qn,zn;function Wn(t){switch(t){default:return _();case C.CANCELLED:case C.UNKNOWN:case C.DEADLINE_EXCEEDED:case C.RESOURCE_EXHAUSTED:case C.INTERNAL:case C.UNAVAILABLE:case C.UNAUTHENTICATED:return!1;case C.INVALID_ARGUMENT:case C.NOT_FOUND:case C.ALREADY_EXISTS:case C.PERMISSION_DENIED:case C.FAILED_PRECONDITION:case C.ABORTED:case C.OUT_OF_RANGE:case C.UNIMPLEMENTED:case C.DATA_LOSS:return!0}}function Hn(t){if(void 0===t)return I("GRPC error has no .code"),C.UNKNOWN;switch(t){case Qn.OK:return C.OK;case Qn.CANCELLED:return C.CANCELLED;case Qn.UNKNOWN:return C.UNKNOWN;case Qn.DEADLINE_EXCEEDED:return C.DEADLINE_EXCEEDED;case Qn.RESOURCE_EXHAUSTED:return C.RESOURCE_EXHAUSTED;case Qn.INTERNAL:return C.INTERNAL;case Qn.UNAVAILABLE:return C.UNAVAILABLE;case Qn.UNAUTHENTICATED:return C.UNAUTHENTICATED;case Qn.INVALID_ARGUMENT:return C.INVALID_ARGUMENT;case Qn.NOT_FOUND:return C.NOT_FOUND;case Qn.ALREADY_EXISTS:return C.ALREADY_EXISTS;case Qn.PERMISSION_DENIED:return C.PERMISSION_DENIED;case Qn.FAILED_PRECONDITION:return C.FAILED_PRECONDITION;case Qn.ABORTED:return C.ABORTED;case Qn.OUT_OF_RANGE:return C.OUT_OF_RANGE;case Qn.UNIMPLEMENTED:return C.UNIMPLEMENTED;case Qn.DATA_LOSS:return C.DATA_LOSS;default:return _()}}(zn=Qn||(Qn={}))[zn.OK=0]="OK",zn[zn.CANCELLED=1]="CANCELLED",zn[zn.UNKNOWN=2]="UNKNOWN",zn[zn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",zn[zn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",zn[zn.NOT_FOUND=5]="NOT_FOUND",zn[zn.ALREADY_EXISTS=6]="ALREADY_EXISTS",zn[zn.PERMISSION_DENIED=7]="PERMISSION_DENIED",zn[zn.UNAUTHENTICATED=16]="UNAUTHENTICATED",zn[zn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",zn[zn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",zn[zn.ABORTED=10]="ABORTED",zn[zn.OUT_OF_RANGE=11]="OUT_OF_RANGE",zn[zn.UNIMPLEMENTED=12]="UNIMPLEMENTED",zn[zn.INTERNAL=13]="INTERNAL",zn[zn.UNAVAILABLE=14]="UNAVAILABLE",zn[zn.DATA_LOSS=15]="DATA_LOSS";class Yn{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){St(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return xt(this.inner)}size(){return this.innerSize}}const Xn=new ke(H.comparator);function Jn(){return Xn}const Zn=new ke(H.comparator);function er(...t){let e=Zn;for(const n of t)e=e.insert(n.key,n);return e}function nr(t){let e=Zn;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function rr(){return ir()}function sr(){return ir()}function ir(){return new Yn((t=>t.toString()),((t,e)=>t.isEqual(e)))}const or=new ke(H.comparator),ar=new Re(H.comparator);function ur(...t){let e=ar;for(const n of t)e=e.add(n);return e}const cr=new Re(B);function lr(){return cr}class dr{constructor(t,e,n,s,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const s=new Map;return s.set(t,fr.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new dr($.min(),s,lr(),Jn(),ur())}}class fr{constructor(t,e,n,s,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new fr(n,e,ur(),ur(),ur())}}class mr{constructor(t,e,n,s){this.It=t,this.removedTargetIds=e,this.key=n,this.Tt=s}}class gr{constructor(t,e){this.targetId=t,this.Et=e}}class pr{constructor(t,e,n=Nt.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class yr{constructor(){this.At=0,this.Rt=Ir(),this.bt=Nt.EMPTY_BYTE_STRING,this.Pt=!1,this.vt=!0}get current(){return this.Pt}get resumeToken(){return this.bt}get Vt(){return 0!==this.At}get St(){return this.vt}Dt(t){t.approximateByteSize()>0&&(this.vt=!0,this.bt=t)}Ct(){let t=ur(),e=ur(),n=ur();return this.Rt.forEach(((s,i)=>{switch(i){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:_()}})),new fr(this.bt,this.Pt,t,e,n)}xt(){this.vt=!1,this.Rt=Ir()}Nt(t,e){this.vt=!0,this.Rt=this.Rt.insert(t,e)}kt(t){this.vt=!0,this.Rt=this.Rt.remove(t)}Ot(){this.At+=1}Mt(){this.At-=1}Ft(){this.vt=!0,this.Pt=!0}}class wr{constructor(t){this.$t=t,this.Bt=new Map,this.Lt=Jn(),this.qt=vr(),this.Ut=new Re(B)}Kt(t){for(const e of t.It)t.Tt&&t.Tt.isFoundDocument()?this.Gt(e,t.Tt):this.Qt(e,t.key,t.Tt);for(const e of t.removedTargetIds)this.Qt(e,t.key,t.Tt)}jt(t){this.forEachTarget(t,(e=>{const n=this.Wt(e);switch(t.state){case 0:this.zt(e)&&n.Dt(t.resumeToken);break;case 1:n.Mt(),n.Vt||n.xt(),n.Dt(t.resumeToken);break;case 2:n.Mt(),n.Vt||this.removeTarget(e);break;case 3:this.zt(e)&&(n.Ft(),n.Dt(t.resumeToken));break;case 4:this.zt(e)&&(this.Ht(e),n.Dt(t.resumeToken));break;default:_()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Bt.forEach(((t,n)=>{this.zt(n)&&e(n)}))}Jt(t){const e=t.targetId,n=t.Et.count,s=this.Yt(e);if(s){const t=s.target;if(Ge(t))if(0===n){const n=new H(t.path);this.Qt(e,n,qe.newNoDocument(n,$.min()))}else S(1===n);else this.Xt(e)!==n&&(this.Ht(e),this.Ut=this.Ut.add(e))}}Zt(t){const e=new Map;this.Bt.forEach(((n,s)=>{const i=this.Yt(s);if(i){if(n.current&&Ge(i.target)){const e=new H(i.target.path);null!==this.Lt.get(e)||this.te(s,e)||this.Qt(s,e,qe.newNoDocument(e,t))}n.St&&(e.set(s,n.Ct()),n.xt())}}));let n=ur();this.qt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.Yt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.Lt.forEach(((e,n)=>n.setReadTime(t)));const s=new dr(t,e,this.Ut,this.Lt,n);return this.Lt=Jn(),this.qt=vr(),this.Ut=new Re(B),s}Gt(t,e){if(!this.zt(t))return;const n=this.te(t,e.key)?2:0;this.Wt(t).Nt(e.key,n),this.Lt=this.Lt.insert(e.key,e),this.qt=this.qt.insert(e.key,this.ee(e.key).add(t))}Qt(t,e,n){if(!this.zt(t))return;const s=this.Wt(t);this.te(t,e)?s.Nt(e,1):s.kt(e),this.qt=this.qt.insert(e,this.ee(e).delete(t)),n&&(this.Lt=this.Lt.insert(e,n))}removeTarget(t){this.Bt.delete(t)}Xt(t){const e=this.Wt(t).Ct();return this.$t.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Ot(t){this.Wt(t).Ot()}Wt(t){let e=this.Bt.get(t);return e||(e=new yr,this.Bt.set(t,e)),e}ee(t){let e=this.qt.get(t);return e||(e=new Re(B),this.qt=this.qt.insert(t,e)),e}zt(t){const e=null!==this.Yt(t);return e||v("WatchChangeAggregator","Detected inactive target",t),e}Yt(t){const e=this.Bt.get(t);return e&&e.Vt?null:this.$t.ne(t)}Ht(t){this.Bt.set(t,new yr),this.$t.getRemoteKeysForTarget(t).forEach((e=>{this.Qt(t,e,null)}))}te(t,e){return this.$t.getRemoteKeysForTarget(t).has(e)}}function vr(){return new ke(H.comparator)}function Ir(){return new ke(H.comparator)}const Tr={asc:"ASCENDING",desc:"DESCENDING"},Er={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},_r={and:"AND",or:"OR"};class Sr{constructor(t,e){this.databaseId=t,this.wt=e}}function xr(t,e){return t.wt?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Dr(t,e){return t.wt?e.toBase64():e.toUint8Array()}function Cr(t,e){return xr(t,e.toTimestamp())}function Ar(t){return S(!!t),$.fromTimestamp(function(t){const e=Rt(t);return new G(e.seconds,e.nanos)}(t))}function kr(t,e){return function(t){return new rt(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Nr(t){const e=rt.fromString(t);return S(Jr(e)),e}function Or(t,e){return kr(t.databaseId,e.path)}function Rr(t,e){const n=Nr(e);if(n.get(1)!==t.databaseId.projectId)throw new A(C.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new A(C.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new H(Vr(n))}function Mr(t,e){return kr(t.databaseId,e)}function Fr(t){const e=Nr(t);return 4===e.length?rt.emptyPath():Vr(e)}function Lr(t){return new rt(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Vr(t){return S(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Pr(t,e,n){return{name:Or(t,e),fields:n.value.mapValue.fields}}function qr(t,e,n){const s=Rr(t,e.name),i=Ar(e.updateTime),r=e.createTime?Ar(e.createTime):$.min(),o=new Ve({mapValue:{fields:e.fields}}),u=qe.newFoundDocument(s,i,r,o);return n&&u.setHasCommittedMutations(),n?u.setHasCommittedMutations():u}function Ur(t,e){let n;if(e instanceof Pn)n={update:Pr(t,e.key,e.value)};else if(e instanceof Kn)n={delete:Or(t,e.key)};else if(e instanceof qn)n={update:Pr(t,e.key,e.data),updateMask:Xr(e.fieldMask)};else{if(!(e instanceof Gn))return _();n={verify:Or(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof bn)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof In)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof En)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Sn)return{fieldPath:e.field.canonicalString(),increment:n.gt};throw _()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Cr(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:_()}(t,e.precondition)),n}function Br(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?kn.updateTime(Ar(t.updateTime)):void 0!==t.exists?kn.exists(t.exists):kn.none()}(e.currentDocument):kn.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)S("REQUEST_TIME"===e.setToServerValue),n=new bn;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new In(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new En(t)}else"increment"in e?n=new Sn(t,e.increment):_();const s=W.fromServerFormat(e.fieldPath);return new Cn(s,n)}(t,e))):[];if(e.update){e.update.name;const i=Rr(t,e.update.name),r=new Ve({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Le(e.map((t=>W.fromServerFormat(t))))}(e.updateMask);return new qn(i,r,t,n,s)}return new Pn(i,r,n,s)}if(e.delete){const s=Rr(t,e.delete);return new Kn(s,n)}if(e.verify){const s=Rr(t,e.verify);return new Gn(s,n)}return _()}function jr(t,e){return{documents:[Mr(t,e.path)]}}function Kr(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=Mr(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Mr(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const i=function(t){if(0!==t.length)return Yr(le.create(t,"and"))}(e.filters);i&&(n.structuredQuery.where=i);const r=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:li(t.field),direction:Qr(t.dir)}}(t)))}(e.orderBy);r&&(n.structuredQuery.orderBy=r);const o=function(t,e){return t.wt||Dt(e)?e:{value:e}}(t,e.limit);var u;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(u=e.startAt).inclusive,values:u.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function Gr(t){let e=Fr(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let i=null;if(s>0){S(1===s);const t=n.from[0];t.allDescendants?i=t.collectionId:e=e.child(t.collectionId)}let r=[];n.where&&(r=function(t){const e=$r(t);return e instanceof le&&me(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Ce(Hr(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let u=null;n.limit&&(u=function(t){let e;return e="object"==typeof t?t.value:t,Dt(e)?null:e}(n.limit));let c=null;n.startAt&&(c=function(t){const e=!!t.before,n=t.values||[];return new oe(n,e)}(n.startAt));let a=null;return n.endAt&&(a=function(t){const e=!t.before,n=t.values||[];return new oe(n,e)}(n.endAt)),He(e,i,o,r,u,"F",c,a)}function $r(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Hr(t.unaryFilter.field);return he.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Hr(t.unaryFilter.field);return he.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Hr(t.unaryFilter.field);return he.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Hr(t.unaryFilter.field);return he.create(i,"!=",{nullValue:"NULL_VALUE"});default:return _()}}(t):void 0!==t.fieldFilter?function(t){return he.create(Hr(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return _()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return le.create(t.compositeFilter.filters.map((t=>$r(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return _()}}(t.compositeFilter.op))}(t):_()}function Qr(t){return Tr[t]}function zr(t){return Er[t]}function Wr(t){return _r[t]}function li(t){return{fieldPath:t.canonicalString()}}function Hr(t){return W.fromServerFormat(t.fieldPath)}function Yr(t){return t instanceof he?function(t){if("=="===t.op){if(Jt(t.value))return{unaryFilter:{field:li(t.field),op:"IS_NAN"}};if(Xt(t.value))return{unaryFilter:{field:li(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Jt(t.value))return{unaryFilter:{field:li(t.field),op:"IS_NOT_NAN"}};if(Xt(t.value))return{unaryFilter:{field:li(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:li(t.field),op:zr(t.op),value:t.value}}}(t):t instanceof le?function(t){const e=t.getFilters().map((t=>Yr(t)));return 1===e.length?e[0]:{compositeFilter:{op:Wr(t.op),filters:e}}}(t):_()}function Xr(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Jr(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Zr(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=es(e)),e=ts(t.get(n),e);return es(e)}function ts(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function es(t){return t+""}function ns(t){const e=t.length;if(S(e>=2),2===e)return S(""===t.charAt(0)&&""===t.charAt(1)),rt.emptyPath();const n=e-2,s=[];let i="";for(let r=0;r<e;){const e=t.indexOf("",r);switch((e<0||e>n)&&_(),t.charAt(e+1)){case"":const n=t.substring(r,e);let o;0===i.length?o=n:(i+=n,o=i,i=""),s.push(o);break;case"":i+=t.substring(r,e),i+="\0";break;case"":i+=t.substring(r,e+1);break;default:_()}r=e+2}return new rt(s)}const rs=["userId","batchId"];function ss(t,e){return[t,Zr(e)]}function is(t,e,n){return[t,Zr(e),n]}const os={},as=["prefixPath","collectionGroup","readTime","documentId"],us=["prefixPath","collectionGroup","documentId"],cs=["collectionGroup","readTime","prefixPath","documentId"],hs=["canonicalId","targetId"],ls=["targetId","path"],ds=["path","targetId"],fs=["collectionId","parent"],ms=["indexId","uid"],gs=["uid","sequenceNumber"],ps=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ys=["indexId","uid","orderedDocumentKey"],ws=["userId","collectionPath","documentId"],vs=["userId","collectionPath","largestBatchId"],bs=["userId","collectionGroup","largestBatchId"],Is=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ts=[...Is,"documentOverlays"],Es=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],_s=Es,Ss=[..._s,"indexConfiguration","indexState","indexEntries"];class xs extends ot{constructor(t,e){super(),this.se=t,this.currentSequenceNumber=e}}function Ds(t,e){const n=D(t);return ht.M(n.se,e)}class Cs{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&Mn(s,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Fn(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Fn(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=sr();return this.mutations.forEach((s=>{const i=t.get(s.key),r=i.overlayedDocument;let o=this.applyToLocalView(r,i.mutatedFields);o=e.has(s.key)?null:o;const u=Rn(r,o);null!==u&&n.set(s.key,u),r.isValidDocument()||r.convertToNoDocument($.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),ur())}isEqual(t){return this.batchId===t.batchId&&j(this.mutations,t.mutations,((t,e)=>Vn(t,e)))&&j(this.baseMutations,t.baseMutations,((t,e)=>Vn(t,e)))}}class As{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){S(t.mutations.length===n.length);let s=or;const i=t.mutations;for(let t=0;t<i.length;t++)s=s.insert(i[t].key,n[t].version);return new As(t,e,n,s)}}class ks{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ns{constructor(t,e,n,s,i=$.min(),r=$.min(),o=Nt.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=r,this.resumeToken=o}withSequenceNumber(t){return new Ns(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Ns(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Ns(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Os{constructor(t){this.ie=t}}function Rs(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Ms(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:Or(t,e.key),fields:e.data.value.mapValue.fields,updateTime:xr(t,e.version.toTimestamp()),createTime:xr(t,e.createTime.toTimestamp())}}(t.ie,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:Fs(e.version)};else{if(!e.isUnknownDocument())return _();s.unknownDocument={path:n.path.toArray(),version:Fs(e.version)}}return s}function Ms(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Fs(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function tr(t){const e=new G(t.seconds,t.nanoseconds);return $.fromTimestamp(e)}function Ls(t,e){const n=(e.baseMutations||[]).map((e=>Br(t.ie,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Br(t.ie,e))),i=G.fromMillis(e.localWriteTimeMs);return new Cs(e.batchId,i,n,s)}function Vs(t){const e=tr(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?tr(t.lastLimboFreeSnapshotVersion):$.min();let s;var i;return void 0!==t.query.documents?(S(1===(i=t.query).documents.length),s=nn(Ye(Fr(i.documents[0])))):s=function(t){return nn(Gr(t))}(t.query),new Ns(s,t.targetId,0,t.lastListenSequenceNumber,e,n,Nt.fromBase64String(t.resumeToken))}function Ps(t,e){const n=Fs(e.snapshotVersion),s=Fs(e.lastLimboFreeSnapshotVersion);let i;i=Ge(e.target)?jr(t.ie,e.target):Kr(t.ie,e.target);const r=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:je(e.target),readTime:n,resumeToken:r,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:i}}function qs(t){const e=Gr({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?sn(e,e.limit,"L"):e}function Us(t,e){return new ks(e.largestBatchId,Br(t.ie,e.overlayMutation))}function Bs(t,e){const n=e.path.lastSegment();return[t,Zr(e.path.popLast()),n]}function js(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:Fs(s.readTime),documentKey:Zr(s.documentKey.path),largestBatchId:s.largestBatchId}}class Ks{getBundleMetadata(t,e){return Gs(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:tr(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Gs(t).put({bundleId:(n=e).id,createTime:Fs(Ar(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return hr(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:qs(e.bundledQuery),readTime:tr(e.readTime)};var e}))}saveNamedQuery(t,e){return hr(t).put(function(t){return{name:t.name,readTime:Fs(Ar(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Gs(t){return Ds(t,"bundles")}function hr(t){return Ds(t,"namedQueries")}class $s{constructor(t,e){this.yt=t,this.userId=e}static re(t,e){const n=e.uid||"";return new $s(t,n)}getOverlay(t,e){return Qs(t).get(Bs(this.userId,e)).next((t=>t?Us(this.yt,t):null))}getOverlays(t,e){const n=rr();return ut.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,i)=>{const r=new ks(e,i);s.push(this.oe(t,r))})),ut.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(Zr(t.getCollectionPath()))));const i=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);i.push(Qs(t).Y("collectionPathOverlayIndex",s))})),ut.waitFor(i)}getOverlaysForCollection(t,e,n){const s=rr(),i=Zr(e),r=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Qs(t).W("collectionPathOverlayIndex",r).next((t=>{for(const e of t){const t=Us(this.yt,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const i=rr();let r;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Qs(t).Z({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=Us(this.yt,e);i.size()<s||o.largestBatchId===r?(i.set(o.getKey(),o),r=o.largestBatchId):n.done()})).next((()=>i))}oe(t,e){return Qs(t).put(function(t,e,n){const[s,i,r]=Bs(e,n.mutation.key);return{userId:e,collectionPath:i,documentId:r,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ur(t.ie,n.mutation)}}(this.yt,this.userId,e))}}function Qs(t){return Ds(t,"documentOverlays")}class zs{constructor(){}ue(t,e){this.ce(t,e),e.ae()}ce(t,e){if("nullValue"in t)this.he(e,5);else if("booleanValue"in t)this.he(e,10),e.le(t.booleanValue?1:0);else if("integerValue"in t)this.he(e,15),e.le(Mt(t.integerValue));else if("doubleValue"in t){const n=Mt(t.doubleValue);isNaN(n)?this.he(e,13):(this.he(e,15),Ct(n)?e.le(0):e.le(n))}else if("timestampValue"in t){const n=t.timestampValue;this.he(e,20),"string"==typeof n?e.fe(n):(e.fe(`${n.seconds||""}`),e.le(n.nanos||0))}else if("stringValue"in t)this.de(t.stringValue,e),this._e(e);else if("bytesValue"in t)this.he(e,30),e.we(Ft(t.bytesValue)),this._e(e);else if("referenceValue"in t)this.me(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.he(e,45),e.le(n.latitude||0),e.le(n.longitude||0)}else"mapValue"in t?ee(t)?this.he(e,Number.MAX_SAFE_INTEGER):(this.ge(t.mapValue,e),this._e(e)):"arrayValue"in t?(this.ye(t.arrayValue,e),this._e(e)):_()}de(t,e){this.he(e,25),this.pe(t,e)}pe(t,e){e.fe(t)}ge(t,e){const n=t.fields||{};this.he(e,55);for(const t of Object.keys(n))this.de(t,e),this.ce(n[t],e)}ye(t,e){const n=t.values||[];this.he(e,50);for(const t of n)this.ce(t,e)}me(t,e){this.he(e,37),H.fromName(t).path.forEach((t=>{this.he(e,60),this.pe(t,e)}))}he(t,e){t.le(e)}_e(t){t.le(2)}}function Ws(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Hs(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=Ws(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}zs.Ie=new zs;class Ys{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Te(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ee(n.value),n=e.next();this.Ae()}Re(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.be(n.value),n=e.next();this.Pe()}ve(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ee(t);else if(t<2048)this.Ee(960|t>>>6),this.Ee(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ee(480|t>>>12),this.Ee(128|63&t>>>6),this.Ee(128|63&t);else{const t=e.codePointAt(0);this.Ee(240|t>>>18),this.Ee(128|63&t>>>12),this.Ee(128|63&t>>>6),this.Ee(128|63&t)}}this.Ae()}Ve(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.be(t);else if(t<2048)this.be(960|t>>>6),this.be(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.be(480|t>>>12),this.be(128|63&t>>>6),this.be(128|63&t);else{const t=e.codePointAt(0);this.be(240|t>>>18),this.be(128|63&t>>>12),this.be(128|63&t>>>6),this.be(128|63&t)}}this.Pe()}Se(t){const e=this.De(t),n=Hs(e);this.Ce(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}xe(t){const e=this.De(t),n=Hs(e);this.Ce(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Ne(){this.ke(255),this.ke(255)}Oe(){this.Me(255),this.Me(255)}reset(){this.position=0}seed(t){this.Ce(t.length),this.buffer.set(t,this.position),this.position+=t.length}Fe(){return this.buffer.slice(0,this.position)}De(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ee(t){const e=255&t;0===e?(this.ke(0),this.ke(255)):255===e?(this.ke(255),this.ke(0)):this.ke(e)}be(t){const e=255&t;0===e?(this.Me(0),this.Me(255)):255===e?(this.Me(255),this.Me(0)):this.Me(t)}Ae(){this.ke(0),this.ke(1)}Pe(){this.Me(0),this.Me(1)}ke(t){this.Ce(1),this.buffer[this.position++]=t}Me(t){this.Ce(1),this.buffer[this.position++]=~t}Ce(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Xs{constructor(t){this.$e=t}we(t){this.$e.Te(t)}fe(t){this.$e.ve(t)}le(t){this.$e.Se(t)}ae(){this.$e.Ne()}}class Js{constructor(t){this.$e=t}we(t){this.$e.Re(t)}fe(t){this.$e.Ve(t)}le(t){this.$e.xe(t)}ae(){this.$e.Oe()}}class Zs{constructor(){this.$e=new Ys,this.Be=new Xs(this.$e),this.Le=new Js(this.$e)}seed(t){this.$e.seed(t)}qe(t){return 0===t?this.Be:this.Le}Fe(){return this.$e.Fe()}reset(){this.$e.reset()}}class ti{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}Ue(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new ti(this.indexId,this.documentKey,this.arrayValue,n)}}function ei(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=ni(t.arrayValue,e.arrayValue),0!==n?n:(n=ni(t.directionalValue,e.directionalValue),0!==n?n:H.comparator(t.documentKey,e.documentKey)))}function ni(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class ri{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ke=t.orderBy,this.Ge=[];for(const e of t.filters){const t=e;t.isInequality()?this.Qe=t:this.Ge.push(t)}}je(t){S(t.collectionGroup===this.collectionId);const e=X(t);if(void 0!==e&&!this.We(e))return!1;const n=J(t);let s=0,i=0;for(;s<n.length&&this.We(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.Qe){const t=n[s];if(!this.ze(this.Qe,t)||!this.He(this.Ke[i++],t))return!1;++s}for(;s<n.length;++s){const t=n[s];if(i>=this.Ke.length||!this.He(this.Ke[i++],t))return!1}return!0}We(t){for(const e of this.Ge)if(this.ze(e,t))return!0;return!1}ze(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}He(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function si(t){var e,n;if(S(t instanceof he||t instanceof le),t instanceof he){if(t instanceof Se){const s=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>he.create(t.field,"==",e))))||[];return le.create(s,"or")}return t}const s=t.filters.map((t=>si(t)));return le.create(s,t.op)}function br(t){if(0===t.getFilters().length)return[];const e=ui(si(t));return S(ai(e)),ii(e)||oi(e)?[e]:e.getFilters()}function ii(t){return t instanceof he}function oi(t){return t instanceof le&&me(t)}function ai(t){return ii(t)||oi(t)||function(t){if(t instanceof le&&fe(t)){for(const e of t.getFilters())if(!ii(e)&&!oi(e))return!1;return!0}return!1}(t)}function ui(t){if(S(t instanceof he||t instanceof le),t instanceof he)return t;if(1===t.filters.length)return ui(t.filters[0]);const e=t.filters.map((t=>ui(t)));let n=le.create(e,t.op);return n=di(n),ai(n)?n:(S(n instanceof le),S(de(n)),S(n.filters.length>1),n.filters.reduce(((t,e)=>ci(t,e))))}function ci(t,e){let n;return S(t instanceof he||t instanceof le),S(e instanceof he||e instanceof le),n=t instanceof he?e instanceof he?function(t,e){return le.create([t,e],"and")}(t,e):hi(t,e):e instanceof he?hi(e,t):function(t,e){if(S(t.filters.length>0&&e.filters.length>0),de(t)&&de(e))return we(t,e.getFilters());const n=fe(t)?t:e,s=fe(t)?e:t,i=n.filters.map((t=>ci(t,s)));return le.create(i,"or")}(t,e),di(n)}function hi(t,e){if(de(e))return we(e,t.getFilters());{const n=e.filters.map((e=>ci(t,e)));return le.create(n,"or")}}function di(t){if(S(t instanceof he||t instanceof le),t instanceof he)return t;const e=t.getFilters();if(1===e.length)return di(e[0]);if(ge(t))return t;const n=e.map((t=>di(t))),s=[];return n.forEach((e=>{e instanceof he?s.push(e):e instanceof le&&(e.op===t.op?s.push(...e.filters):s.push(e))})),1===s.length?s[0]:le.create(s,t.op)}class fi{constructor(){this.Je=new mi}addToCollectionParentIndex(t,e){return this.Je.add(e),ut.resolve()}getCollectionParents(t,e){return ut.resolve(this.Je.getEntries(e))}addFieldIndex(t,e){return ut.resolve()}deleteFieldIndex(t,e){return ut.resolve()}getDocumentsMatchingTarget(t,e){return ut.resolve(null)}getIndexType(t,e){return ut.resolve(0)}getFieldIndexes(t,e){return ut.resolve([])}getNextCollectionGroupToUpdate(t){return ut.resolve(null)}getMinOffset(t,e){return ut.resolve(nt.min())}getMinOffsetFromCollectionGroup(t,e){return ut.resolve(nt.min())}updateCollectionGroup(t,e,n){return ut.resolve()}updateIndexEntries(t,e){return ut.resolve()}}class mi{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new Re(rt.comparator),i=!s.has(n);return this.index[e]=s.add(n),i}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new Re(rt.comparator)).toArray()}}const gi=new Uint8Array(0);class pi{constructor(t,e){this.user=t,this.databaseId=e,this.Ye=new mi,this.Xe=new Yn((t=>je(t)),((t,e)=>Ke(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.Ye.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.Ye.add(e)}));const i={collectionId:n,parent:Zr(s)};return yi(t).put(i)}return ut.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[K(e),""],!1,!0);return yi(t).W(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(ns(s.parent))}return n}))}addFieldIndex(t,e){const n=vi(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete s.indexId;const i=n.add(s);if(e.indexState){const n=bi(t);return i.next((t=>{n.put(js(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return i.next()}deleteFieldIndex(t,e){const n=vi(t),s=bi(t),i=wi(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=wi(t);let s=!0;const i=new Map;return ut.forEach(this.Ze(e),(e=>this.tn(t,e).next((t=>{s&&(s=!!t),i.set(e,t)})))).next((()=>{if(s){let t=ur();const s=[];return ut.forEach(i,((i,r)=>{var o;v("IndexedDbIndexManager",`Using index ${o=i,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${je(e)}`);const u=function(t,e){const n=X(e);if(void 0===n)return null;for(const e of $e(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(r,i),c=function(t,e){const n=new Map;for(const s of J(e))for(const e of $e(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(r,i),a=function(t,e){const n=[];let s=!0;for(const i of J(e)){const e=0===i.kind?Qe(t,i.fieldPath,t.startAt):ze(t,i.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new oe(n,s)}(r,i),h=function(t,e){const n=[];let s=!0;for(const i of J(e)){const e=0===i.kind?ze(t,i.fieldPath,t.endAt):Qe(t,i.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new oe(n,s)}(r,i),l=this.en(i,r,a),d=this.en(i,r,h),f=this.nn(i,r,c),m=this.sn(i.indexId,u,l,a.inclusive,d,h.inclusive,f);return ut.forEach(m,(i=>n.J(i,e.limit).next((e=>{e.forEach((e=>{const n=H.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return ut.resolve(null)}))}Ze(t){let e=this.Xe.get(t);return e||(e=0===t.filters.length?[t]:br(le.create(t.filters,"and")).map((e=>Be(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.Xe.set(t,e),e)}sn(t,e,n,s,i,r,o){const u=(null!=e?e.length:1)*Math.max(n.length,i.length),c=u/(null!=e?e.length:1),a=[];for(let h=0;h<u;++h){const u=e?this.rn(e[h/c]):gi,l=this.on(t,u,n[h%c],s),d=this.un(t,u,i[h%c],r),f=o.map((e=>this.on(t,u,e,!0)));a.push(...this.createRange(l,d,f))}return a}on(t,e,n,s){const i=new ti(t,H.empty(),e,n);return s?i:i.Ue()}un(t,e,n,s){const i=new ti(t,H.empty(),e,n);return s?i.Ue():i}tn(t,e){const n=new ri(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.je(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;const s=this.Ze(e);return ut.forEach(s,(e=>this.tn(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Re(W.comparator),n=!1;for(const s of t.filters)for(const t of s.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&s.length>1&&2===n?1:n))}cn(t,e){const n=new Zs;for(const s of J(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const i=n.qe(s.kind);zs.Ie.ue(t,i)}return n.Fe()}rn(t){const e=new Zs;return zs.Ie.ue(t,e.qe(0)),e.Fe()}an(t,e){const n=new Zs;return zs.Ie.ue(Wt(this.databaseId,e),n.qe(function(t){const e=J(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Fe()}nn(t,e,n){if(null===n)return[];let s=[];s.push(new Zs);let i=0;for(const r of J(t)){const t=n[i++];for(const n of s)if(this.hn(e,r.fieldPath)&&Yt(t))s=this.ln(s,r,t);else{const e=n.qe(r.kind);zs.Ie.ue(t,e)}}return this.fn(s)}en(t,e,n){return this.nn(t,e,n.position)}fn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Fe();return e}ln(t,e,n){const s=[...t],i=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new Zs;s.seed(n.Fe()),zs.Ie.ue(t,s.qe(e.kind)),i.push(s)}return i}hn(t,e){return!!t.filters.find((t=>t instanceof he&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=vi(t),s=bi(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return ut.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new Z(e.sequenceNumber,new nt(tr(e.readTime),new H(ns(e.documentKey)),e.largestBatchId)):Z.empty(),s=t.fields.map((([t,e])=>new dt(W.fromServerFormat(t),e)));return new Y(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:B(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=vi(t),i=bi(t);return this.dn(t).next((t=>s.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>ut.forEach(e,(e=>i.put(js(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return ut.forEach(e,((e,s)=>{const i=n.get(e.collectionGroup);return(i?ut.resolve(i):this.getFieldIndexes(t,e.collectionGroup)).next((i=>(n.set(e.collectionGroup,i),ut.forEach(i,(n=>this._n(t,e,n).next((e=>{const i=this.wn(s,n);return e.isEqual(i)?ut.resolve():this.mn(t,s,n,e,i)})))))))}))}gn(t,e,n,s){return wi(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.an(n,e.key),documentKey:e.key.path.toArray()})}yn(t,e,n,s){return wi(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.an(n,e.key),e.key.path.toArray()])}_n(t,e,n){const s=wi(t);let i=new Re(ei);return s.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.an(n,e)])},((t,s)=>{i=i.add(new ti(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>i))}wn(t,e){let n=new Re(ei);const s=this.cn(e,t);if(null==s)return n;const i=X(e);if(null!=i){const r=t.data.field(i.fieldPath);if(Yt(r))for(const i of r.arrayValue.values||[])n=n.add(new ti(e.indexId,t.key,this.rn(i),s))}else n=n.add(new ti(e.indexId,t.key,gi,s));return n}mn(t,e,n,s,i){v("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const r=[];return function(t,e,n,s,i){const r=t.getIterator(),o=e.getIterator();let u=Fe(r),c=Fe(o);for(;u||c;){let t=!1,e=!1;if(u&&c){const s=n(u,c);s<0?e=!0:s>0&&(t=!0)}else null!=u?e=!0:t=!0;t?(s(c),c=Fe(o)):e?(i(u),u=Fe(r)):(u=Fe(r),c=Fe(o))}}(s,i,ei,(s=>{r.push(this.gn(t,e,n,s))}),(s=>{r.push(this.yn(t,e,n,s))})),ut.waitFor(r)}dn(t){let e=1;return bi(t).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>ei(t,e))).filter(((t,e,n)=>!e||0!==ei(t,n[e-1])));const s=[];s.push(t);for(const i of n){const n=ei(i,t),r=ei(i,e);if(0===n)s[0]=t.Ue();else if(n>0&&r<0)s.push(i),s.push(i.Ue());else if(r>0)break}s.push(e);const i=[];for(let t=0;t<s.length;t+=2){if(this.pn(s[t],s[t+1]))return[];const e=[s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,gi,[]],n=[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,gi,[]];i.push(IDBKeyRange.bound(e,n))}return i}pn(t,e){return ei(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Ii)}getMinOffset(t,e){return ut.mapArray(this.Ze(e),(e=>this.tn(t,e).next((t=>t||_())))).next(Ii)}}function yi(t){return Ds(t,"collectionParents")}function wi(t){return Ds(t,"indexEntries")}function vi(t){return Ds(t,"indexConfiguration")}function bi(t){return Ds(t,"indexState")}function Ii(t){S(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let s=1;s<t.length;s++){const i=t[s].indexState.offset;st(i,e)<0&&(e=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new nt(e.readTime,e.documentKey,n)}const Ti={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ei{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Ei(t,Ei.DEFAULT_COLLECTION_PERCENTILE,Ei.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function _i(t,e,n){const s=t.store("mutations"),i=t.store("documentMutations"),r=[],o=IDBKeyRange.only(n.batchId);let u=0;const c=s.Z({range:o},((t,e,n)=>(u++,n.delete())));r.push(c.next((()=>{S(1===u)})));const a=[];for(const t of n.mutations){const s=is(e,t.key.path,n.batchId);r.push(i.delete(s)),a.push(t.key)}return ut.waitFor(r).next((()=>a))}function Si(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw _();e=t.noDocument}return JSON.stringify(e).length}Ei.DEFAULT_COLLECTION_PERCENTILE=10,Ei.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ei.DEFAULT=new Ei(41943040,Ei.DEFAULT_COLLECTION_PERCENTILE,Ei.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ei.DISABLED=new Ei(-1,0,0);class xi{constructor(t,e,n,s){this.userId=t,this.yt=e,this.indexManager=n,this.referenceDelegate=s,this.In={}}static re(t,e,n,s){S(""!==t.uid);const i=t.isAuthenticated()?t.uid:"";return new xi(i,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ci(t).Z({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const i=Ai(t),r=Ci(t);return r.add({}).next((o=>{S("number"==typeof o);const u=new Cs(o,e,n,s),c=function(t,e,n){const s=n.baseMutations.map((e=>Ur(t.ie,e))),i=n.mutations.map((e=>Ur(t.ie,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:i}}(this.yt,this.userId,u),a=[];let h=new Re(((t,e)=>B(t.canonicalString(),e.canonicalString())));for(const t of s){const e=is(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),a.push(r.put(c)),a.push(i.put(e,os))}return h.forEach((e=>{a.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.In[o]=u.keys()})),ut.waitFor(a).next((()=>u))}))}lookupMutationBatch(t,e){return Ci(t).get(e).next((t=>t?(S(t.userId===this.userId),Ls(this.yt,t)):null))}Tn(t,e){return this.In[e]?ut.resolve(this.In[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.In[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let i=null;return Ci(t).Z({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(S(e.batchId>=n),i=Ls(this.yt,e)),s.done()})).next((()=>i))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Ci(t).Z({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ci(t).W("userMutationsIndex",e).next((t=>t.map((t=>Ls(this.yt,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ss(this.userId,e.path),s=IDBKeyRange.lowerBound(n),i=[];return Ai(t).Z({range:s},((n,s,r)=>{const[o,u,c]=n,a=ns(u);if(o===this.userId&&e.path.isEqual(a))return Ci(t).get(c).next((t=>{if(!t)throw _();S(t.userId===this.userId),i.push(Ls(this.yt,t))}));r.done()})).next((()=>i))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Re(B);const s=[];return e.forEach((e=>{const i=ss(this.userId,e.path),r=IDBKeyRange.lowerBound(i),o=Ai(t).Z({range:r},((t,s,i)=>{const[r,o,u]=t,c=ns(o);r===this.userId&&e.path.isEqual(c)?n=n.add(u):i.done()}));s.push(o)})),ut.waitFor(s).next((()=>this.En(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,i=ss(this.userId,n),r=IDBKeyRange.lowerBound(i);let o=new Re(B);return Ai(t).Z({range:r},((t,e,i)=>{const[r,u,c]=t,a=ns(u);r===this.userId&&n.isPrefixOf(a)?a.length===s&&(o=o.add(c)):i.done()})).next((()=>this.En(t,o)))}En(t,e){const n=[],s=[];return e.forEach((e=>{s.push(Ci(t).get(e).next((t=>{if(null===t)throw _();S(t.userId===this.userId),n.push(Ls(this.yt,t))})))})),ut.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return _i(t.se,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.An(e.batchId)})),ut.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}An(t){delete this.In[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return ut.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return Ai(t).Z({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=ns(t[1]);s.push(e)}else n.done()})).next((()=>{S(0===s.length)}))}))}containsKey(t,e){return Di(t,this.userId,e)}Rn(t){return ki(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Di(t,e,n){const s=ss(e,n.path),i=s[1],r=IDBKeyRange.lowerBound(s);let o=!1;return Ai(t).Z({range:r,X:!0},((t,n,s)=>{const[r,u,c]=t;r===e&&u===i&&(o=!0),s.done()})).next((()=>o))}function Ci(t){return Ds(t,"mutations")}function Ai(t){return Ds(t,"documentMutations")}function ki(t){return Ds(t,"mutationQueues")}class Ni{constructor(t){this.bn=t}next(){return this.bn+=2,this.bn}static Pn(){return new Ni(0)}static vn(){return new Ni(-1)}}class Oi{constructor(t,e){this.referenceDelegate=t,this.yt=e}allocateTargetId(t){return this.Vn(t).next((e=>{const n=new Ni(e.highestTargetId);return e.highestTargetId=n.next(),this.Sn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Vn(t).next((t=>$.fromTimestamp(new G(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Vn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Vn(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.Sn(t,s))))}addTargetData(t,e){return this.Dn(t,e).next((()=>this.Vn(t).next((n=>(n.targetCount+=1,this.Cn(e,n),this.Sn(t,n))))))}updateTargetData(t,e){return this.Dn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>Ri(t).delete(e.targetId))).next((()=>this.Vn(t))).next((e=>(S(e.targetCount>0),e.targetCount-=1,this.Sn(t,e))))}removeTargets(t,e,n){let s=0;const i=[];return Ri(t).Z(((r,o)=>{const u=Vs(o);u.sequenceNumber<=e&&null===n.get(u.targetId)&&(s++,i.push(this.removeTargetData(t,u)))})).next((()=>ut.waitFor(i))).next((()=>s))}forEachTarget(t,e){return Ri(t).Z(((t,n)=>{const s=Vs(n);e(s)}))}Vn(t){return Mi(t).get("targetGlobalKey").next((t=>(S(null!==t),t)))}Sn(t,e){return Mi(t).put("targetGlobalKey",e)}Dn(t,e){return Ri(t).put(Ps(this.yt,e))}Cn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Vn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=je(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let i=null;return Ri(t).Z({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const r=Vs(n);Ke(e,r.target)&&(i=r,s.done())})).next((()=>i))}addMatchingKeys(t,e,n){const s=[],i=Fi(t);return e.forEach((e=>{const r=Zr(e.path);s.push(i.put({targetId:n,path:r})),s.push(this.referenceDelegate.addReference(t,n,e))})),ut.waitFor(s)}removeMatchingKeys(t,e,n){const s=Fi(t);return ut.forEach(e,(e=>{const i=Zr(e.path);return ut.waitFor([s.delete([n,i]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=Fi(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=Fi(t);let i=ur();return s.Z({range:n,X:!0},((t,e,n)=>{const s=ns(t[1]),r=new H(s);i=i.add(r)})).next((()=>i))}containsKey(t,e){const n=Zr(e.path),s=IDBKeyRange.bound([n],[K(n)],!1,!0);let i=0;return Fi(t).Z({index:"documentTargetsIndex",X:!0,range:s},(([t,e],n,s)=>{0!==t&&(i++,s.done())})).next((()=>i>0))}ne(t,e){return Ri(t).get(e).next((t=>t?Vs(t):null))}}function Ri(t){return Ds(t,"targets")}function Mi(t){return Ds(t,"targetGlobal")}function Fi(t){return Ds(t,"targetDocuments")}function Li([t,e],[n,s]){const i=B(t,n);return 0===i?B(e,s):i}class Vi{constructor(t){this.xn=t,this.buffer=new Re(Li),this.Nn=0}kn(){return++this.Nn}On(t){const e=[t,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Li(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Pi{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(t){v("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){mt(t)?v("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await at(t)}await this.Fn(3e5)}))}}class qi{constructor(t,e){this.$n=t,this.params=e}calculateTargetCount(t,e){return this.$n.Bn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return ut.resolve(It.at);const n=new Vi(e);return this.$n.forEachTarget(t,(t=>n.On(t.sequenceNumber))).next((()=>this.$n.Ln(t,(t=>n.On(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.$n.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.$n.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector","Garbage collection skipped; disabled"),ut.resolve(Ti)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ti):this.qn(t,e)))}getCacheSize(t){return this.$n.getCacheSize(t)}qn(t,e){let n,s,i,r,o,h,a;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(v("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,r=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(i=e,h=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(a=Date.now(),y()<=c.a.DEBUG&&v("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${r-l}ms\n\tDetermined least recently used ${s} in `+(o-r)+"ms\n"+`\tRemoved ${i} targets in `+(h-o)+"ms\n"+`\tRemoved ${t} documents in `+(a-h)+"ms\n"+`Total Duration: ${a-l}ms`),ut.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:t}))))}}class Ui{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new qi(t,e)}(this,e)}Bn(t){const e=this.Un(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Un(t){let e=0;return this.Ln(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Ln(t,e){return this.Kn(t,((t,n)=>e(n)))}addReference(t,e,n){return Bi(t,n)}removeReference(t,e,n){return Bi(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Bi(t,e)}Gn(t,e){return function(t,e){let n=!1;return ki(t).tt((s=>Di(t,s,e).next((t=>(t&&(n=!0),ut.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let i=0;return this.Kn(t,((r,o)=>{if(o<=e){const e=this.Gn(t,r).next((e=>{if(!e)return i++,n.getEntry(t,r).next((()=>(n.removeEntry(r,$.min()),Fi(t).delete([0,Zr(r.path)]))))}));s.push(e)}})).next((()=>ut.waitFor(s))).next((()=>n.apply(t))).next((()=>i))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Bi(t,e)}Kn(t,e){const n=Fi(t);let s,i=It.at;return n.Z({index:"documentTargetsIndex"},(([t,n],{path:r,sequenceNumber:o})=>{0===t?(i!==It.at&&e(new H(ns(s)),i),i=o,s=r):i=It.at})).next((()=>{i!==It.at&&e(new H(ns(s)),i)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Bi(t,e){return Fi(t).put(function(t,e){return{targetId:0,path:Zr(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class ji{constructor(){this.changes=new Yn((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,qe.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?ut.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Ki{constructor(t){this.yt=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return zi(t).put(n)}removeEntry(t,e,n){return zi(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Ms(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Qn(t,n))))}getEntry(t,e){let n=qe.newInvalidDocument(e);return zi(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Wi(e))},((t,s)=>{n=this.jn(e,s)})).next((()=>n))}Wn(t,e){let n={size:0,document:qe.newInvalidDocument(e)};return zi(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Wi(e))},((t,s)=>{n={document:this.jn(e,s),size:Si(s)}})).next((()=>n))}getEntries(t,e){let n=Jn();return this.zn(t,e,((t,e)=>{const s=this.jn(t,e);n=n.insert(t,s)})).next((()=>n))}Hn(t,e){let n=Jn(),s=new ke(H.comparator);return this.zn(t,e,((t,e)=>{const i=this.jn(t,e);n=n.insert(t,i),s=s.insert(t,Si(e))})).next((()=>({documents:n,Jn:s})))}zn(t,e,n){if(e.isEmpty())return ut.resolve();let s=new Re(Yi);e.forEach((t=>s=s.add(t)));const i=IDBKeyRange.bound(Wi(s.first()),Wi(s.last())),r=s.getIterator();let o=r.getNext();return zi(t).Z({index:"documentKeyIndex",range:i},((t,e,s)=>{const i=H.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Yi(o,i)<0;)n(o,null),o=r.getNext();o&&o.isEqual(i)&&(n(o,e),o=r.hasNext()?r.getNext():null),o?s.j(Wi(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=r.hasNext()?r.getNext():null}))}getAllFromCollection(t,e,n){const s=[e.popLast().toArray(),e.lastSegment(),Ms(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],i=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return zi(t).W(IDBKeyRange.bound(s,i,!0)).next((t=>{let e=Jn();for(const n of t){const t=this.jn(H.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,s){let i=Jn();const r=Hi(e,n),o=Hi(e,nt.max());return zi(t).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,o,!0)},((t,e,n)=>{const r=this.jn(H.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);i=i.insert(r.key,r),i.size===s&&n.done()})).next((()=>i))}newChangeBuffer(t){return new $i(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Qi(t).get("remoteDocumentGlobalKey").next((t=>(S(!!t),t)))}Qn(t,e){return Qi(t).put("remoteDocumentGlobalKey",e)}jn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=qr(t.ie,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=H.fromSegments(e.noDocument.path),s=tr(e.noDocument.readTime);n=qe.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return _();{const t=H.fromSegments(e.unknownDocument.path),s=tr(e.unknownDocument.version);n=qe.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new G(t[0],t[1]);return $.fromTimestamp(e)}(e.readTime)),n}(this.yt,e);if(!t.isNoDocument()||!t.version.isEqual($.min()))return t}return qe.newInvalidDocument(t)}}function Gi(t){return new Ki(t)}class $i extends ji{constructor(t,e){super(),this.Yn=t,this.trackRemovals=e,this.Xn=new Yn((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new Re(((t,e)=>B(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((i,r)=>{const o=this.Xn.get(i);if(e.push(this.Yn.removeEntry(t,i,o.readTime)),r.isValidDocument()){const u=Rs(this.Yn.yt,r);s=s.add(i.path.popLast());const c=Si(u);n+=c-o.size,e.push(this.Yn.addEntry(t,i,u))}else if(n-=o.size,this.trackRemovals){const n=Rs(this.Yn.yt,r.convertToNoDocument($.min()));e.push(this.Yn.addEntry(t,i,n))}})),s.forEach((n=>{e.push(this.Yn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Yn.updateMetadata(t,n)),ut.waitFor(e)}getFromCache(t,e){return this.Yn.Wn(t,e).next((t=>(this.Xn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Yn.Hn(t,e).next((({documents:t,Jn:e})=>(e.forEach(((e,n)=>{this.Xn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Qi(t){return Ds(t,"remoteDocumentGlobal")}function zi(t){return Ds(t,"remoteDocumentsV14")}function Wi(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Hi(t,e){const n=e.documentKey.path.toArray();return[t,Ms(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Yi(t,e){const n=t.path.toArray(),s=e.path.toArray();let i=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(i=B(n[t],s[t]),i)return i;return i=B(n.length,s.length),i||(i=B(n[n.length-2],s[s.length-2]),i||B(n[n.length-1],s[s.length-1]))}class Xi{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Ji{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((s=>(n=s,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Fn(n.mutation,t,Le.empty(),G.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,ur()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=ur()){const s=rr();return this.populateOverlays(t,s,e).next((()=>this.computeViews(t,e,s,n).next((t=>{let e=er();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=rr();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,ur())))}populateOverlays(t,e,n){const s=[];return n.forEach((t=>{e.has(t)||s.push(t)})),this.documentOverlayCache.getOverlays(t,s).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,s){let i=Jn();const r=ir(),o=ir();return e.forEach(((t,e)=>{const o=n.get(e.key);s.has(e.key)&&(void 0===o||o.mutation instanceof qn)?i=i.insert(e.key,e):void 0!==o&&(r.set(e.key,o.mutation.getFieldMask()),Fn(o.mutation,e,o.mutation.getFieldMask(),G.now()))})),this.recalculateAndSaveOverlays(t,i).next((t=>(t.forEach(((t,e)=>r.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Xi(e,null!==(n=r.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=ir();let s=new ke(((t,e)=>t-e)),i=ur();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const i of t)i.keys().forEach((t=>{const r=e.get(t);if(null===r)return;let o=n.get(t)||Le.empty();o=i.applyToLocalView(r,o),n.set(t,o);const u=(s.get(i.batchId)||ur()).add(t);s=s.insert(i.batchId,u)}))})).next((()=>{const r=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),u=s.key,c=s.value,a=sr();c.forEach((t=>{if(!i.has(t)){const s=Rn(e.get(t),n.get(t));null!==s&&a.set(t,s),i=i.add(t)}})),r.push(this.documentOverlayCache.saveOverlays(t,u,a))}return ut.waitFor(r)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return H.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):tn(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next((i=>{const r=s-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-i.size):ut.resolve(rr());let o=-1,u=i;return r.next((e=>ut.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(e)?ut.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{u=u.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,i))).next((()=>this.computeViews(t,u,e,ur()))).next((t=>({batchId:o,changes:nr(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new H(e)).next((t=>{let e=er();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const s=e.collectionGroup;let i=er();return this.indexManager.getCollectionParents(t,s).next((r=>ut.forEach(r,(r=>{const o=function(t,e){return new We(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,r.child(s));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{i=i.insert(t,e)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(t,e,n){let s;return this.remoteDocumentCache.getAllFromCollection(t,e.path,n).next((i=>(s=i,this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId)))).next((t=>{t.forEach(((t,e)=>{const n=e.getKey();null===s.get(n)&&(s=s.insert(n,qe.newInvalidDocument(n)))}));let n=er();return s.forEach(((s,i)=>{const r=t.get(s);void 0!==r&&Fn(r.mutation,i,Le.empty(),G.now()),cn(e,i)&&(n=n.insert(s,i))})),n}))}}class Zi{constructor(t){this.yt=t,this.Zn=new Map,this.ts=new Map}getBundleMetadata(t,e){return ut.resolve(this.Zn.get(e))}saveBundleMetadata(t,e){var n;return this.Zn.set(e.id,{id:(n=e).id,version:n.version,createTime:Ar(n.createTime)}),ut.resolve()}getNamedQuery(t,e){return ut.resolve(this.ts.get(e))}saveNamedQuery(t,e){return this.ts.set(e.name,function(t){return{name:t.name,query:qs(t.bundledQuery),readTime:Ar(t.readTime)}}(e)),ut.resolve()}}class to{constructor(){this.overlays=new ke(H.comparator),this.es=new Map}getOverlay(t,e){return ut.resolve(this.overlays.get(e))}getOverlays(t,e){const n=rr();return ut.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.oe(t,e,s)})),ut.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.es.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.es.delete(n)),ut.resolve()}getOverlaysForCollection(t,e,n){const s=rr(),i=e.length+1,r=new H(e.child("")),o=this.overlays.getIteratorFrom(r);for(;o.hasNext();){const t=o.getNext().value,r=t.getKey();if(!e.isPrefixOf(r.path))break;r.path.length===i&&t.largestBatchId>n&&s.set(t.getKey(),t)}return ut.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let i=new ke(((t,e)=>t-e));const r=this.overlays.getIterator();for(;r.hasNext();){const t=r.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=rr(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=rr(),u=i.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return ut.resolve(o)}oe(t,e,n){const s=this.overlays.get(n.key);if(null!==s){const t=this.es.get(s.largestBatchId).delete(n.key);this.es.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new ks(e,n));let i=this.es.get(e);void 0===i&&(i=ur(),this.es.set(e,i)),this.es.set(e,i.add(n.key))}}class eo{constructor(){this.ns=new Re(no.ss),this.rs=new Re(no.os)}isEmpty(){return this.ns.isEmpty()}addReference(t,e){const n=new no(t,e);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.cs(new no(t,e))}hs(t,e){t.forEach((t=>this.removeReference(t,e)))}ls(t){const e=new H(new rt([])),n=new no(e,t),s=new no(e,t+1),i=[];return this.rs.forEachInRange([n,s],(t=>{this.cs(t),i.push(t.key)})),i}fs(){this.ns.forEach((t=>this.cs(t)))}cs(t){this.ns=this.ns.delete(t),this.rs=this.rs.delete(t)}ds(t){const e=new H(new rt([])),n=new no(e,t),s=new no(e,t+1);let i=ur();return this.rs.forEachInRange([n,s],(t=>{i=i.add(t.key)})),i}containsKey(t){const e=new no(t,0),n=this.ns.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class no{constructor(t,e){this.key=t,this._s=e}static ss(t,e){return H.comparator(t.key,e.key)||B(t._s,e._s)}static os(t,e){return B(t._s,e._s)||H.comparator(t.key,e.key)}}class ro{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.ws=1,this.gs=new Re(no.ss)}checkEmpty(t){return ut.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,s){const i=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const r=new Cs(i,e,n,s);this.mutationQueue.push(r);for(const e of s)this.gs=this.gs.add(new no(e.key,i)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return ut.resolve(r)}lookupMutationBatch(t,e){return ut.resolve(this.ys(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.ps(n),i=s<0?0:s;return ut.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return ut.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(t){return ut.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new no(e,0),s=new no(e,Number.POSITIVE_INFINITY),i=[];return this.gs.forEachInRange([n,s],(t=>{const e=this.ys(t._s);i.push(e)})),ut.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Re(B);return e.forEach((t=>{const e=new no(t,0),s=new no(t,Number.POSITIVE_INFINITY);this.gs.forEachInRange([e,s],(t=>{n=n.add(t._s)}))})),ut.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let i=n;H.isDocumentKey(i)||(i=i.child(""));const r=new no(new H(i),0);let o=new Re(B);return this.gs.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t._s)),!0)}),r),ut.resolve(this.Is(o))}Is(t){const e=[];return t.forEach((t=>{const n=this.ys(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){S(0===this.Ts(e.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return ut.forEach(e.mutations,(s=>{const i=new no(s.key,e.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.gs=n}))}An(t){}containsKey(t,e){const n=new no(e,0),s=this.gs.firstAfterOrEqual(n);return ut.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,ut.resolve()}Ts(t,e){return this.ps(t)}ps(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}ys(t){const e=this.ps(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class so{constructor(t){this.Es=t,this.docs=new ke(H.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),i=s?s.size:0,r=this.Es(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:r}),this.size+=r-i,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return ut.resolve(n?n.document.mutableCopy():qe.newInvalidDocument(e))}getEntries(t,e){let n=Jn();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():qe.newInvalidDocument(t))})),ut.resolve(n)}getAllFromCollection(t,e,n){let s=Jn();const i=new H(e.child("")),r=this.docs.getIteratorFrom(i);for(;r.hasNext();){const{key:t,value:{document:i}}=r.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||st(et(i),n)<=0||(s=s.insert(i.key,i.mutableCopy()))}return ut.resolve(s)}getAllFromCollectionGroup(t,e,n,s){_()}As(t,e){return ut.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new io(this)}getSize(t){return ut.resolve(this.size)}}class io extends ji{constructor(t){super(),this.Yn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.Yn.addEntry(t,s)):this.Yn.removeEntry(n)})),ut.waitFor(e)}getFromCache(t,e){return this.Yn.getEntry(t,e)}getAllFromCache(t,e){return this.Yn.getEntries(t,e)}}class oo{constructor(t){this.persistence=t,this.Rs=new Yn((t=>je(t)),Ke),this.lastRemoteSnapshotVersion=$.min(),this.highestTargetId=0,this.bs=0,this.Ps=new eo,this.targetCount=0,this.vs=Ni.Pn()}forEachTarget(t,e){return this.Rs.forEach(((t,n)=>e(n))),ut.resolve()}getLastRemoteSnapshotVersion(t){return ut.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return ut.resolve(this.bs)}allocateTargetId(t){return this.highestTargetId=this.vs.next(),ut.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.bs&&(this.bs=e),ut.resolve()}Dn(t){this.Rs.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.vs=new Ni(e),this.highestTargetId=e),t.sequenceNumber>this.bs&&(this.bs=t.sequenceNumber)}addTargetData(t,e){return this.Dn(e),this.targetCount+=1,ut.resolve()}updateTargetData(t,e){return this.Dn(e),ut.resolve()}removeTargetData(t,e){return this.Rs.delete(e.target),this.Ps.ls(e.targetId),this.targetCount-=1,ut.resolve()}removeTargets(t,e,n){let s=0;const i=[];return this.Rs.forEach(((r,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Rs.delete(r),i.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),ut.waitFor(i).next((()=>s))}getTargetCount(t){return ut.resolve(this.targetCount)}getTargetData(t,e){const n=this.Rs.get(e)||null;return ut.resolve(n)}addMatchingKeys(t,e,n){return this.Ps.us(e,n),ut.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const s=this.persistence.referenceDelegate,i=[];return s&&e.forEach((e=>{i.push(s.markPotentiallyOrphaned(t,e))})),ut.waitFor(i)}removeMatchingKeysForTargetId(t,e){return this.Ps.ls(e),ut.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Ps.ds(e);return ut.resolve(n)}containsKey(t,e){return ut.resolve(this.Ps.containsKey(e))}}class ao{constructor(t,e){this.Vs={},this.overlays={},this.Ss=new It(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=t(this),this.Cs=new oo(this),this.indexManager=new fi,this.remoteDocumentCache=function(t){return new so(t)}((t=>this.referenceDelegate.xs(t))),this.yt=new Os(e),this.Ns=new Zi(this.yt)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new to,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Vs[t.toKey()];return n||(n=new ro(e,this.referenceDelegate),this.Vs[t.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(t,e,n){v("MemoryPersistence","Starting transaction:",t);const s=new uo(this.Ss.next());return this.referenceDelegate.ks(),n(s).next((t=>this.referenceDelegate.Os(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Ms(t,e){return ut.or(Object.values(this.Vs).map((n=>()=>n.containsKey(t,e))))}}class uo extends ot{constructor(t){super(),this.currentSequenceNumber=t}}class co{constructor(t){this.persistence=t,this.Fs=new eo,this.$s=null}static Bs(t){return new co(t)}get Ls(){if(this.$s)return this.$s;throw _()}addReference(t,e,n){return this.Fs.addReference(n,e),this.Ls.delete(n.toString()),ut.resolve()}removeReference(t,e,n){return this.Fs.removeReference(n,e),this.Ls.add(n.toString()),ut.resolve()}markPotentiallyOrphaned(t,e){return this.Ls.add(e.toString()),ut.resolve()}removeTarget(t,e){this.Fs.ls(e.targetId).forEach((t=>this.Ls.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Ls.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}ks(){this.$s=new Set}Os(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ut.forEach(this.Ls,(n=>{const s=H.fromPath(n);return this.qs(t,s).next((t=>{t||e.removeEntry(s,$.min())}))})).next((()=>(this.$s=null,e.apply(t))))}updateLimboDocument(t,e){return this.qs(t,e).next((t=>{t?this.Ls.delete(e.toString()):this.Ls.add(e.toString())}))}xs(t){return 0}qs(t,e){return ut.or([()=>ut.resolve(this.Fs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ms(t,e)])}}class ho{constructor(t){this.yt=t}$(t,e,n,s){const i=new ct("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",rs,{unique:!0}),t.createObjectStore("documentMutations")}(t),lo(t),function(t){t.createObjectStore("remoteDocuments")}(t));let r=ut.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),lo(t)),r=r.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:$.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(i)))),n<4&&s>=4&&(0!==n&&(r=r.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",rs,{unique:!0});const s=e.store("mutations"),i=n.map((t=>s.put(t)));return ut.waitFor(i)}))}(t,i)))),r=r.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(r=r.next((()=>this.Us(i)))),n<6&&s>=6&&(r=r.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Ks(i))))),n<7&&s>=7&&(r=r.next((()=>this.Gs(i)))),n<8&&s>=8&&(r=r.next((()=>this.Qs(t,i)))),n<9&&s>=9&&(r=r.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(r=r.next((()=>this.js(i)))),n<11&&s>=11&&(r=r.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(r=r.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:ws});e.createIndex("collectionPathOverlayIndex",vs,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",bs,{unique:!1})}(t)}))),n<13&&s>=13&&(r=r.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:as});e.createIndex("documentKeyIndex",us),e.createIndex("collectionGroupIndex",cs)}(t))).next((()=>this.Ws(t,i))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(r=r.next((()=>this.zs(t,i)))),n<15&&s>=15&&(r=r.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:ms}).createIndex("sequenceNumberIndex",gs,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:ps}).createIndex("documentKeyIndex",ys,{unique:!1})}(t)))),r}Ks(t){let e=0;return t.store("remoteDocuments").Z(((t,n)=>{e+=Si(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Us(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>ut.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",s).next((n=>ut.forEach(n,(n=>{S(n.userId===e.userId);const s=Ls(this.yt,n);return _i(t,e.userId,s).next((()=>{}))}))))}))))}Gs(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.Z(((n,i)=>{const r=new rt(n),o=function(t){return[0,Zr(t)]}(r);s.push(e.get(o).next((n=>n?ut.resolve():(n=>e.put({targetId:0,path:Zr(n),sequenceNumber:t.highestListenSequenceNumber}))(r))))})).next((()=>ut.waitFor(s)))}))}Qs(t,e){t.createObjectStore("collectionParents",{keyPath:fs});const n=e.store("collectionParents"),s=new mi,i=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:Zr(s)})}};return e.store("remoteDocuments").Z({X:!0},((t,e)=>{const n=new rt(t);return i(n.popLast())})).next((()=>e.store("documentMutations").Z({X:!0},(([t,e,n],s)=>{const r=ns(e);return i(r.popLast())}))))}js(t){const e=t.store("targets");return e.Z(((t,n)=>{const s=Vs(n),i=Ps(this.yt,s);return e.put(i)}))}Ws(t,e){const n=e.store("remoteDocuments"),s=[];return n.Z(((t,n)=>{const i=e.store("remoteDocumentsV14"),r=(o=n,o.document?new H(rt.fromString(o.document.name).popFirst(5)):o.noDocument?H.fromSegments(o.noDocument.path):o.unknownDocument?H.fromSegments(o.unknownDocument.path):_()).path.toArray();var o;const u={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(i.put(u))})).next((()=>ut.waitFor(s)))}zs(t,e){const n=e.store("mutations"),s=Gi(this.yt),i=new ao(co.Bs,this.yt.ie);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let s=null!==(e=n.get(t.userId))&&void 0!==e?e:ur();Ls(this.yt,t).keys().forEach((t=>s=s.add(t))),n.set(t.userId,s)})),ut.forEach(n,((t,n)=>{const r=new d(n),o=$s.re(this.yt,r),u=i.getIndexManager(r),c=xi.re(r,this.yt,u,i.referenceDelegate);return new Ji(s,c,o,u).recalculateAndSaveOverlaysForDocumentKeys(new xs(e,It.at),t).next()}))}))}}function lo(t){t.createObjectStore("targetDocuments",{keyPath:ls}).createIndex("documentTargetsIndex",ds,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",hs,{unique:!0}),t.createObjectStore("targetGlobal")}const fo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class mo{constructor(t,e,n,s,i,r,o,u,c,a,h=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Hs=i,this.window=r,this.document=o,this.Js=c,this.Ys=a,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=t=>Promise.resolve(),!mo.C())throw new A(C.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ui(this,s),this.ii=e+"main",this.yt=new Os(u),this.ri=new ht(this.ii,this.Xs,new ho(this.yt)),this.Cs=new Oi(this.referenceDelegate,this.yt),this.remoteDocumentCache=Gi(this.yt),this.Ns=new Ks,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===a&&I("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new A(C.FAILED_PRECONDITION,fo);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Cs.getHighestSequenceNumber(t)))})).then((t=>{this.Ss=new It(t,this.Js)})).then((()=>{this.Ds=!0})).catch((t=>(this.ri&&this.ri.close(),Promise.reject(t))))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Hs.enqueueAndForget((async()=>{this.started&&await this.ui()})))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>po(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.fi(t).next((t=>{t||(this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))))}))})).next((()=>this.di(t))).next((e=>this.isPrimary&&!e?this._i(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(mt(t))return v("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return v("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Hs.enqueueRetryable((()=>this.si(t))),this.isPrimary=t}))}fi(t){return go(t).get("owner").next((t=>ut.resolve(this.mi(t))))}gi(t){return po(t).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Ds(t,"clientMetadata");return e.W().next((t=>{const n=this.Ii(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return ut.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.oi)for(const e of t)this.oi.removeItem(this.Ti(e.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ui().then((()=>this.yi())).then((()=>this.hi()))))}mi(t){return!!t&&t.ownerId===this.clientId}di(t){return this.Ys?ut.resolve(!0):go(t).get("owner").next((e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(!e.allowTabSynchronization)throw new A(C.FAILED_PRECONDITION,fo);return!1}}return!(!this.networkEnabled||!this.inForeground)||po(t).W().next((t=>void 0===this.Ii(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&v("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new xs(t,It.at);return this._i(e).next((()=>this.gi(e)))})),this.ri.close(),this.Pi()}Ii(t,e){return t.filter((t=>this.pi(t.updateTimeMs,e)&&!this.Ei(t.clientId)))}vi(){return this.runTransaction("getActiveClients","readonly",(t=>po(t).W().next((t=>this.Ii(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ds}getMutationQueue(t,e){return xi.re(t,this.yt,e,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new pi(t,this.yt.ie.databaseId)}getDocumentOverlayCache(t){return $s.re(this.yt,t)}getBundleCache(){return this.Ns}runTransaction(t,e,n){v("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",i=15===(r=this.Xs)?Ss:14===r?_s:13===r?Es:12===r?Ts:11===r?Is:void _();var r;let o;return this.ri.runTransaction(t,s,i,(s=>(o=new xs(s,this.Ss?this.Ss.next():It.at),"readwrite-primary"===e?this.fi(o).next((t=>!!t||this.di(o))).next((e=>{if(!e)throw I(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))),new A(C.FAILED_PRECONDITION,it);return n(o)})).next((t=>this.wi(o).next((()=>t)))):this.Vi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}Vi(t){return go(t).get("owner").next((t=>{if(null!==t&&this.pi(t.leaseTimestampMs,5e3)&&!this.Ei(t.ownerId)&&!this.mi(t)&&!(this.Ys||this.allowTabSynchronization&&t.allowTabSynchronization))throw new A(C.FAILED_PRECONDITION,fo)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return go(t).put("owner",e)}static C(){return ht.C()}_i(t){const e=go(t);return e.get("owner").next((t=>this.mi(t)?(v("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):ut.resolve()))}pi(t,e){const n=Date.now();return!(t<n-e||t>n&&(I(`Detected an update time that is in the future: ${t} > ${n}`),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ui())))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Zs=()=>{this.Ai(),Object(h.p)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(t){var e;try{const n=null!==(null===(e=this.oi)||void 0===e?void 0:e.getItem(this.Ti(t)));return v("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return I("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(t){I("Failed to set zombie client id.",t)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(t){}}Ti(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function go(t){return Ds(t,"owner")}function po(t){return Ds(t,"clientMetadata")}function yo(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class wo{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Si=n,this.Di=s}static Ci(t,e){let n=ur(),s=ur();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new wo(t,e.fromCache,n,s)}}class vo{constructor(){this.xi=!1}initialize(t,e){this.Ni=t,this.indexManager=e,this.xi=!0}getDocumentsMatchingQuery(t,e,n,s){return this.ki(t,e).next((i=>i||this.Oi(t,e,s,n))).next((n=>n||this.Mi(t,e)))}ki(t,e){if(Xe(e))return ut.resolve(null);let n=nn(e);return this.indexManager.getIndexType(t,n).next((s=>0===s?null:(null!==e.limit&&1===s&&(e=sn(e,null,"F"),n=nn(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((s=>{const i=ur(...s);return this.Ni.getDocuments(t,i).next((s=>this.indexManager.getMinOffset(t,n).next((n=>{const r=this.Fi(e,s);return this.$i(e,r,i,n.readTime)?this.ki(t,sn(e,null,"F")):this.Bi(t,r,e,n)}))))})))))}Oi(t,e,n,s){return Xe(e)||s.isEqual($.min())?this.Mi(t,e):this.Ni.getDocuments(t,n).next((i=>{const r=this.Fi(e,i);return this.$i(e,r,n,s)?this.Mi(t,e):(y()<=c.a.DEBUG&&v("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),un(e)),this.Bi(t,r,e,tt(s,-1)))}))}Fi(t,e){let n=new Re(ln(t));return e.forEach(((e,s)=>{cn(t,s)&&(n=n.add(s))})),n}$i(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const i="F"===t.limitType?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(s)>0)}Mi(t,e){return y()<=c.a.DEBUG&&v("QueryEngine","Using full collection scan to execute query:",un(e)),this.Ni.getDocumentsMatchingQuery(t,e,nt.min())}Bi(t,e,n,s){return this.Ni.getDocumentsMatchingQuery(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class bo{constructor(t,e,n,s){this.persistence=t,this.Li=e,this.yt=s,this.qi=new ke(B),this.Ui=new Yn((t=>je(t)),Ke),this.Ki=new Map,this.Gi=t.getRemoteDocumentCache(),this.Cs=t.getTargetCache(),this.Ns=t.getBundleCache(),this.Qi(n)}Qi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Ji(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.qi)))}}function Io(t,e,n,s){return new bo(t,e,n,s)}async function To(t,e){const n=D(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.mutationQueue.getAllMutationBatches(t).next((i=>(s=i,n.Qi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const i=[],r=[];let o=ur();for(const t of s){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({ji:t,removedBatchIds:i,addedBatchIds:r})))}))}))}function Eo(t){const e=D(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Cs.getLastRemoteSnapshotVersion(t)))}function _o(t,e,n){let s=ur(),i=ur();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=Jn();return n.forEach(((n,r)=>{const o=t.get(n);r.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),r.isNoDocument()&&r.version.isEqual($.min())?(e.removeEntry(n,r.readTime),s=s.insert(n,r)):!o.isValidDocument()||r.version.compareTo(o.version)>0||0===r.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(r),s=s.insert(n,r)):v("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",r.version)})),{Wi:s,zi:i}}))}function So(t,e){const n=D(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function xo(t,e){const n=D(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Cs.getTargetData(t,e).next((i=>i?(s=i,ut.resolve(s)):n.Cs.allocateTargetId(t).next((i=>(s=new Ns(e,i,0,t.currentSequenceNumber),n.Cs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.qi.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.qi=n.qi.insert(t.targetId,t),n.Ui.set(e,t.targetId)),t}))}async function Do(t,e,n){const s=D(t),i=s.qi.get(e),r=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",r,(t=>s.persistence.referenceDelegate.removeTarget(t,i)))}catch(t){if(!mt(t))throw t;v("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.qi=s.qi.remove(e),s.Ui.delete(i.target)}function Co(t,e,n){const s=D(t);let i=$.min(),r=ur();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=D(t),i=s.Ui.get(n);return void 0!==i?ut.resolve(s.qi.get(i)):s.Cs.getTargetData(e,n)}(s,t,nn(e)).next((e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{r=t}))})).next((()=>s.Li.getDocumentsMatchingQuery(t,e,n?i:$.min(),n?r:ur()))).next((t=>(No(s,hn(e),t),{documents:t,Hi:r})))))}function Ao(t,e){const n=D(t),s=D(n.Cs),i=n.qi.get(e);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.ne(t,e).next((t=>t?t.target:null))))}function ko(t,e){const n=D(t),s=n.Ki.get(e)||$.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Gi.getAllFromCollectionGroup(t,e,tt(s,-1),Number.MAX_SAFE_INTEGER))).then((t=>(No(n,e,t),t)))}function No(t,e,n){let s=t.Ki.get(e)||$.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.Ki.set(e,s)}async function Oo(t,e,n=ur()){const s=await xo(t,nn(qs(e.bundledQuery))),i=D(t);return i.persistence.runTransaction("Save named query","readwrite",(t=>{const r=Ar(e.readTime);if(s.snapshotVersion.compareTo(r)>=0)return i.Ns.saveNamedQuery(t,e);const o=s.withResumeToken(Nt.EMPTY_BYTE_STRING,r);return i.qi=i.qi.insert(o.targetId,o),i.Cs.updateTargetData(t,o).next((()=>i.Cs.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>i.Cs.addMatchingKeys(t,n,s.targetId))).next((()=>i.Ns.saveNamedQuery(t,e)))}))}function Ro(t,e){return`firestore_clients_${t}_${e}`}function Mo(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function Fo(t,e){return`firestore_targets_${t}_${e}`}class Lo{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Zi(t,e,n){const s=JSON.parse(n);let i,r="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return r&&s.error&&(r="string"==typeof s.error.message&&"string"==typeof s.error.code,r&&(i=new A(s.error.code,s.error.message))),r?new Lo(t,e,s.state,i):(I("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Vo{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Zi(t,e){const n=JSON.parse(e);let s,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(s=new A(n.error.code,n.error.message))),i?new Vo(t,n.state,s):(I("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Po{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Zi(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,i=lr();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=At(n.activeTargetIds[t]),i=i.add(n.activeTargetIds[t]);return s?new Po(t,i):(I("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class qo{constructor(t,e){this.clientId=t,this.onlineState=e}static Zi(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new qo(e.clientId,e.onlineState):(I("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Uo{constructor(){this.activeTargetIds=lr()}er(t){this.activeTargetIds=this.activeTargetIds.add(t)}nr(t){this.activeTargetIds=this.activeTargetIds.delete(t)}tr(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Bo{constructor(t,e,n,s,i){this.window=t,this.Hs=e,this.persistenceKey=n,this.sr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new ke(B),this.started=!1,this.cr=[];const r=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ar=Ro(this.persistenceKey,this.sr),this.hr=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ur=this.ur.insert(this.sr,new Uo),this.lr=new RegExp(`^firestore_clients_${r}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${r}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${r}_(\\d+)$`),this.wr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.mr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.ir)}static C(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.vi();for(const e of t){if(e===this.sr)continue;const t=this.getItem(Ro(this.persistenceKey,e));if(t){const n=Po.Zi(e,t);n&&(this.ur=this.ur.insert(n.clientId,n))}}this.gr();const e=this.storage.getItem(this.wr);if(e){const t=this.yr(e);t&&this.pr(t)}for(const t of this.cr)this.rr(t);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.hr,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(t){let e=!1;return this.ur.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Tr(t,"pending")}updateMutationState(t,e,n){this.Tr(t,e,n),this.Er(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(Fo(this.persistenceKey,t));if(n){const s=Vo.Zi(t,n);s&&(e=s.state)}}return this.Ar.er(t),this.gr(),e}removeLocalQueryTarget(t){this.Ar.nr(t),this.gr()}isLocalQueryTarget(t){return this.Ar.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Fo(this.persistenceKey,t))}updateQueryState(t,e,n){this.Rr(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Er(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.br(t)}notifyBundleLoaded(t){this.Pr(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return v("SharedClientState","READ",t,e),e}setItem(t,e){v("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){v("SharedClientState","REMOVE",t),this.storage.removeItem(t)}rr(t){const e=t;if(e.storageArea===this.storage){if(v("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ar)return void I("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Hs.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.lr.test(e.key)){if(null==e.newValue){const t=this.vr(e.key);return this.Vr(t,null)}{const t=this.Sr(e.key,e.newValue);if(t)return this.Vr(t.clientId,t)}}else if(this.dr.test(e.key)){if(null!==e.newValue){const t=this.Dr(e.key,e.newValue);if(t)return this.Cr(t)}}else if(this._r.test(e.key)){if(null!==e.newValue){const t=this.Nr(e.key,e.newValue);if(t)return this.kr(t)}}else if(e.key===this.wr){if(null!==e.newValue){const t=this.yr(e.newValue);if(t)return this.pr(t)}}else if(e.key===this.hr){const t=function(t){let e=It.at;if(null!=t)try{const n=JSON.parse(t);S("number"==typeof n),e=n}catch(t){I("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==It.at&&this.sequenceNumberHandler(t)}else if(e.key===this.mr){const t=this.Or(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Mr(t))))}}else this.cr.push(e)}))}}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(t,e,n){const s=new Lo(this.currentUser,t,e,n),i=Mo(this.persistenceKey,this.currentUser,t);this.setItem(i,s.tr())}Er(t){const e=Mo(this.persistenceKey,this.currentUser,t);this.removeItem(e)}br(t){const e={clientId:this.sr,onlineState:t};this.storage.setItem(this.wr,JSON.stringify(e))}Rr(t,e,n){const s=Fo(this.persistenceKey,t),i=new Vo(t,e,n);this.setItem(s,i.tr())}Pr(t){const e=JSON.stringify(Array.from(t));this.setItem(this.mr,e)}vr(t){const e=this.lr.exec(t);return e?e[1]:null}Sr(t,e){const n=this.vr(t);return Po.Zi(n,e)}Dr(t,e){const n=this.dr.exec(t),s=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Lo.Zi(new d(i),s,e)}Nr(t,e){const n=this._r.exec(t),s=Number(n[1]);return Vo.Zi(s,e)}yr(t){return qo.Zi(t)}Or(t){return JSON.parse(t)}async Cr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Fr(t.batchId,t.state,t.error);v("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}kr(t){return this.syncEngine.$r(t.targetId,t.state,t.error)}Vr(t,e){const n=e?this.ur.insert(t,e):this.ur.remove(t),s=this.Ir(this.ur),i=this.Ir(n),r=[],o=[];return i.forEach((t=>{s.has(t)||r.push(t)})),s.forEach((t=>{i.has(t)||o.push(t)})),this.syncEngine.Br(r,o).then((()=>{this.ur=n}))}pr(t){this.ur.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ir(t){let e=lr();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class jo{constructor(){this.Lr=new Uo,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Lr.er(t),this.qr[t]||"not-current"}updateQueryState(t,e,n){this.qr[t]=e}removeLocalQueryTarget(t){this.Lr.nr(t)}isLocalQueryTarget(t){return this.Lr.activeTargetIds.has(t)}clearQueryState(t){delete this.qr[t]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(t){return this.Lr.activeTargetIds.has(t)}start(){return this.Lr=new Uo,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Ko{Ur(t){}shutdown(){}}class Go{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}Ur(t){this.Wr.push(t)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){v("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Wr)t(0)}jr(){v("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Wr)t(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const $o={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Qo{constructor(t){this.Hr=t.Hr,this.Jr=t.Jr}Yr(t){this.Xr=t}Zr(t){this.eo=t}onMessage(t){this.no=t}close(){this.Jr()}send(t){this.Hr(t)}so(){this.Xr()}io(t){this.eo(t)}ro(t){this.no(t)}}class zo extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.oo=e+"://"+t.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(t,e,n,s,i){const r=this.ho(t,e);v("RestConnection","Sending: ",r,n);const o={};return this.lo(o,s,i),this.fo(t,r,o,n).then((t=>(v("RestConnection","Received: ",t),t)),(e=>{throw T("RestConnection",`${t} failed with error: `,e,"url: ",r,"request:",n),e}))}_o(t,e,n,s,i,r){return this.ao(t,e,n,s,i)}lo(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+f,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}ho(t,e){const n=$o[t];return`${this.oo}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}fo(t,e,n,s){return new Promise(((i,r)=>{const o=new l.g;o.setWithCredentials(!0),o.listenOnce(l.c.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case l.a.NO_ERROR:const e=o.getResponseJson();v("Connection","XHR received:",JSON.stringify(e)),i(e);break;case l.a.TIMEOUT:v("Connection",'RPC "'+t+'" timed out'),r(new A(C.DEADLINE_EXCEEDED,"Request time out"));break;case l.a.HTTP_ERROR:const n=o.getStatus();if(v("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){let t=o.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(C).indexOf(e)>=0?e:C.UNKNOWN}(e.status);r(new A(t,e.message))}else r(new A(C.UNKNOWN,"Server responded with status "+o.getStatus()))}else r(new A(C.UNAVAILABLE,"Connection failed."));break;default:_()}}finally{v("Connection",'RPC "'+t+'" completed.')}}));const u=JSON.stringify(s);o.send(e,"POST",u,n,15)}))}wo(t,e,n){const s=[this.oo,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=Object(l.h)(),r=Object(l.i)(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new l.d({})),this.lo(o.initMessageHeaders,e,n),o.encodeInitMessageHeaders=!0;const u=s.join("");v("Connection","Creating WebChannel: "+u,o);const c=i.createWebChannel(u,o);let a=!1,h=!1;const d=new Qo({Hr:t=>{h?v("Connection","Not sending because WebChannel is closed:",t):(a||(v("Connection","Opening WebChannel transport."),c.open(),a=!0),v("Connection","WebChannel sending:",t),c.send(t))},Jr:()=>c.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(c,l.f.EventType.OPEN,(()=>{h||v("Connection","WebChannel transport opened.")})),f(c,l.f.EventType.CLOSE,(()=>{h||(h=!0,v("Connection","WebChannel transport closed"),d.io())})),f(c,l.f.EventType.ERROR,(t=>{h||(h=!0,T("Connection","WebChannel transport errored:",t),d.io(new A(C.UNAVAILABLE,"The operation could not be completed")))})),f(c,l.f.EventType.MESSAGE,(t=>{var e;if(!h){const n=t.data[0];S(!!n);const s=n,i=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(i){v("Connection","WebChannel received error:",i);const t=i.status;let e=function(t){const e=Qn[t];if(void 0!==e)return Hn(e)}(t),n=i.message;void 0===e&&(e=C.INTERNAL,n="Unknown error status: "+t+" with message "+i.message),h=!0,d.io(new A(e,n)),c.close()}else v("Connection","WebChannel received:",n),d.ro(n)}})),f(r,l.b.STAT_EVENT,(t=>{t.stat===l.e.PROXY?v("Connection","Detected buffering proxy"):t.stat===l.e.NOPROXY&&v("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.so()}),0),d}}function Wo(){return"undefined"!=typeof window?window:null}function Ho(){return"undefined"!=typeof document?document:null}function Yo(t){return new Sr(t,!0)}class Xo{constructor(t,e,n=1e3,s=1.5,i=6e4){this.Hs=t,this.timerId=e,this.mo=n,this.yo=s,this.po=i,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(t){this.cancel();const e=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),s=Math.max(0,e-n);s>0&&v("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.Io} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,s,(()=>(this.Eo=Date.now(),t()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class Jo{constructor(t,e,n,s,i,r,o,u){this.Hs=t,this.vo=n,this.Vo=s,this.connection=i,this.authCredentialsProvider=r,this.appCheckCredentialsProvider=o,this.listener=u,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new Xo(t,e)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,(()=>this.$o())))}Bo(t){this.Lo(),this.stream.send(t)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}qo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(t,e){this.Lo(),this.qo(),this.xo.cancel(),this.So++,4!==t?this.xo.reset():e&&e.code===C.RESOURCE_EXHAUSTED?(I(e.toString()),I("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):e&&e.code===C.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Uo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Zr(e)}Uo(){}auth(){this.state=1;const t=this.Ko(this.So),e=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.So===e&&this.Go(t,n)}),(e=>{t((()=>{const t=new A(C.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Qo(t)}))}))}Go(t,e){const n=this.Ko(this.So);this.stream=this.jo(t,e),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((t=>{n((()=>this.Qo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Oo(){this.state=5,this.xo.Ro((async()=>{this.state=0,this.start()}))}Qo(t){return v("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Ko(t){return e=>{this.Hs.enqueueAndForget((()=>this.So===t?e():(v("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Zo extends Jo{constructor(t,e,n,s,i,r){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,r),this.yt=i}jo(t,e){return this.connection.wo("Listen",t,e)}onMessage(t){this.xo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:_()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],r=function(t,e){return t.wt?(S(void 0===e||"string"==typeof e),Nt.fromBase64String(e||"")):(S(void 0===e||e instanceof Uint8Array),Nt.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,u=o&&function(t){const e=void 0===t.code?C.UNKNOWN:Hn(t.code);return new A(e,t.message||"")}(o);n=new pr(s,i,r,u||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const i=Rr(t,s.document.name),r=Ar(s.document.updateTime),o=s.document.createTime?Ar(s.document.createTime):$.min(),u=new Ve({mapValue:{fields:s.document.fields}}),c=qe.newFoundDocument(i,r,o,u),a=s.targetIds||[],h=s.removedTargetIds||[];n=new mr(a,h,c.key,c)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const i=Rr(t,s.document),r=s.readTime?Ar(s.readTime):$.min(),o=qe.newNoDocument(i,r),u=s.removedTargetIds||[];n=new mr([],u,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const i=Rr(t,s.document),r=s.removedTargetIds||[];n=new mr([],r,i,null)}else{if(!("filter"in e))return _();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,i=new $n(s),r=t.targetId;n=new gr(r,i)}}return n}(this.yt,t),n=function(t){if(!("targetChange"in t))return $.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?$.min():e.readTime?Ar(e.readTime):$.min()}(t);return this.listener.Wo(e,n)}zo(t){const e={};e.database=Lr(this.yt),e.addTarget=function(t,e){let n;const s=e.target;return n=Ge(s)?{documents:jr(t,s)}:{query:Kr(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Dr(t,e.resumeToken):e.snapshotVersion.compareTo($.min())>0&&(n.readTime=xr(t,e.snapshotVersion.toTimestamp())),n}(this.yt,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return _()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.yt,t);n&&(e.labels=n),this.Bo(e)}Ho(t){const e={};e.database=Lr(this.yt),e.removeTarget=t,this.Bo(e)}}class ta extends Jo{constructor(t,e,n,s,i,r){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,r),this.yt=i,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}Uo(){this.Jo&&this.Xo([])}jo(t,e){return this.connection.wo("Write",t,e)}onMessage(t){if(S(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Jo){this.xo.reset();const e=function(t,e){return t&&t.length>0?(S(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Ar(t.updateTime):Ar(e);return n.isEqual($.min())&&(n=Ar(e)),new An(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Ar(t.commitTime);return this.listener.Zo(n,e)}return S(!t.writeResults||0===t.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const t={};t.database=Lr(this.yt),this.Bo(t)}Xo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Ur(this.yt,t)))};this.Bo(e)}}class ea extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.yt=s,this.nu=!1}su(){if(this.nu)throw new A(C.FAILED_PRECONDITION,"The client has already been terminated.")}ao(t,e,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.ao(t,e,n,s,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new A(C.UNKNOWN,t.toString())}))}_o(t,e,n,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,r])=>this.connection._o(t,e,n,i,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new A(C.UNKNOWN,t.toString())}))}terminate(){this.nu=!0}}class na{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(t){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.cu("Offline")))}set(t){this.lu(),this.iu=0,"Online"===t&&(this.ou=!1),this.cu(t)}cu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}au(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(I(e),this.ou=!1):v("OnlineStateTracker",e)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class ra{constructor(t,e,n,s,i){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=i,this.mu.Ur((t=>{n.enqueueAndForget((async()=>{da(this)&&(v("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=D(t);e._u.add(4),await ia(e),e.gu.set("Unknown"),e._u.delete(4),await sa(e)}(this))}))})),this.gu=new na(n,s)}}async function sa(t){if(da(t))for(const e of t.wu)await e(!0)}async function ia(t){for(const e of t.wu)await e(!1)}function oa(t,e){const n=D(t);n.du.has(e.targetId)||(n.du.set(e.targetId,e),la(n)?ha(n):ka(n).ko()&&ua(n,e))}function aa(t,e){const n=D(t),s=ka(n);n.du.delete(e),s.ko()&&ca(n,e),0===n.du.size&&(s.ko()?s.Fo():da(n)&&n.gu.set("Unknown"))}function ua(t,e){t.yu.Ot(e.targetId),ka(t).zo(e)}function ca(t,e){t.yu.Ot(e),ka(t).Ho(e)}function ha(t){t.yu=new wr({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ne:e=>t.du.get(e)||null}),ka(t).start(),t.gu.uu()}function la(t){return da(t)&&!ka(t).No()&&t.du.size>0}function da(t){return 0===D(t)._u.size}function fa(t){t.yu=void 0}async function ma(t){t.du.forEach(((e,n)=>{ua(t,e)}))}async function ga(t,e){fa(t),la(t)?(t.gu.hu(e),ha(t)):t.gu.set("Unknown")}async function pa(t,e,n){if(t.gu.set("Online"),e instanceof pr&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.du.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.du.delete(s),t.yu.removeTarget(s))}(t,e)}catch(n){v("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await ya(t,n)}else if(e instanceof mr?t.yu.Kt(e):e instanceof gr?t.yu.Jt(e):t.yu.jt(e),!n.isEqual($.min()))try{const e=await Eo(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.yu.Zt(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const i=t.du.get(s);i&&t.du.set(s,i.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.du.get(e);if(!n)return;t.du.set(e,n.withResumeToken(Nt.EMPTY_BYTE_STRING,n.snapshotVersion)),ca(t,e);const s=new Ns(n.target,e,1,n.sequenceNumber);ua(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){v("RemoteStore","Failed to raise snapshot:",e),await ya(t,e)}}async function ya(t,e,n){if(!mt(e))throw e;t._u.add(1),await ia(t),t.gu.set("Offline"),n||(n=()=>Eo(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{v("RemoteStore","Retrying IndexedDB access"),await n(),t._u.delete(1),await sa(t)}))}function wa(t,e){return e().catch((n=>ya(t,n,e)))}async function va(t){const e=D(t),n=Na(e);let s=e.fu.length>0?e.fu[e.fu.length-1].batchId:-1;for(;ba(e);)try{const t=await So(e.localStore,s);if(null===t){0===e.fu.length&&n.Fo();break}s=t.batchId,Ia(e,t)}catch(t){await ya(e,t)}Ta(e)&&Ea(e)}function ba(t){return da(t)&&t.fu.length<10}function Ia(t,e){t.fu.push(e);const n=Na(t);n.ko()&&n.Yo&&n.Xo(e.mutations)}function Ta(t){return da(t)&&!Na(t).No()&&t.fu.length>0}function Ea(t){Na(t).start()}async function _a(t){Na(t).eu()}async function Sa(t){const e=Na(t);for(const n of t.fu)e.Xo(n.mutations)}async function xa(t,e,n){const s=t.fu.shift(),i=As.from(s,e,n);await wa(t,(()=>t.remoteSyncer.applySuccessfulWrite(i))),await va(t)}async function Da(t,e){e&&Na(t).Yo&&await async function(t,e){if(Wn(n=e.code)&&n!==C.ABORTED){const n=t.fu.shift();Na(t).Mo(),await wa(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await va(t)}var n}(t,e),Ta(t)&&Ea(t)}async function Ca(t,e){const n=D(t);n.asyncQueue.verifyOperationInProgress(),v("RemoteStore","RemoteStore received new credentials");const s=da(n);n._u.add(3),await ia(n),s&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n._u.delete(3),await sa(n)}async function Aa(t,e){const n=D(t);e?(n._u.delete(2),await sa(n)):e||(n._u.add(2),await ia(n),n.gu.set("Unknown"))}function ka(t){return t.pu||(t.pu=function(t,e,n){const s=D(t);return s.su(),new Zo(e,s.connection,s.authCredentials,s.appCheckCredentials,s.yt,n)}(t.datastore,t.asyncQueue,{Yr:ma.bind(null,t),Zr:ga.bind(null,t),Wo:pa.bind(null,t)}),t.wu.push((async e=>{e?(t.pu.Mo(),la(t)?ha(t):t.gu.set("Unknown")):(await t.pu.stop(),fa(t))}))),t.pu}function Na(t){return t.Iu||(t.Iu=function(t,e,n){const s=D(t);return s.su(),new ta(e,s.connection,s.authCredentials,s.appCheckCredentials,s.yt,n)}(t.datastore,t.asyncQueue,{Yr:_a.bind(null,t),Zr:Da.bind(null,t),tu:Sa.bind(null,t),Zo:xa.bind(null,t)}),t.wu.push((async e=>{e?(t.Iu.Mo(),await va(t)):(await t.Iu.stop(),t.fu.length>0&&(v("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))}))),t.Iu}class Oa{constructor(t,e,n,s,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=i,this.deferred=new q,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,i){const r=Date.now()+n,o=new Oa(t,e,r,s,i);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new A(C.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ra(t,e){if(I("AsyncQueue",`${e}: ${t}`),mt(t))return new A(C.UNAVAILABLE,`${e}: ${t}`);throw t}class Ma{constructor(t){this.comparator=t?(e,n)=>t(e,n)||H.comparator(e.key,n.key):(t,e)=>H.comparator(t.key,e.key),this.keyedMap=er(),this.sortedSet=new ke(this.comparator)}static emptySet(t){return new Ma(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Ma))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new Ma;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Fa{constructor(){this.Tu=new ke(H.comparator)}track(t){const e=t.doc.key,n=this.Tu.get(e);n?0!==t.type&&3===n.type?this.Tu=this.Tu.insert(e,t):3===t.type&&1!==n.type?this.Tu=this.Tu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Tu=this.Tu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Tu=this.Tu.remove(e):1===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):_():this.Tu=this.Tu.insert(e,t)}Eu(){const t=[];return this.Tu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class La{constructor(t,e,n,s,i,r,o,u,c){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=i,this.fromCache=r,this.syncStateChanged=o,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(t,e,n,s,i){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new La(t,e,Ma.emptySet(e),r,n,s,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&on(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class Va{constructor(){this.Au=void 0,this.listeners=[]}}class Pa{constructor(){this.queries=new Yn((t=>an(t)),on),this.onlineState="Unknown",this.Ru=new Set}}async function qa(t,e){const n=D(t),s=e.query;let i=!1,r=n.queries.get(s);if(r||(i=!0,r=new Va),i)try{r.Au=await n.onListen(s)}catch(t){const n=Ra(t,`Initialization of query '${un(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,r),r.listeners.push(e),e.bu(n.onlineState),r.Au&&e.Pu(r.Au)&&Ka(n)}async function Ua(t,e){const n=D(t),s=e.query;let i=!1;const r=n.queries.get(s);if(r){const t=r.listeners.indexOf(e);t>=0&&(r.listeners.splice(t,1),i=0===r.listeners.length)}if(i)return n.queries.delete(s),n.onUnlisten(s)}function Ba(t,e){const n=D(t);let s=!1;for(const t of e){const e=t.query,i=n.queries.get(e);if(i){for(const e of i.listeners)e.Pu(t)&&(s=!0);i.Au=t}}s&&Ka(n)}function ja(t,e,n){const s=D(t),i=s.queries.get(e);if(i)for(const t of i.listeners)t.onError(n);s.queries.delete(e)}function Ka(t){t.Ru.forEach((t=>{t.next()}))}class Ga{constructor(t,e,n){this.query=t,this.vu=e,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new La(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.Vu?this.Du(t)&&(this.vu.next(t),e=!0):this.Cu(t,this.onlineState)&&(this.xu(t),e=!0),this.Su=t,e}onError(t){this.vu.error(t)}bu(t){this.onlineState=t;let e=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,t)&&(this.xu(this.Su),e=!0),e}Cu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.Nu||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}Du(t){if(t.docChanges.length>0)return!0;const e=this.Su&&this.Su.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}xu(t){t=La.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.Vu=!0,this.vu.next(t)}}class $a{constructor(t,e){this.ku=t,this.byteLength=e}Ou(){return"metadata"in this.ku}}class Qa{constructor(t){this.yt=t}Ji(t){return Rr(this.yt,t)}Yi(t){return t.metadata.exists?qr(this.yt,t.document,!1):qe.newNoDocument(this.Ji(t.metadata.name),this.Xi(t.metadata.readTime))}Xi(t){return Ar(t)}}class za{constructor(t,e,n){this.Mu=t,this.localStore=e,this.yt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Wa(t)}Fu(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.ku.namedQuery)this.queries.push(t.ku.namedQuery);else if(t.ku.documentMetadata){this.documents.push({metadata:t.ku.documentMetadata}),t.ku.documentMetadata.exists||++e;const n=rt.fromString(t.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.ku.document&&(this.documents[this.documents.length-1].document=t.ku.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}$u(t){const e=new Map,n=new Qa(this.yt);for(const s of t)if(s.metadata.queries){const t=n.Ji(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||ur()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const i=D(t);let r=ur(),o=Jn();for(const t of n){const n=e.Ji(t.metadata.name);t.document&&(r=r.add(n));const s=e.Yi(t);s.setReadTime(e.Xi(t.metadata.readTime)),o=o.insert(n,s)}const u=i.Gi.newChangeBuffer({trackRemovals:!0}),c=await xo(i,function(t){return nn(Ye(rt.fromString(`__bundle__/docs/${t}`)))}(s));return i.persistence.runTransaction("Apply bundle documents","readwrite",(t=>_o(t,u,o).next((e=>(u.apply(t),e))).next((e=>i.Cs.removeMatchingKeysForTargetId(t,c.targetId).next((()=>i.Cs.addMatchingKeys(t,r,c.targetId))).next((()=>i.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi))).next((()=>e.Wi))))))}(this.localStore,new Qa(this.yt),this.documents,this.Mu.id),e=this.$u(this.documents);for(const t of this.queries)await Oo(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:t}}}function Wa(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Ha{constructor(t){this.key=t}}class Ya{constructor(t){this.key=t}}class Xa{constructor(t,e){this.query=t,this.qu=e,this.Uu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=ur(),this.mutatedKeys=ur(),this.Gu=ln(t),this.Qu=new Ma(this.Gu)}get ju(){return this.qu}Wu(t,e){const n=e?e.zu:new Fa,s=e?e.Qu:this.Qu;let i=e?e.mutatedKeys:this.mutatedKeys,r=s,o=!1;const u="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,c="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const a=s.get(t),h=cn(this.query,e)?e:null,l=!!a&&this.mutatedKeys.has(a.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;a&&h?a.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Hu(a,h)||(n.track({type:2,doc:h}),f=!0,(u&&this.Gu(h,u)>0||c&&this.Gu(h,c)<0)&&(o=!0)):!a&&h?(n.track({type:0,doc:h}),f=!0):a&&!h&&(n.track({type:1,doc:a}),f=!0,(u||c)&&(o=!0)),f&&(h?(r=r.add(h),i=d?i.add(t):i.delete(t)):(r=r.delete(t),i=i.delete(t)))})),null!==this.query.limit)for(;r.size>this.query.limit;){const t="F"===this.query.limitType?r.last():r.first();r=r.delete(t.key),i=i.delete(t.key),n.track({type:1,doc:t})}return{Qu:r,zu:n,$i:o,mutatedKeys:i}}Hu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Qu;this.Qu=t.Qu,this.mutatedKeys=t.mutatedKeys;const i=t.zu.Eu();i.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return _()}};return n(t)-n(e)}(t.type,e.type)||this.Gu(t.doc,e.doc))),this.Ju(n);const r=e?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,u=o!==this.Uu;return this.Uu=o,0!==i.length||u?{snapshot:new La(this.query,t.Qu,s,i,t.mutatedKeys,0===o,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),Xu:r}:{Xu:r}}bu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new Fa,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(t){return!this.qu.has(t)&&!!this.Qu.has(t)&&!this.Qu.get(t).hasLocalMutations}Ju(t){t&&(t.addedDocuments.forEach((t=>this.qu=this.qu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.qu=this.qu.delete(t))),this.current=t.current)}Yu(){if(!this.current)return[];const t=this.Ku;this.Ku=ur(),this.Qu.forEach((t=>{this.Zu(t.key)&&(this.Ku=this.Ku.add(t.key))}));const e=[];return t.forEach((t=>{this.Ku.has(t)||e.push(new Ya(t))})),this.Ku.forEach((n=>{t.has(n)||e.push(new Ha(n))})),e}tc(t){this.qu=t.Hi,this.Ku=ur();const e=this.Wu(t.documents);return this.applyChanges(e,!0)}ec(){return La.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.Uu,this.hasCachedResults)}}class Ja{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Za{constructor(t){this.key=t,this.nc=!1}}class tu{constructor(t,e,n,s,i,r){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=i,this.maxConcurrentLimboResolutions=r,this.sc={},this.ic=new Yn((t=>an(t)),on),this.rc=new Map,this.oc=new Set,this.uc=new ke(H.comparator),this.cc=new Map,this.ac=new eo,this.hc={},this.lc=new Map,this.fc=Ni.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function eu(t,e){const n=Du(t);let s,i;const r=n.ic.get(e);if(r)s=r.targetId,n.sharedClientState.addLocalQueryTarget(s),i=r.view.ec();else{const t=await xo(n.localStore,nn(e));n.isPrimaryClient&&oa(n.remoteStore,t);const r=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,i=await nu(n,e,s,"current"===r,t.resumeToken)}return i}async function nu(t,e,n,s,i){t._c=(e,n,s)=>async function(t,e,n,s){let i=e.view.Wu(n);i.$i&&(i=await Co(t.localStore,e.query,!1).then((({documents:t})=>e.view.Wu(t,i))));const r=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(i,t.isPrimaryClient,r);return fu(t,e.targetId,o.Xu),o.snapshot}(t,e,n,s);const r=await Co(t.localStore,e,!0),o=new Xa(e,r.Hi),u=o.Wu(r.documents),c=fr.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState,i),a=o.applyChanges(u,t.isPrimaryClient,c);fu(t,n,a.Xu);const h=new Ja(e,n,o);return t.ic.set(e,h),t.rc.has(n)?t.rc.get(n).push(e):t.rc.set(n,[e]),a.snapshot}async function ru(t,e){const n=D(t),s=n.ic.get(e),i=n.rc.get(s.targetId);if(i.length>1)return n.rc.set(s.targetId,i.filter((t=>!on(t,e)))),void n.ic.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await Do(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),aa(n.remoteStore,s.targetId),lu(n,s.targetId)})).catch(at)):(lu(n,s.targetId),await Do(n.localStore,s.targetId,!0))}async function su(t,e){const n=D(t);try{const t=await function(t,e){const n=D(t),s=e.snapshotVersion;let i=n.qi;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const r=n.Gi.newChangeBuffer({trackRemovals:!0});i=n.qi;const o=[];e.targetChanges.forEach(((r,u)=>{const c=i.get(u);if(!c)return;o.push(n.Cs.removeMatchingKeys(t,r.removedDocuments,u).next((()=>n.Cs.addMatchingKeys(t,r.addedDocuments,u))));let a=c.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(u)?a=a.withResumeToken(Nt.EMPTY_BYTE_STRING,$.min()).withLastLimboFreeSnapshotVersion($.min()):r.resumeToken.approximateByteSize()>0&&(a=a.withResumeToken(r.resumeToken,s)),i=i.insert(u,a),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,a,r)&&o.push(n.Cs.updateTargetData(t,a))}));let u=Jn(),c=ur();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(_o(t,r,e.documentUpdates).next((t=>{u=t.Wi,c=t.zi}))),!s.isEqual($.min())){const e=n.Cs.getLastRemoteSnapshotVersion(t).next((e=>n.Cs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return ut.waitFor(o).next((()=>r.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,u,c))).next((()=>u))})).then((t=>(n.qi=i,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.cc.get(e);s&&(S(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.nc=!0:t.modifiedDocuments.size>0?S(s.nc):t.removedDocuments.size>0&&(S(s.nc),s.nc=!1))})),await pu(n,t,e)}catch(t){await at(t)}}function iu(t,e,n){const s=D(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.ic.forEach(((n,s)=>{const i=s.view.bu(e);i.snapshot&&t.push(i.snapshot)})),function(t,e){const n=D(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.bu(e)&&(s=!0)})),s&&Ka(n)}(s.eventManager,e),t.length&&s.sc.Wo(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function ou(t,e,n){const s=D(t);s.sharedClientState.updateQueryState(e,"rejected",n);const i=s.cc.get(e),r=i&&i.key;if(r){let t=new ke(H.comparator);t=t.insert(r,qe.newNoDocument(r,$.min()));const n=ur().add(r),i=new dr($.min(),new Map,new Re(B),t,n);await su(s,i),s.uc=s.uc.remove(r),s.cc.delete(e),gu(s)}else await Do(s.localStore,e,!1).then((()=>lu(s,e,n))).catch(at)}async function au(t,e){const n=D(t),s=e.batch.batchId;try{const t=await function(t,e){const n=D(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),i=n.Gi.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const i=n.batch,r=i.keys();let o=ut.resolve();return r.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const r=n.docVersions.get(t);S(null!==r),e.version.compareTo(r)<0&&(i.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,i)))}(n,t,e,i).next((()=>i.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=ur();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(n.localStore,e);hu(n,s,null),cu(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await pu(n,t)}catch(t){await at(t)}}async function uu(t,e,n){const s=D(t);try{const t=await function(t,e){const n=D(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(S(null!==e),s=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,s))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(s.localStore,e);hu(s,e,n),cu(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await pu(s,t)}catch(n){await at(n)}}function cu(t,e){(t.lc.get(e)||[]).forEach((t=>{t.resolve()})),t.lc.delete(e)}function hu(t,e,n){const s=D(t);let i=s.hc[s.currentUser.toKey()];if(i){const t=i.get(e);t&&(n?t.reject(n):t.resolve(),i=i.remove(e)),s.hc[s.currentUser.toKey()]=i}}function lu(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.rc.get(e))t.ic.delete(s),n&&t.sc.wc(s,n);t.rc.delete(e),t.isPrimaryClient&&t.ac.ls(e).forEach((e=>{t.ac.containsKey(e)||du(t,e)}))}function du(t,e){t.oc.delete(e.path.canonicalString());const n=t.uc.get(e);null!==n&&(aa(t.remoteStore,n),t.uc=t.uc.remove(e),t.cc.delete(n),gu(t))}function fu(t,e,n){for(const s of n)s instanceof Ha?(t.ac.addReference(s.key,e),mu(t,s)):s instanceof Ya?(v("SyncEngine","Document no longer in limbo: "+s.key),t.ac.removeReference(s.key,e),t.ac.containsKey(s.key)||du(t,s.key)):_()}function mu(t,e){const n=e.key,s=n.path.canonicalString();t.uc.get(n)||t.oc.has(s)||(v("SyncEngine","New document in limbo: "+n),t.oc.add(s),gu(t))}function gu(t){for(;t.oc.size>0&&t.uc.size<t.maxConcurrentLimboResolutions;){const e=t.oc.values().next().value;t.oc.delete(e);const n=new H(rt.fromString(e)),s=t.fc.next();t.cc.set(s,new Za(n)),t.uc=t.uc.insert(n,s),oa(t.remoteStore,new Ns(nn(Ye(n.path)),s,2,It.at))}}async function pu(t,e,n){const s=D(t),i=[],r=[],o=[];s.ic.isEmpty()||(s.ic.forEach(((t,u)=>{o.push(s._c(u,e,n).then((t=>{if((t||n)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(u.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){i.push(t);const e=wo.Ci(u.targetId,t);r.push(e)}})))})),await Promise.all(o),s.sc.Wo(i),await async function(t,e){const n=D(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>ut.forEach(e,(e=>ut.forEach(e.Si,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>ut.forEach(e.Di,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!mt(t))throw t;v("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.qi.get(e),s=t.snapshotVersion,i=t.withLastLimboFreeSnapshotVersion(s);n.qi=n.qi.insert(e,i)}}}(s.localStore,r))}async function yu(t,e){const n=D(t);if(!n.currentUser.isEqual(e)){v("SyncEngine","User change. New user:",e.toKey());const t=await To(n.localStore,e);n.currentUser=e,function(t,e){t.lc.forEach((t=>{t.forEach((t=>{t.reject(new A(C.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.lc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await pu(n,t.ji)}}function wu(t,e){const n=D(t),s=n.cc.get(e);if(s&&s.nc)return ur().add(s.key);{let t=ur();const s=n.rc.get(e);if(!s)return t;for(const e of s){const s=n.ic.get(e);t=t.unionWith(s.view.ju)}return t}}async function vu(t,e){const n=D(t),s=await Co(n.localStore,e.query,!0),i=e.view.tc(s);return n.isPrimaryClient&&fu(n,e.targetId,i.Xu),i}async function bu(t,e){const n=D(t);return ko(n.localStore,e).then((t=>pu(n,t)))}async function Iu(t,e,n,s){const i=D(t),r=await function(t,e){const n=D(t),s=D(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.Tn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):ut.resolve(null)))))}(i.localStore,e);null!==r?("pending"===n?await va(i.remoteStore):"acknowledged"===n||"rejected"===n?(hu(i,e,s||null),cu(i,e),function(t,e){D(D(t).mutationQueue).An(e)}(i.localStore,e)):_(),await pu(i,r)):v("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Tu(t,e,n){const s=D(t),i=[],r=[];for(const t of e){let e;const n=s.rc.get(t);if(n&&0!==n.length){e=await xo(s.localStore,nn(n[0]));for(const t of n){const e=s.ic.get(t),n=await vu(s,e);n.snapshot&&r.push(n.snapshot)}}else{const n=await Ao(s.localStore,t);e=await xo(s.localStore,n),await nu(s,Eu(n),t,!1,e.resumeToken)}i.push(e)}return s.sc.Wo(r),i}function Eu(t){return He(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function _u(t){const e=D(t);return D(D(e.localStore).persistence).vi()}async function Su(t,e,n,s){const i=D(t);if(i.dc)return void v("SyncEngine","Ignoring unexpected query state notification.");const r=i.rc.get(e);if(r&&r.length>0)switch(n){case"current":case"not-current":{const t=await ko(i.localStore,hn(r[0])),s=dr.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,Nt.EMPTY_BYTE_STRING);await pu(i,t,s);break}case"rejected":await Do(i.localStore,e,!0),lu(i,e,s);break;default:_()}}async function xu(t,e,n){const s=Du(t);if(s.dc){for(const t of e){if(s.rc.has(t)){v("SyncEngine","Adding an already active target "+t);continue}const e=await Ao(s.localStore,t),n=await xo(s.localStore,e);await nu(s,Eu(e),n.targetId,!1,n.resumeToken),oa(s.remoteStore,n)}for(const t of n)s.rc.has(t)&&await Do(s.localStore,t,!1).then((()=>{aa(s.remoteStore,t),lu(s,t)})).catch(at)}}function Du(t){const e=D(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=su.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=wu.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=ou.bind(null,e),e.sc.Wo=Ba.bind(null,e.eventManager),e.sc.wc=ja.bind(null,e.eventManager),e}function Cu(t){const e=D(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=au.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=uu.bind(null,e),e}class Au{constructor(){this.synchronizeTabs=!1}async initialize(t){this.yt=Yo(t.databaseInfo.databaseId),this.sharedClientState=this.gc(t),this.persistence=this.yc(t),await this.persistence.start(),this.localStore=this.Ic(t),this.gcScheduler=this.Tc(t,this.localStore),this.indexBackfillerScheduler=this.Ec(t,this.localStore)}Tc(t,e){return null}Ec(t,e){return null}Ic(t){return Io(this.persistence,new vo,t.initialUser,this.yt)}yc(t){return new ao(co.Bs,this.yt)}gc(t){return new jo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ku extends Au{constructor(t,e,n){super(),this.Ac=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Ac.initialize(this,t),await Cu(this.Ac.syncEngine),await va(this.Ac.remoteStore),await this.persistence.li((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}Ic(t){return Io(this.persistence,new vo,t.initialUser,this.yt)}Tc(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Pi(n,t.asyncQueue,e)}Ec(t,e){const n=new bt(e,this.persistence);return new vt(t.asyncQueue,n)}yc(t){const e=yo(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ei.withCacheSize(this.cacheSizeBytes):Ei.DEFAULT;return new mo(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Wo(),Ho(),this.yt,this.sharedClientState,!!this.forceOwnership)}gc(t){return new jo}}class Nu extends ku{constructor(t,e){super(t,e,!1),this.Ac=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Ac.syncEngine;this.sharedClientState instanceof Bo&&(this.sharedClientState.syncEngine={Fr:Iu.bind(null,e),$r:Su.bind(null,e),Br:xu.bind(null,e),vi:_u.bind(null,e),Mr:bu.bind(null,e)},await this.sharedClientState.start()),await this.persistence.li((async t=>{await async function(t,e){const n=D(t);if(Du(n),Cu(n),!0===e&&!0!==n.dc){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Tu(n,t.toArray());n.dc=!0,await Aa(n.remoteStore,!0);for(const t of e)oa(n.remoteStore,t)}else if(!1===e&&!1!==n.dc){const t=[];let e=Promise.resolve();n.rc.forEach(((s,i)=>{n.sharedClientState.isLocalQueryTarget(i)?t.push(i):e=e.then((()=>(lu(n,i),Do(n.localStore,i,!0)))),aa(n.remoteStore,i)})),await e,await Tu(n,t),function(t){const e=D(t);e.cc.forEach(((t,n)=>{aa(e.remoteStore,n)})),e.ac.fs(),e.cc=new Map,e.uc=new ke(H.comparator)}(n),n.dc=!1,await Aa(n.remoteStore,!1)}}(this.Ac.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}gc(t){const e=Wo();if(!Bo.C(e))throw new A(C.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=yo(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Bo(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Ou{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>iu(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=yu.bind(null,this.syncEngine),await Aa(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Pa}createDatastore(t){const e=Yo(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new zo(s));var s;return function(t,e,n,s){return new ea(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,i=t=>iu(this.syncEngine,t,0),r=Go.C()?new Go:new Ko,new ra(e,n,s,i,r);var e,n,s,i,r}createSyncEngine(t,e){return function(t,e,n,s,i,r,o){const u=new tu(t,e,n,s,i,r);return o&&(u.dc=!0),u}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=D(t);v("RemoteStore","RemoteStore shutting down."),e._u.add(5),await ia(e),e.mu.shutdown(),e.gu.set("Unknown")}(this.remoteStore)}}function Ru(t,e,n){if(!n)throw new A(C.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Mu(t,e,n,s){if(!0===e&&!0===s)throw new A(C.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Fu(t){if(!H.isDocumentKey(t))throw new A(C.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Lu(t){if(H.isDocumentKey(t))throw new A(C.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Vu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":_()}function Pu(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new A(C.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Vu(t);throw new A(C.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function qu(t,e){if(e<=0)throw new A(C.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}const Uu=new Map;class Bu{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new A(C.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new A(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Mu("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class ju{constructor(t,e,n,s){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new A(C.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new A(C.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bu(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new N;switch(t.type){case"gapi":const e=t.client;return new F(e,t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new A(C.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Uu.get(t);e&&(v("ComponentProvider","Removing Datastore"),Uu.delete(t),e.terminate())}(this),Promise.resolve()}}function Ku(t,e,n,s={}){var i;const r=(t=Pu(t,ju))._getSettings();if("firestore.googleapis.com"!==r.host&&r.host!==e&&T("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},r),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=d.MOCK_USER;else{e=Object(h.f)(s.mockUserToken,null===(i=t._app)||void 0===i?void 0:i.options.projectId);const r=s.mockUserToken.sub||s.mockUserToken.user_id;if(!r)throw new A(C.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new d(r)}t._authCredentials=new O(new k(e,n))}}class Gu{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Qu(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Gu(this.firestore,t,this._key)}}class $u{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new $u(this.firestore,t,this._query)}}class Qu extends $u{constructor(t,e,n){super(t,e,Ye(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Gu(this.firestore,null,new H(t))}withConverter(t){return new Qu(this.firestore,t,this._path)}}function zu(t,e,...n){if(t=Object(h.l)(t),Ru("collection","path",e),t instanceof ju){const s=rt.fromString(e,...n);return Lu(s),new Qu(t,null,s)}{if(!(t instanceof Gu||t instanceof Qu))throw new A(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(rt.fromString(e,...n));return Lu(s),new Qu(t.firestore,null,s)}}function Wu(t,e){if(t=Pu(t,ju),Ru("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new A(C.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new $u(t,null,function(t){return new We(rt.emptyPath(),t)}(e))}function Hu(t,e,...n){if(t=Object(h.l)(t),1===arguments.length&&(e=U.R()),Ru("doc","path",e),t instanceof ju){const s=rt.fromString(e,...n);return Fu(s),new Gu(t,null,new H(s))}{if(!(t instanceof Gu||t instanceof Qu))throw new A(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(rt.fromString(e,...n));return Fu(s),new Gu(t.firestore,t instanceof Qu?t.converter:null,new H(s))}}function Yu(t,e){return t=Object(h.l)(t),e=Object(h.l)(e),(t instanceof Gu||t instanceof Qu)&&(e instanceof Gu||e instanceof Qu)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Xu(t,e){return t=Object(h.l)(t),e=Object(h.l)(e),t instanceof $u&&e instanceof $u&&t.firestore===e.firestore&&on(t._query,e._query)&&t.converter===e.converter}function Ju(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Zu{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Rc(this.observer.next,t)}error(t){this.observer.error?this.Rc(this.observer.error,t):I("Uncaught Error in snapshot listener:",t.toString())}bc(){this.muted=!0}Rc(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class tc{constructor(t,e){this.Pc=t,this.yt=e,this.metadata=new q,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then((t=>{t&&t.Ou()?this.metadata.resolve(t.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.ku)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){const t=await this.Sc();if(null===t)return null;const e=this.vc.decode(t),n=Number(e);isNaN(n)&&this.Dc(`length string (${e}) is not valid number`);const s=await this.Cc(n);return new $a(JSON.parse(s),t.length+n)}xc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Sc(){for(;this.xc()<0&&!await this.Nc(););if(0===this.buffer.length)return null;const t=this.xc();t<0&&this.Dc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Cc(t){for(;this.buffer.length<t;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");const e=this.vc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Dc(t){throw this.Pc.cancel(),new Error(`Invalid bundle format: ${t}`)}async Nc(){const t=await this.Pc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class ec{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new A(C.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=D(t),s=Lr(n.yt)+"/documents",i={documents:e.map((t=>Or(n.yt,t)))},r=await n._o("BatchGetDocuments",s,i,e.length),o=new Map;r.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){S(!!e.found),e.found.name,e.found.updateTime;const n=Rr(t,e.found.name),s=Ar(e.found.updateTime),i=e.found.createTime?Ar(e.found.createTime):$.min(),r=new Ve({mapValue:{fields:e.found.fields}});return qe.newFoundDocument(n,s,i,r)}(t,e):"missing"in e?function(t,e){S(!!e.missing),S(!!e.readTime);const n=Rr(t,e.missing),s=Ar(e.readTime);return qe.newNoDocument(n,s)}(t,e):_()}(n.yt,t);o.set(e.key.toString(),e)}));const u=[];return e.forEach((t=>{const e=o.get(t.toString());S(!!e),u.push(e)})),u}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Kn(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=H.fromPath(e);this.mutations.push(new Gn(n,this.precondition(n)))})),await async function(t,e){const n=D(t),s=Lr(n.yt)+"/documents",i={writes:e.map((t=>Ur(n.yt,t)))};await n.ao("Commit",s,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw _();e=$.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new A(C.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual($.min())?kn.exists(!1):kn.updateTime(e):kn.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual($.min()))throw new A(C.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return kn.updateTime(e)}return kn.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class nc{constructor(t,e,n,s,i){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=s,this.deferred=i,this.kc=n.maxAttempts,this.xo=new Xo(this.asyncQueue,"transaction_retry")}run(){this.kc-=1,this.Oc()}Oc(){this.xo.Ro((async()=>{const t=new ec(this.datastore),e=this.Mc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Fc(t)}))))})).catch((t=>{this.Fc(t)}))}))}Mc(t){try{const e=this.updateFunction(t);return!Dt(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Fc(t){this.kc>0&&this.$c(t)?(this.kc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Oc(),Promise.resolve())))):this.deferred.reject(t)}$c(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!Wn(e)}return!1}}class rc{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=d.UNAUTHENTICATED,this.clientId=U.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{v("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(v("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new A(C.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new q;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=Ra(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function sc(t,e){t.asyncQueue.verifyOperationInProgress(),v("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await To(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function ic(t,e){t.asyncQueue.verifyOperationInProgress();const n=await oc(t);v("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>Ca(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Ca(e.remoteStore,n))),t.onlineComponents=e}async function oc(t){return t.offlineComponents||(v("FirestoreClient","Using default OfflineComponentProvider"),await sc(t,new Au)),t.offlineComponents}async function ac(t){return t.onlineComponents||(v("FirestoreClient","Using default OnlineComponentProvider"),await ic(t,new Ou)),t.onlineComponents}function uc(t){return oc(t).then((t=>t.persistence))}function cc(t){return oc(t).then((t=>t.localStore))}function hc(t){return ac(t).then((t=>t.remoteStore))}function lc(t){return ac(t).then((t=>t.syncEngine))}function dc(t){return ac(t).then((t=>t.datastore))}async function fc(t){const e=await ac(t),n=e.eventManager;return n.onListen=eu.bind(null,e.syncEngine),n.onUnlisten=ru.bind(null,e.syncEngine),n}function mc(t,e,n={}){const s=new q;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,i){const r=new Zu({next:r=>{e.enqueueAndForget((()=>Ua(t,o)));const u=r.docs.has(n);!u&&r.fromCache?i.reject(new A(C.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&r.fromCache&&s&&"server"===s.source?i.reject(new A(C.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(r)},error:t=>i.reject(t)}),o=new Ga(Ye(n.path),r,{includeMetadataChanges:!0,Nu:!0});return qa(t,o)}(await fc(t),t.asyncQueue,e,n,s))),s.promise}function gc(t,e,n={}){const s=new q;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,i){const r=new Zu({next:n=>{e.enqueueAndForget((()=>Ua(t,o))),n.fromCache&&"server"===s.source?i.reject(new A(C.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:t=>i.reject(t)}),o=new Ga(n,r,{includeMetadataChanges:!0,Nu:!0});return qa(t,o)}(await fc(t),t.asyncQueue,e,n,s))),s.promise}function pc(t,e,n,s){const i=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new tc(t,e)}(function(t,e){if(t instanceof Uint8Array)return Ju(t,e);if(t instanceof ArrayBuffer)return Ju(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Yo(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=D(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=D(t),s=Ar(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ns.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(Wa(s));const i=new za(s,t.localStore,e.yt);let r=await e.mc();for(;r;){const t=await i.Fu(r);t&&n._updateProgress(t),r=await e.mc()}const o=await i.complete();return await pu(t,o.Lu,void 0),await function(t,e){const n=D(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ns.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress),Promise.resolve(o.Bu)}catch(t){return T("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(s,e,n).then((t=>{s.sharedClientState.notifyBundleLoaded(t)}))}(await lc(t),i,s)}))}class th{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.qc=!1,this.Uc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new Xo(this,"async_queue_retry"),this.Wc=()=>{const t=Ho();t&&v("AsyncQueue","Visibility state changed to "+t.visibilityState),this.xo.Po()};const t=Ho();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.qc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.zc(),this.Hc(t)}enterRestrictedMode(t){if(!this.qc){this.qc=!0,this.Qc=t||!1;const e=Ho();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Wc)}}enqueue(t){if(this.zc(),this.qc)return new Promise((()=>{}));const e=new q;return this.Hc((()=>this.qc&&this.Qc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Lc.push(t),this.Jc())))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(t){if(!mt(t))throw t;v("AsyncQueue","Operation failed with retryable error: "+t)}this.Lc.length>0&&this.xo.Ro((()=>this.Jc()))}}Hc(t){const e=this.Bc.then((()=>(this.Gc=!0,t().catch((t=>{this.Kc=t,this.Gc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw I("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Gc=!1,t))))));return this.Bc=e,e}enqueueAfterDelay(t,e,n){this.zc(),this.jc.indexOf(t)>-1&&(e=0);const s=Oa.createAndSchedule(this,t,e,n,(t=>this.Yc(t)));return this.Uc.push(s),s}zc(){this.Kc&&_()}verifyOperationInProgress(){}async Xc(){let t;do{t=this.Bc,await t}while(t!==this.Bc)}Zc(t){for(const e of this.Uc)if(e.timerId===t)return!0;return!1}ta(t){return this.Xc().then((()=>{this.Uc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.Uc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Xc()}))}ea(t){this.jc.push(t)}Yc(t){const e=this.Uc.indexOf(t);this.Uc.splice(e,1)}}function yc(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class wc{constructor(){this._progressObserver={},this._taskCompletionResolver=new q,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const vc=-1;class bc extends ju{constructor(t,e,n,s){super(t,e,n,s),this.type="firestore",this._queue=new th,this._persistenceKey=(null==s?void 0:s.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Tc(this),this._firestoreClient.terminate()}}function Ic(t){return t._firestoreClient||Tc(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Tc(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new Tt(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new rc(t._authCredentials,t._appCheckCredentials,t._queue,s)}function Ec(t,e){Oc(t=Pu(t,bc));const n=Ic(t),s=t._freezeSettings(),i=new Ou;return Sc(n,i,new ku(i,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function _c(t){Oc(t=Pu(t,bc));const e=Ic(t),n=t._freezeSettings(),s=new Ou;return Sc(e,s,new Nu(s,n.cacheSizeBytes))}function Sc(t,e,n){const s=new q;return t.asyncQueue.enqueue((async()=>{try{await sc(t,n),await ic(t,e),s.resolve()}catch(t){const e=t;if(!function(t){return"FirebaseError"===t.name?t.code===C.FAILED_PRECONDITION||t.code===C.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(e))throw e;T("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}})).then((()=>s.promise))}function xc(t){if(t._initialized&&!t._terminated)throw new A(C.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new q;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!ht.C())return Promise.resolve();const e=t+"main";await ht.delete(e)}(yo(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Dc(t){return function(t){const e=new q;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=D(t);da(n.remoteStore)||v("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=D(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.lc.get(t)||[];s.push(e),n.lc.set(t,s)}catch(t){const n=Ra(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await lc(t),e))),e.promise}(Ic(t=Pu(t,bc)))}function Cc(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await uc(t),n=await hc(t);return e.setNetworkEnabled(!0),function(t){const e=D(t);return e._u.delete(0),sa(e)}(n)}))}(Ic(t=Pu(t,bc)))}function Ac(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await uc(t),n=await hc(t);return e.setNetworkEnabled(!1),async function(t){const e=D(t);e._u.add(0),await ia(e),e.gu.set("Offline")}(n)}))}(Ic(t=Pu(t,bc)))}function kc(t,e){const n=Ic(t=Pu(t,bc)),s=new wc;return pc(n,t._databaseId,e,s),s}function Nc(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=D(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ns.getNamedQuery(t,e)))}(await cc(t),e)))}(Ic(t=Pu(t,bc)),e).then((e=>e?new $u(t,null,e.query):null))}function Oc(t){if(t._initialized||t._terminated)throw new A(C.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Rc{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Rc(Nt.fromBase64String(t))}catch(t){throw new A(C.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Rc(Nt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Mc{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new A(C.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class Fc{constructor(t){this._methodName=t}}class Lc{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new A(C.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new A(C.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return B(this._lat,t._lat)||B(this._long,t._long)}}const Vc=/^__.*__$/;class Pc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new qn(t,this.data,this.fieldMask,e,this.fieldTransforms):new Pn(t,this.data,e,this.fieldTransforms)}}class qc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new qn(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Uc(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw _()}}class Bc{constructor(t,e,n,s,i,r){this.settings=t,this.databaseId=e,this.yt=n,this.ignoreUndefinedProperties=s,void 0===i&&this.na(),this.fieldTransforms=i||[],this.fieldMask=r||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(t){return new Bc(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.yt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.ia({path:n,oa:!1});return s.ua(t),s}ca(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.ia({path:n,oa:!1});return s.na(),s}aa(t){return this.ia({path:void 0,oa:!0})}ha(t){return uh(t,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}na(){if(this.path)for(let t=0;t<this.path.length;t++)this.ua(this.path.get(t))}ua(t){if(0===t.length)throw this.ha("Document fields must not be empty");if(Uc(this.sa)&&Vc.test(t))throw this.ha('Document fields cannot begin and end with "__"')}}class jc{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.yt=n||Yo(t)}da(t,e,n,s=!1){return new Bc({sa:t,methodName:e,fa:n,path:W.emptyPath(),oa:!1,la:s},this.databaseId,this.yt,this.ignoreUndefinedProperties)}}function Kc(t){const e=t._freezeSettings(),n=Yo(t._databaseId);return new jc(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Gc(t,e,n,s,i,r={}){const o=t.da(r.merge||r.mergeFields?2:0,e,n,i);sh("Data must be an object, but it was:",o,s);const u=nh(s,o);let c,a;if(r.merge)c=new Le(o.fieldMask),a=o.fieldTransforms;else if(r.mergeFields){const t=[];for(const s of r.mergeFields){const i=ih(e,s,n);if(!o.contains(i))throw new A(C.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);ch(t,i)||t.push(i)}c=new Le(t),a=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,a=o.fieldTransforms;return new Pc(new Ve(u),c,a)}class $c extends Fc{_toFieldTransform(t){if(2!==t.sa)throw 1===t.sa?t.ha(`${this._methodName}() can only appear at the top level of your update data`):t.ha(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof $c}}function Qc(t,e,n){return new Bc({sa:3,fa:e.settings.fa,methodName:t._methodName,oa:n},e.databaseId,e.yt,e.ignoreUndefinedProperties)}class zc extends Fc{_toFieldTransform(t){return new Cn(t.path,new bn)}isEqual(t){return t instanceof zc}}class Wc extends Fc{constructor(t,e){super(t),this._a=e}_toFieldTransform(t){const e=Qc(this,t,!0),n=this._a.map((t=>eh(t,e))),s=new In(n);return new Cn(t.path,s)}isEqual(t){return this===t}}class Hc extends Fc{constructor(t,e){super(t),this._a=e}_toFieldTransform(t){const e=Qc(this,t,!0),n=this._a.map((t=>eh(t,e))),s=new En(n);return new Cn(t.path,s)}isEqual(t){return this===t}}class Yc extends Fc{constructor(t,e){super(t),this.wa=e}_toFieldTransform(t){const e=new Sn(t.yt,gn(t.yt,this.wa));return new Cn(t.path,e)}isEqual(t){return this===t}}function Xc(t,e,n,s){const i=t.da(1,e,n);sh("Data must be an object, but it was:",i,s);const r=[],o=Ve.empty();St(s,((t,s)=>{const u=ah(e,t,n);s=Object(h.l)(s);const c=i.ca(u);if(s instanceof $c)r.push(u);else{const t=eh(s,c);null!=t&&(r.push(u),o.set(u,t))}}));const u=new Le(r);return new qc(o,u,i.fieldTransforms)}function Jc(t,e,n,s,i,r){const o=t.da(1,e,n),u=[ih(e,s,n)],c=[i];if(r.length%2!=0)throw new A(C.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<r.length;t+=2)u.push(ih(e,r[t])),c.push(r[t+1]);const a=[],l=Ve.empty();for(let t=u.length-1;t>=0;--t)if(!ch(a,u[t])){const e=u[t];let n=c[t];n=Object(h.l)(n);const s=o.ca(e);if(n instanceof $c)a.push(e);else{const t=eh(n,s);null!=t&&(a.push(e),l.set(e,t))}}const d=new Le(a);return new qc(l,d,o.fieldTransforms)}function Zc(t,e,n,s=!1){return eh(n,t.da(s?4:3,e))}function eh(t,e){if(rh(t=Object(h.l)(t)))return sh("Unsupported field value:",e,t),nh(t,e);if(t instanceof Fc)return function(t,e){if(!Uc(e.sa))throw e.ha(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.ha(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.oa&&4!==e.sa)throw e.ha("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const i of t){let t=eh(i,e.aa(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=Object(h.l)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return gn(e.yt,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=G.fromDate(t);return{timestampValue:xr(e.yt,n)}}if(t instanceof G){const n=new G(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:xr(e.yt,n)}}if(t instanceof Lc)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Rc)return{bytesValue:Dr(e.yt,t._byteString)};if(t instanceof Gu){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.ha(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:kr(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.ha(`Unsupported field value: ${Vu(t)}`)}(t,e)}function nh(t,e){const n={};return xt(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):St(t,((t,s)=>{const i=eh(s,e.ra(t));null!=i&&(n[t]=i)})),{mapValue:{fields:n}}}function rh(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof G||t instanceof Lc||t instanceof Rc||t instanceof Gu||t instanceof Fc)}function sh(t,e,n){if(!rh(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=Vu(n);throw"an object"===s?e.ha(t+" a custom object"):e.ha(t+" "+s)}}function ih(t,e,n){if((e=Object(h.l)(e))instanceof Mc)return e._internalPath;if("string"==typeof e)return ah(t,e);throw uh("Field path arguments must be of type string or ",t,!1,void 0,n)}const oh=new RegExp("[~\\*/\\[\\]]");function ah(t,e,n){if(e.search(oh)>=0)throw uh(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Mc(...e.split("."))._internalPath}catch(r){throw uh(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function uh(t,e,n,s,i){const r=s&&!s.isEmpty(),o=void 0!==i;let u=`Function ${e}() called with invalid data`;n&&(u+=" (via `toFirestore()`)"),u+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${s}`),o&&(c+=` in document ${i}`),c+=")"),new A(C.INVALID_ARGUMENT,u+t+c)}function ch(t,e){return t.some((t=>t.isEqual(e)))}class hh{constructor(t,e,n,s,i){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Gu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new lh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(dh("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class lh extends hh{data(){return super.data()}}function dh(t,e){return"string"==typeof e?ah(t,e):e instanceof Mc?e._internalPath:e._delegate._internalPath}function fh(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new A(C.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class mh{}class gh extends mh{}function ph(t,e,...n){let s=[];e instanceof mh&&s.push(e),s=s.concat(n),function(t){const e=t.filter((t=>t instanceof ol)).length,n=t.filter((t=>t instanceof yh)).length;if(e>1||e>0&&n>0)throw new A(C.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(s);for(const e of s)t=e._apply(t);return t}class yh extends gh{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new yh(t,e,n)}_apply(t){const e=this._parse(t);return Oh(t._query,e),new $u(t.firestore,t.converter,rn(t._query,e))}_parse(t){const e=Kc(t.firestore),n=function(t,e,n,s,i,r,o){let u;if(i.isKeyField()){if("array-contains"===r||"array-contains-any"===r)throw new A(C.INVALID_ARGUMENT,`Invalid Query. You can't perform '${r}' queries on documentId().`);if("in"===r||"not-in"===r){Nh(o,r);const e=[];for(const n of o)e.push(kh(s,t,n));u={arrayValue:{values:e}}}else u=kh(s,t,o)}else"in"!==r&&"not-in"!==r&&"array-contains-any"!==r||Nh(o,r),u=Zc(n,"where",o,"in"===r||"not-in"===r);return he.create(i,r,u)}(t._query,0,e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function wh(t,e,n){const s=e,i=dh("where",t);return yh._create(i,s,n)}class ol extends mh{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new ol(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:le.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const s=e.getFlattenedFilters();for(const t of s)Oh(n,t),n=rn(n,t)}(t._query,e),new $u(t.firestore,t.converter,rn(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class vh extends gh{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new vh(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new A(C.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new A(C.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new Ce(e,n);return function(t,e){if(null===Je(t)){const n=Ze(t);null!==n&&Rh(t,n,e.field)}}(t,s),s}(t._query,this._field,this._direction);return new $u(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new We(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function bh(t,e="asc"){const n=e,s=dh("orderBy",t);return vh._create(s,n)}class Ih extends gh{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new Ih(t,e,n)}_apply(t){return new $u(t.firestore,t.converter,sn(t._query,this._limit,this._limitType))}}function Th(t){return qu("limit",t),Ih._create("limit",t,"F")}function dl(t){return qu("limitToLast",t),Ih._create("limitToLast",t,"L")}class Eh extends gh{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new Eh(t,e,n)}_apply(t){const e=Ah(t,this.type,this._docOrFields,this._inclusive);return new $u(t.firestore,t.converter,function(t,e){return new We(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function _h(...t){return Eh._create("startAt",t,!0)}function Sh(...t){return Eh._create("startAfter",t,!1)}class xh extends gh{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new xh(t,e,n)}_apply(t){const e=Ah(t,this.type,this._docOrFields,this._inclusive);return new $u(t.firestore,t.converter,function(t,e){return new We(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Dh(...t){return xh._create("endBefore",t,!1)}function Ch(...t){return xh._create("endAt",t,!0)}function Ah(t,e,n,s){if(n[0]=Object(h.l)(n[0]),n[0]instanceof hh)return function(t,e,n,s,i){if(!s)throw new A(C.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const r=[];for(const n of en(t))if(n.field.isKeyField())r.push(Wt(e,s.key));else{const t=s.data.field(n.field);if(Lt(t))throw new A(C.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new A(C.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}r.push(t)}return new oe(r,i)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const i=Kc(t.firestore);return function(t,e,n,s,i,r){const o=t.explicitOrderBy;if(i.length>o.length)throw new A(C.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const u=[];for(let r=0;r<i.length;r++){const c=i[r];if(o[r].field.isKeyField()){if("string"!=typeof c)throw new A(C.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof c}`);if(!tn(t)&&-1!==c.indexOf("/"))throw new A(C.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(rt.fromString(c));if(!H.isDocumentKey(n))throw new A(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new H(n);u.push(Wt(e,i))}else{const t=Zc(n,s,c);u.push(t)}}return new oe(u,r)}(t._query,t.firestore._databaseId,i,e,n,s)}}function kh(t,e,n){if("string"==typeof(n=Object(h.l)(n))){if(""===n)throw new A(C.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!tn(e)&&-1!==n.indexOf("/"))throw new A(C.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(rt.fromString(n));if(!H.isDocumentKey(s))throw new A(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return Wt(t,new H(s))}if(n instanceof Gu)return Wt(t,n._key);throw new A(C.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Vu(n)}.`)}function Nh(t,e){if(!Array.isArray(t)||0===t.length)throw new A(C.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new A(C.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Oh(t,e){if(e.isInequality()){const n=Ze(t),s=e.field;if(null!==n&&!n.isEqual(s))throw new A(C.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${s.toString()}'`);const i=Je(t);null!==i&&Rh(t,s,i)}const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new A(C.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new A(C.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function Rh(t,e,n){if(!n.isEqual(e))throw new A(C.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Mh{convertValue(t,e="none"){switch(Bt(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Mt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Ft(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw _()}}convertObject(t,e){const n={};return St(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new Lc(Mt(t.latitude),Mt(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Vt(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Pt(t));default:return null}}convertTimestamp(t){const e=Rt(t);return new G(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=rt.fromString(t);S(Jr(n));const s=new Et(n.get(1),n.get(3)),i=new H(n.popFirst(5));return s.isEqual(e)||I(`Document ${i} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),i}}function Fh(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class Lh extends Mh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Rc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gu(this.firestore,null,e)}}class Vh{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Ph extends hh{constructor(t,e,n,s,i,r){super(t,e,n,s,r),this._firestore=t,this._firestoreImpl=t,this.metadata=i}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new qh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(dh("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class qh extends Ph{data(t={}){return super.data(t)}}class Uh{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Vh(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new qh(this._firestore,this._userDataWriter,n.key,n,new Vh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new A(C.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const s=new qh(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Vh(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:s,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new qh(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Vh(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let i=-1,r=-1;return 0!==e.type&&(i=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),r=n.indexOf(e.doc.key)),{type:Bh(e.type),doc:s,oldIndex:i,newIndex:r}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Bh(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return _()}}function jh(t,e){return t instanceof Ph&&e instanceof Ph?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Uh&&e instanceof Uh&&t._firestore===e._firestore&&Xu(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Kh(t){t=Pu(t,Gu);const e=Pu(t.firestore,bc);return mc(Ic(e),t._key).then((n=>rl(e,t,n)))}class Gh extends Mh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Rc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gu(this.firestore,null,e)}}function $h(t){t=Pu(t,Gu);const e=Pu(t.firestore,bc),n=Ic(e),s=new Gh(e);return function(t,e){const n=new q;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=D(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new A(C.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=Ra(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await cc(t),e,n))),n.promise}(n,t._key).then((n=>new Ph(e,s,t._key,n,new Vh(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Qh(t){t=Pu(t,Gu);const e=Pu(t.firestore,bc);return mc(Ic(e),t._key,{source:"server"}).then((n=>rl(e,t,n)))}function zh(t){t=Pu(t,$u);const e=Pu(t.firestore,bc),n=Ic(e),s=new Gh(e);return fh(t._query),gc(n,t._query).then((n=>new Uh(e,s,t,n)))}function Wh(t){t=Pu(t,$u);const e=Pu(t.firestore,bc),n=Ic(e),s=new Gh(e);return function(t,e){const n=new q;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await Co(t,e,!0),i=new Xa(e,s.Hi),r=i.Wu(s.documents),o=i.applyChanges(r,!1);n.resolve(o.snapshot)}catch(t){const s=Ra(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await cc(t),e,n))),n.promise}(n,t._query).then((n=>new Uh(e,s,t,n)))}function Hh(t){t=Pu(t,$u);const e=Pu(t.firestore,bc),n=Ic(e),s=new Gh(e);return gc(n,t._query,{source:"server"}).then((n=>new Uh(e,s,t,n)))}function Yh(t,e,n){t=Pu(t,Gu);const s=Pu(t.firestore,bc),i=Fh(t.converter,e,n);return nl(s,[Gc(Kc(s),"setDoc",t._key,i,null!==t.converter,n).toMutation(t._key,kn.none())])}function Xh(t,e,n,...s){t=Pu(t,Gu);const i=Pu(t.firestore,bc),r=Kc(i);let o;return o="string"==typeof(e=Object(h.l)(e))||e instanceof Mc?Jc(r,"updateDoc",t._key,e,n,s):Xc(r,"updateDoc",t._key,e),nl(i,[o.toMutation(t._key,kn.exists(!0))])}function Jh(t){return nl(Pu(t.firestore,bc),[new Kn(t._key,kn.none())])}function Zh(t,e){const n=Pu(t.firestore,bc),s=Hu(t),i=Fh(t.converter,e);return nl(n,[Gc(Kc(t.firestore),"addDoc",s._key,i,null!==t.converter,{}).toMutation(s._key,kn.exists(!1))]).then((()=>s))}function tl(t,...e){var n,s,i;t=Object(h.l)(t);let r={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||yc(e[o])||(r=e[o],o++);const u={includeMetadataChanges:r.includeMetadataChanges};if(yc(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(i=t.complete)||void 0===i?void 0:i.bind(t)}let c,a,l;if(t instanceof Gu)a=Pu(t.firestore,bc),l=Ye(t._key.path),c={next:n=>{e[o]&&e[o](rl(a,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Pu(t,$u);a=Pu(n.firestore,bc),l=n._query;const s=new Gh(a);c={next:t=>{e[o]&&e[o](new Uh(a,s,n,t))},error:e[o+1],complete:e[o+2]},fh(t._query)}return function(t,e,n,s){const i=new Zu(s),r=new Ga(e,i,n);return t.asyncQueue.enqueueAndForget((async()=>qa(await fc(t),r))),()=>{i.bc(),t.asyncQueue.enqueueAndForget((async()=>Ua(await fc(t),r)))}}(Ic(a),l,u,c)}function el(t,e){return function(t,e){const n=new Zu(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){D(t).Ru.add(e),e.next()}(await fc(t),n))),()=>{n.bc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){D(t).Ru.delete(e)}(await fc(t),n)))}}(Ic(t=Pu(t,bc)),yc(e)?e:{next:e})}function nl(t,e){return function(t,e){const n=new q;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=Cu(t);try{const t=await function(t,e){const n=D(t),s=G.now(),i=e.reduce(((t,e)=>t.add(e.key)),ur());let r,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let u=Jn(),c=ur();return n.Gi.getEntries(t,i).next((t=>{u=t,u.forEach(((t,e)=>{e.isValidDocument()||(c=c.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,u))).next((i=>{r=i;const o=[];for(const t of e){const e=Ln(t,r.get(t.key).overlayedDocument);null!=e&&o.push(new qn(t.key,e,Pe(e.value.mapValue),kn.exists(!0)))}return n.mutationQueue.addMutationBatch(t,s,o,e)})).next((e=>{o=e;const s=e.applyToLocalDocumentSet(r,c);return n.documentOverlayCache.saveOverlays(t,e.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:nr(r)})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.hc[t.currentUser.toKey()];s||(s=new ke(B)),s=s.insert(e,n),t.hc[t.currentUser.toKey()]=s}(s,t.batchId,n),await pu(s,t.changes),await va(s.remoteStore)}catch(t){const e=Ra(t,"Failed to persist write");n.reject(e)}}(await lc(t),e,n))),n.promise}(Ic(t),e)}function rl(t,e,n){const s=n.docs.get(e._key),i=new Gh(t);return new Ph(t,i,e._key,s,new Vh(n.hasPendingWrites,n.fromCache),e.converter)}const sl={maxAttempts:5};class il{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Kc(t)}set(t,e,n){this._verifyNotCommitted();const s=al(t,this._firestore),i=Fh(s.converter,e,n),r=Gc(this._dataReader,"WriteBatch.set",s._key,i,null!==s.converter,n);return this._mutations.push(r.toMutation(s._key,kn.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const i=al(t,this._firestore);let r;return r="string"==typeof(e=Object(h.l)(e))||e instanceof Mc?Jc(this._dataReader,"WriteBatch.update",i._key,e,n,s):Xc(this._dataReader,"WriteBatch.update",i._key,e),this._mutations.push(r.toMutation(i._key,kn.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=al(t,this._firestore);return this._mutations=this._mutations.concat(new Kn(e._key,kn.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new A(C.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function al(t,e){if((t=Object(h.l)(t)).firestore!==e)throw new A(C.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class cl extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Kc(t)}get(t){const e=al(t,this._firestore),n=new Lh(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return _();const s=t[0];if(s.isFoundDocument())return new hh(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new hh(this._firestore,n,e._key,null,e.converter);throw _()}))}set(t,e,n){const s=al(t,this._firestore),i=Fh(s.converter,e,n),r=Gc(this._dataReader,"Transaction.set",s._key,i,null!==s.converter,n);return this._transaction.set(s._key,r),this}update(t,e,n,...s){const i=al(t,this._firestore);let r;return r="string"==typeof(e=Object(h.l)(e))||e instanceof Mc?Jc(this._dataReader,"Transaction.update",i._key,e,n,s):Xc(this._dataReader,"Transaction.update",i._key,e),this._transaction.update(i._key,r),this}delete(t){const e=al(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=al(t,this._firestore),n=new Gh(this._firestore);return super.get(t).then((t=>new Ph(this._firestore,n,e._key,t._document,new Vh(!1,!1),e.converter)))}}function hl(t,e,n){t=Pu(t,bc);const s=Object.assign(Object.assign({},sl),n);return function(t){if(t.maxAttempts<1)throw new A(C.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(t,e,n){const s=new q;return t.asyncQueue.enqueueAndForget((async()=>{const i=await dc(t);new nc(t.asyncQueue,i,n,e,s).run()})),s.promise}(Ic(t),(n=>e(new cl(t,n))),s)}function ll(){return new $c("deleteField")}function fl(){return new zc("serverTimestamp")}function ml(...t){return new Wc("arrayUnion",t)}function gl(...t){return new Hc("arrayRemove",t)}function pl(t){return new Yc("increment",t)}!function(t,e=!0){!function(t){f=t}(r.SDK_VERSION),Object(r._registerComponent)(new o.a("firestore",((t,{instanceIdentifier:n,options:s})=>{const i=t.getProvider("app").getImmediate(),r=new bc(new R(t.getProvider("auth-internal")),new V(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new A(C.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Et(t.options.projectId,e)}(i,n),i);return s=Object.assign({useFetchStreams:e},s),r._setSettings(s),r}),"PUBLIC").setMultipleInstances(!0)),Object(r.registerVersion)(b,"3.8.0",t),Object(r.registerVersion)(b,"3.8.0","esm2017")}()}).call(this,n(127))},262:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return ir})),n.d(e,"b",(function(){return ar})),n.d(e,"c",(function(){return or})),n.d(e,"d",(function(){return cr})),n.d(e,"e",(function(){return ur})),n.d(e,"f",(function(){return lr})),n.d(e,"g",(function(){return dr})),n.d(e,"h",(function(){return rr})),n.d(e,"i",(function(){return sr}));var r,o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{},c={},h=h||{},l=o||self;function d(){}function f(a){var b=typeof a;return"array"==(b="object"!=b?b:a?Array.isArray(a)?"array":b:"null")||"object"==b&&"number"==typeof a.length}function p(a){var b=typeof a;return"object"==b&&null!=a||"function"==b}var m="closure_uid_"+(1e9*Math.random()>>>0),y=0;function w(a,b,t){return a.call.apply(a.bind,arguments)}function v(a,b,t){if(!a)throw Error();if(2<arguments.length){var e=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,e),a.apply(b,t)}}return function(){return a.apply(b,arguments)}}function q(a,b,t){return(q=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?w:v).apply(null,arguments)}function I(a,b){var t=Array.prototype.slice.call(arguments,1);return function(){var e=t.slice();return e.push.apply(e,arguments),a.apply(this,e)}}function T(a,b){function t(){}t.prototype=b.prototype,a.X=b.prototype,a.prototype=new t,a.prototype.constructor=a,a.Wb=function(t,e,n){for(var r=Array(arguments.length-2),o=2;o<arguments.length;o++)r[o-2]=arguments[o];return b.prototype[e].apply(t,r)}}function E(){this.s=this.s,this.o=this.o}E.prototype.s=!1,E.prototype.na=function(){var a;!this.s&&(this.s=!0,this.M(),0)&&(a=this,Object.prototype.hasOwnProperty.call(a,m)&&a[m]||(a[m]=++y))},E.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const _=Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b,void 0)}:function(a,b){if("string"==typeof a)return"string"!=typeof b||1!=b.length?-1:a.indexOf(b,0);for(let t=0;t<a.length;t++)if(t in a&&a[t]===b)return t;return-1};function S(a){const b=a.length;if(0<b){const t=Array(b);for(let e=0;e<b;e++)t[e]=a[e];return t}return[]}function x(a,b){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(f(e)){const t=a.length||0,n=e.length||0;a.length=t+n;for(let r=0;r<n;r++)a[t+r]=e[r]}else a.push(e)}}function D(a,b){this.type=a,this.g=this.target=b,this.defaultPrevented=!1}D.prototype.h=function(){this.defaultPrevented=!0};var C=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var a=!1,b=Object.defineProperty({},"passive",{get:function(){a=!0}});try{l.addEventListener("test",d,b),l.removeEventListener("test",d,b)}catch(t){}return a}();function A(a){return/^[\s\xa0]*$/.test(a)}var k=String.prototype.trim?function(a){return a.trim()}:function(a){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(a)[1]};function N(a,b){return a<b?-1:a>b?1:0}function O(){var a=l.navigator;return a&&(a=a.userAgent)?a:""}function R(a){return-1!=O().indexOf(a)}function M(a){return M[" "](a),a}M[" "]=d;var F,a,L=R("Opera"),V=R("Trident")||R("MSIE"),P=R("Edge"),U=P||V,B=R("Gecko")&&!(-1!=O().toLowerCase().indexOf("webkit")&&!R("Edge"))&&!(R("Trident")||R("MSIE"))&&!R("Edge"),j=-1!=O().toLowerCase().indexOf("webkit")&&!R("Edge");function K(){var a=l.document;return a?a.documentMode:void 0}t:{var G="",$=(a=O(),B?/rv:([^\);]+)(\)|;)/.exec(a):P?/Edge\/([\d\.]+)/.exec(a):V?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(a):j?/WebKit\/(\S+)/.exec(a):L?/(?:Version)[ \/]?(\S+)/.exec(a):void 0);if($&&(G=$?$[1]:""),V){var Q=K();if(null!=Q&&Q>parseFloat(G)){F=String(Q);break t}}F=G}var z,W={};function H(){return function(a){var b=W;return Object.prototype.hasOwnProperty.call(b,9)?b[9]:b[9]=a(9)}((function(){let a=0;const b=k(String(F)).split("."),t=k("9").split("."),e=Math.max(b.length,t.length);for(let o=0;0==a&&o<e;o++){var n=b[o]||"",r=t[o]||"";do{if(n=/(\d*)(\D*)(.*)/.exec(n)||["","","",""],r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],0==n[0].length&&0==r[0].length)break;a=N(0==n[1].length?0:parseInt(n[1],10),0==r[1].length?0:parseInt(r[1],10))||N(0==n[2].length,0==r[2].length)||N(n[2],r[2]),n=n[3],r=r[3]}while(0==a)}return 0<=a}))}if(l.document&&V){var Y=K();z=Y||(parseInt(F,10)||void 0)}else z=void 0;var X=z;function J(a,b){if(D.call(this,a?a.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,a){var t=this.type=a.type,e=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.g=b,b=a.relatedTarget){if(B){t:{try{M(b.nodeName);var n=!0;break t}catch(t){}n=!1}n||(b=null)}}else"mouseover"==t?b=a.fromElement:"mouseout"==t&&(b=a.toElement);this.relatedTarget=b,e?(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0):(this.clientX=void 0!==a.clientX?a.clientX:a.pageX,this.clientY=void 0!==a.clientY?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType="string"==typeof a.pointerType?a.pointerType:Z[a.pointerType]||"",this.state=a.state,this.i=a,a.defaultPrevented&&J.X.h.call(this)}}T(J,D);var Z={2:"touch",3:"pen",4:"mouse"};J.prototype.h=function(){J.X.h.call(this);var a=this.i;a.preventDefault?a.preventDefault():a.returnValue=!1};var tt="closure_listenable_"+(1e6*Math.random()|0),et=0;function nt(a,b,t,e,n){this.listener=a,this.proxy=null,this.src=b,this.type=t,this.capture=!!e,this.ha=n,this.key=++et,this.ba=this.ea=!1}function st(a){a.ba=!0,a.listener=null,a.proxy=null,a.src=null,a.ha=null}function it(a,b,t){for(const e in a)b.call(t,a[e],e,a)}function ot(a){const b={};for(const t in a)b[t]=a[t];return b}const at="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ut(a,b){let t,e;for(let n=1;n<arguments.length;n++){for(t in e=arguments[n],e)a[t]=e[t];for(let n=0;n<at.length;n++)t=at[n],Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t])}}function ct(a){this.src=a,this.g={},this.h=0}function ht(a,b){var t=b.type;if(t in a.g){var e,n=a.g[t],r=_(n,b);(e=0<=r)&&Array.prototype.splice.call(n,r,1),e&&(st(b),0==a.g[t].length&&(delete a.g[t],a.h--))}}function lt(a,b,t,e){for(var n=0;n<a.length;++n){var r=a[n];if(!r.ba&&r.listener==b&&r.capture==!!t&&r.ha==e)return n}return-1}ct.prototype.add=function(a,b,t,e,n){var r=a.toString();(a=this.g[r])||(a=this.g[r]=[],this.h++);var o=lt(a,b,e,n);return-1<o?(b=a[o],t||(b.ea=!1)):((b=new nt(b,this.src,r,!!e,n)).ea=t,a.push(b)),b};var ft="closure_lm_"+(1e6*Math.random()|0),mt={};function gt(a,b,t,e,n){if(e&&e.once)return yt(a,b,t,e,n);if(Array.isArray(b)){for(var r=0;r<b.length;r++)gt(a,b[r],t,e,n);return null}return t=_t(t),a&&a[tt]?a.N(b,t,p(e)?!!e.capture:!!e,n):pt(a,b,t,!1,e,n)}function pt(a,b,t,e,n,r){if(!b)throw Error("Invalid event type");var o=p(n)?!!n.capture:!!n,c=Tt(a);if(c||(a[ft]=c=new ct(a)),(t=c.add(b,t,e,o,r)).proxy)return t;if(e=function(){function a(t){return b.call(a.src,a.listener,t)}const b=It;return a}(),t.proxy=e,e.src=a,e.listener=t,a.addEventListener)C||(n=o),void 0===n&&(n=!1),a.addEventListener(b.toString(),e,n);else if(a.attachEvent)a.attachEvent(bt(b.toString()),e);else{if(!a.addListener||!a.removeListener)throw Error("addEventListener and attachEvent are unavailable.");a.addListener(e)}return t}function yt(a,b,t,e,n){if(Array.isArray(b)){for(var r=0;r<b.length;r++)yt(a,b[r],t,e,n);return null}return t=_t(t),a&&a[tt]?a.O(b,t,p(e)?!!e.capture:!!e,n):pt(a,b,t,!0,e,n)}function wt(a,b,t,e,n){if(Array.isArray(b))for(var r=0;r<b.length;r++)wt(a,b[r],t,e,n);else e=p(e)?!!e.capture:!!e,t=_t(t),a&&a[tt]?(a=a.i,(b=String(b).toString())in a.g&&(-1<(t=lt(r=a.g[b],t,e,n))&&(st(r[t]),Array.prototype.splice.call(r,t,1),0==r.length&&(delete a.g[b],a.h--)))):a&&(a=Tt(a))&&(b=a.g[b.toString()],a=-1,b&&(a=lt(b,t,e,n)),(t=-1<a?b[a]:null)&&vt(t))}function vt(a){if("number"!=typeof a&&a&&!a.ba){var b=a.src;if(b&&b[tt])ht(b.i,a);else{var t=a.type,e=a.proxy;b.removeEventListener?b.removeEventListener(t,e,a.capture):b.detachEvent?b.detachEvent(bt(t),e):b.addListener&&b.removeListener&&b.removeListener(e),(t=Tt(b))?(ht(t,a),0==t.h&&(t.src=null,b[ft]=null)):st(a)}}}function bt(a){return a in mt?mt[a]:mt[a]="on"+a}function It(a,b){if(a.ba)a=!0;else{b=new J(b,this);var t=a.listener,e=a.ha||a.src;a.ea&&vt(a),a=t.call(e,b)}return a}function Tt(a){return(a=a[ft])instanceof ct?a:null}var Et="__closure_events_fn_"+(1e9*Math.random()>>>0);function _t(a){return"function"==typeof a?a:(a[Et]||(a[Et]=function(b){return a.handleEvent(b)}),a[Et])}function St(){E.call(this),this.i=new ct(this),this.P=this,this.I=null}function xt(a,b){var t,e=a.I;if(e)for(t=[];e;e=e.I)t.push(e);if(a=a.P,e=b.type||b,"string"==typeof b)b=new D(b,a);else if(b instanceof D)b.target=b.target||a;else{var n=b;ut(b=new D(e,a),n)}if(n=!0,t)for(var r=t.length-1;0<=r;r--){var o=b.g=t[r];n=Dt(o,e,!0,b)&&n}if(n=Dt(o=b.g=a,e,!0,b)&&n,n=Dt(o,e,!1,b)&&n,t)for(r=0;r<t.length;r++)n=Dt(o=b.g=t[r],e,!1,b)&&n}function Dt(a,b,t,e){if(!(b=a.i.g[String(b)]))return!0;b=b.concat();for(var n=!0,r=0;r<b.length;++r){var o=b[r];if(o&&!o.ba&&o.capture==t){var c=o.listener,u=o.ha||o.src;o.ea&&ht(a.i,o),n=!1!==c.call(u,e)&&n}}return n&&!e.defaultPrevented}T(St,E),St.prototype[tt]=!0,St.prototype.removeEventListener=function(a,b,t,e){wt(this,a,b,t,e)},St.prototype.M=function(){if(St.X.M.call(this),this.i){var t,a=this.i;for(t in a.g){for(var e=a.g[t],n=0;n<e.length;n++)st(e[n]);delete a.g[t],a.h--}}this.I=null},St.prototype.N=function(a,b,t,e){return this.i.add(String(a),b,!1,t,e)},St.prototype.O=function(a,b,t,e){return this.i.add(String(a),b,!0,t,e)};var Ct=l.JSON.stringify;function At(){var a=Lt;let b=null;return a.g&&(b=a.g,a.g=a.g.next,a.g||(a.h=null),b.next=null),b}var kt,Nt=new class{constructor(a,b){this.i=a,this.j=b,this.h=0,this.g=null}get(){let a;return 0<this.h?(this.h--,a=this.g,this.g=a.next,a.next=null):a=this.i(),a}}((()=>new Ot),(a=>a.reset()));class Ot{constructor(){this.next=this.g=this.h=null}set(a,b){this.h=a,this.g=b,this.next=null}reset(){this.next=this.g=this.h=null}}function Rt(a){l.setTimeout((()=>{throw a}),0)}function Mt(a,b){kt||function(){var a=l.Promise.resolve(void 0);kt=function(){a.then(Vt)}}(),Ft||(kt(),Ft=!0),Lt.add(a,b)}var Ft=!1,Lt=new class{constructor(){this.h=this.g=null}add(a,b){const t=Nt.get();t.set(a,b),this.h?this.h.next=t:this.g=t,this.h=t}};function Vt(){for(var a;a=At();){try{a.h.call(a.g)}catch(t){Rt(t)}var b=Nt;b.j(a),100>b.h&&(b.h++,a.next=b.g,b.g=a)}Ft=!1}function Pt(a,b){St.call(this),this.h=a||1,this.g=b||l,this.j=q(this.lb,this),this.l=Date.now()}function qt(a){a.ca=!1,a.R&&(a.g.clearTimeout(a.R),a.R=null)}function Ut(a,b,t){if("function"==typeof a)t&&(a=q(a,t));else{if(!a||"function"!=typeof a.handleEvent)throw Error("Invalid listener argument");a=q(a.handleEvent,a)}return 2147483647<Number(b)?-1:l.setTimeout(a,b||0)}function Bt(a){a.g=Ut((()=>{a.g=null,a.i&&(a.i=!1,Bt(a))}),a.j);const b=a.h;a.h=null,a.m.apply(null,b)}T(Pt,St),(r=Pt.prototype).ca=!1,r.R=null,r.lb=function(){if(this.ca){var a=Date.now()-this.l;0<a&&a<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-a):(this.R&&(this.g.clearTimeout(this.R),this.R=null),xt(this,"tick"),this.ca&&(qt(this),this.start()))}},r.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},r.M=function(){Pt.X.M.call(this),qt(this),delete this.g};class jt extends E{constructor(a,b){super(),this.m=a,this.j=b,this.h=null,this.i=!1,this.g=null}l(a){this.h=arguments,this.g?this.i=!0:Bt(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Kt(a){E.call(this),this.h=a,this.g={}}T(Kt,E);var Gt=[];function $t(a,b,t,e){Array.isArray(t)||(t&&(Gt[0]=t.toString()),t=Gt);for(var n=0;n<t.length;n++){var r=gt(b,t[n],e||a.handleEvent,!1,a.h||a);if(!r)break;a.g[r.key]=r}}function Qt(a){it(a.g,(function(b,t){this.g.hasOwnProperty(t)&&vt(b)}),a),a.g={}}function zt(){this.g=!0}function Wt(a,b,t,e){a.info((function(){return"XMLHTTP TEXT ("+b+"): "+function(a,b){if(!a.g)return b;if(!b)return null;try{var t=JSON.parse(b);if(t)for(a=0;a<t.length;a++)if(Array.isArray(t[a])){var e=t[a];if(!(2>e.length)){var n=e[1];if(Array.isArray(n)&&!(1>n.length)){var r=n[0];if("noop"!=r&&"stop"!=r&&"close"!=r)for(var o=1;o<n.length;o++)n[o]=""}}}return Ct(t)}catch(t){return b}}(a,t)+(e?" "+e:"")}))}Kt.prototype.M=function(){Kt.X.M.call(this),Qt(this)},Kt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},zt.prototype.Aa=function(){this.g=!1},zt.prototype.info=function(){};var Ht={},Yt=null;function Xt(){return Yt=Yt||new St}function Jt(a){D.call(this,Ht.Pa,a)}function Zt(a){const b=Xt();xt(b,new Jt(b))}function te(a,b){D.call(this,Ht.STAT_EVENT,a),this.stat=b}function ee(a){const b=Xt();xt(b,new te(b,a))}function ne(a,b){D.call(this,Ht.Qa,a),this.size=b}function re(a,b){if("function"!=typeof a)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){a()}),b)}Ht.Pa="serverreachability",T(Jt,D),Ht.STAT_EVENT="statevent",T(te,D),Ht.Qa="timingevent",T(ne,D);var se={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},ie={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function oe(){}function ae(a){return a.h||(a.h=a.i())}function ue(){}oe.prototype.h=null;var ce,he={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function le(){D.call(this,"d")}function de(){D.call(this,"c")}function fe(){}function me(a,b,t,e){this.l=a,this.j=b,this.m=t,this.U=e||1,this.S=new Kt(this),this.O=pe,a=U?125:void 0,this.T=new Pt(a),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new ge}function ge(){this.i=null,this.g="",this.h=!1}T(le,D),T(de,D),T(fe,oe),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ce=new fe;var pe=45e3,ye={},we={};function ve(a,b,t){a.K=1,a.v=Pe(Re(b)),a.s=t,a.P=!0,be(a,null)}function be(a,b){a.F=Date.now(),_e(a),a.A=Re(a.v);var t=a.A,e=a.U;Array.isArray(e)||(e=[String(e)]),Xe(t.i,"t",e),a.C=0,t=a.l.H,a.h=new ge,a.g=Hn(a.l,t?b:null,!a.s),0<a.N&&(a.L=new jt(q(a.La,a,a.g),a.N)),$t(a.S,a.g,"readystatechange",a.ib),b=a.H?ot(a.H):{},a.s?(a.u||(a.u="POST"),b["Content-Type"]="application/x-www-form-urlencoded",a.g.da(a.A,a.u,a.s,b)):(a.u="GET",a.g.da(a.A,a.u,null,b)),Zt(),function(a,b,t,e,n,r){a.info((function(){if(a.g)if(r)for(var o="",c=r.split("&"),u=0;u<c.length;u++){var h=c[u].split("=");if(1<h.length){var l=h[0];h=h[1];var d=l.split("_");o=2<=d.length&&"type"==d[1]?o+(l+"=")+h+"&":o+(l+"=redacted&")}}else o=null;else o=r;return"XMLHTTP REQ ("+e+") [attempt "+n+"]: "+b+"\n"+t+"\n"+o}))}(a.j,a.u,a.A,a.m,a.U,a.s)}function Ie(a){return!!a.g&&("GET"==a.u&&2!=a.K&&a.l.Da)}function Te(a,b,t){let e,n=!0;for(;!a.I&&a.C<t.length;){if(e=Ee(a,t),e==we){4==b&&(a.o=4,ee(14),n=!1),Wt(a.j,a.m,null,"[Incomplete Response]");break}if(e==ye){a.o=4,ee(15),Wt(a.j,a.m,t,"[Invalid Chunk]"),n=!1;break}Wt(a.j,a.m,e,null),Ae(a,e)}Ie(a)&&e!=we&&e!=ye&&(a.h.g="",a.C=0),4!=b||0!=t.length||a.h.h||(a.o=1,ee(16),n=!1),a.i=a.i&&n,n?0<t.length&&!a.$&&(a.$=!0,(b=a.l).g==a&&b.$&&!b.K&&(b.j.info("Great, no buffering proxy detected. Bytes received: "+t.length),Bn(b),b.K=!0,ee(11))):(Wt(a.j,a.m,t,"[Invalid Chunked Response]"),Ce(a),De(a))}function Ee(a,b){var t=a.C,e=b.indexOf("\n",t);return-1==e?we:(t=Number(b.substring(t,e)),isNaN(t)?ye:(e+=1)+t>b.length?we:(b=b.substr(e,t),a.C=e+t,b))}function _e(a){a.V=Date.now()+a.O,Se(a,a.O)}function Se(a,b){if(null!=a.B)throw Error("WatchDog timer not null");a.B=re(q(a.gb,a),b)}function xe(a){a.B&&(l.clearTimeout(a.B),a.B=null)}function De(a){0==a.l.G||a.I||Gn(a.l,a)}function Ce(a){xe(a);var b=a.L;b&&"function"==typeof b.na&&b.na(),a.L=null,qt(a.T),Qt(a.S),a.g&&(b=a.g,a.g=null,b.abort(),b.na())}function Ae(a,b){try{var t=a.l;if(0!=t.G&&(t.g==a||rn(t.h,a)))if(!a.J&&rn(t.h,a)&&3==t.G){try{var e=t.Fa.g.parse(b)}catch(t){e=null}if(Array.isArray(e)&&3==e.length){var n=e;if(0==n[0]){t:if(!t.u){if(t.g){if(!(t.g.F+3e3<a.F))break t;Kn(t),Rn(t)}Un(t),ee(18)}}else t.Ba=n[1],0<t.Ba-t.T&&37500>n[2]&&t.L&&0==t.A&&!t.v&&(t.v=re(q(t.cb,t),6e3));if(1>=nn(t.h)&&t.ja){try{t.ja()}catch(t){}t.ja=void 0}}else Qn(t,11)}else if((a.J||t.g==a)&&Kn(t),!A(b))for(n=t.Fa.g.parse(b),b=0;b<n.length;b++){let h=n[b];if(t.T=h[0],h=h[1],2==t.G)if("c"==h[0]){t.I=h[1],t.ka=h[2];const n=h[3];null!=n&&(t.ma=n,t.j.info("VER="+t.ma));const l=h[4];null!=l&&(t.Ca=l,t.j.info("SVER="+t.Ca));const d=h[5];null!=d&&"number"==typeof d&&0<d&&(e=1.5*d,t.J=e,t.j.info("backChannelRequestTimeoutMs_="+e)),e=t;const f=a.g;if(f){const t=f.g?f.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var r=e.h;r.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(r.j=r.l,r.g=new Set,r.h&&(sn(r,r.h),r.h=null))}if(e.D){const t=f.g?f.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(e.za=t,Ve(e.F,e.D,t))}}t.G=3,t.l&&t.l.xa(),t.$&&(t.P=Date.now()-a.F,t.j.info("Handshake RTT: "+t.P+"ms"));var o=a;if((e=t).sa=Wn(e,e.H?e.ka:null,e.V),o.J){on(e.h,o);var c=o,u=e.J;u&&c.setTimeout(u),c.B&&(xe(c),_e(c)),e.g=o}else qn(e);0<t.i.length&&Fn(t)}else"stop"!=h[0]&&"close"!=h[0]||Qn(t,7);else 3==t.G&&("stop"==h[0]||"close"==h[0]?"stop"==h[0]?Qn(t,7):On(t):"noop"!=h[0]&&t.l&&t.l.wa(h),t.A=0)}Zt()}catch(t){}}function ke(a,b){if(a.forEach&&"function"==typeof a.forEach)a.forEach(b,void 0);else if(f(a)||"string"==typeof a)Array.prototype.forEach.call(a,b,void 0);else for(var t=function(a){if(a.oa&&"function"==typeof a.oa)return a.oa();if(!a.W||"function"!=typeof a.W){if("undefined"!=typeof Map&&a instanceof Map)return Array.from(a.keys());if(!("undefined"!=typeof Set&&a instanceof Set)){if(f(a)||"string"==typeof a){var b=[];a=a.length;for(var t=0;t<a;t++)b.push(t);return b}b=[],t=0;for(const e in a)b[t++]=e;return b}}}(a),e=function(a){if(a.W&&"function"==typeof a.W)return a.W();if("undefined"!=typeof Map&&a instanceof Map||"undefined"!=typeof Set&&a instanceof Set)return Array.from(a.values());if("string"==typeof a)return a.split("");if(f(a)){for(var b=[],t=a.length,e=0;e<t;e++)b.push(a[e]);return b}for(e in b=[],t=0,a)b[t++]=a[e];return b}(a),n=e.length,r=0;r<n;r++)b.call(void 0,e[r],t&&t[r],a)}(r=me.prototype).setTimeout=function(a){this.O=a},r.ib=function(a){a=a.target;const b=this.L;b&&3==xn(a)?b.l():this.La(a)},r.La=function(a){try{if(a==this.g)t:{const d=xn(this.g);var b=this.g.Ea();this.g.aa();if(!(3>d)&&(3!=d||U||this.g&&(this.h.h||this.g.fa()||Dn(this.g)))){this.I||4!=d||7==b||Zt(),xe(this);var t=this.g.aa();this.Y=t;e:if(Ie(this)){var e=Dn(this.g);a="";var n=e.length,r=4==xn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ce(this),De(this);var o="";break e}this.h.i=new l.TextDecoder}for(b=0;b<n;b++)this.h.h=!0,a+=this.h.i.decode(e[b],{stream:r&&b==n-1});e.splice(0,n),this.h.g+=a,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==t,function(a,b,t,e,n,r,o){a.info((function(){return"XMLHTTP RESP ("+e+") [ attempt "+n+"]: "+b+"\n"+t+"\n"+r+" "+o}))}(this.j,this.u,this.A,this.m,this.U,d,t),this.i){if(this.Z&&!this.J){e:{if(this.g){var c,u=this.g;if((c=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!A(c)){var h=c;break e}}h=null}if(!(t=h)){this.i=!1,this.o=3,ee(12),Ce(this),De(this);break t}Wt(this.j,this.m,t,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ae(this,t)}this.P?(Te(this,d,o),U&&this.i&&3==d&&($t(this.S,this.T,"tick",this.hb),this.T.start())):(Wt(this.j,this.m,o,null),Ae(this,o)),4==d&&Ce(this),this.i&&!this.I&&(4==d?Gn(this.l,this):(this.i=!1,_e(this)))}else 400==t&&0<o.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),Ce(this),De(this)}}}catch(t){}},r.hb=function(){if(this.g){var a=xn(this.g),b=this.g.fa();this.C<b.length&&(xe(this),Te(this,a,b),this.i&&4!=a&&_e(this))}},r.cancel=function(){this.I=!0,Ce(this)},r.gb=function(){this.B=null;const a=Date.now();0<=a-this.V?(function(a,b){a.info((function(){return"TIMEOUT: "+b}))}(this.j,this.A),2!=this.K&&(Zt(),ee(17)),Ce(this),this.o=2,De(this)):Se(this,this.V-a)};var Ne=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Oe(a,b){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,a instanceof Oe){this.h=void 0!==b?b:a.h,Me(this,a.j),this.s=a.s,this.g=a.g,Fe(this,a.m),this.l=a.l,b=a.i;var t=new ze;t.i=b.i,b.g&&(t.g=new Map(b.g),t.h=b.h),Le(this,t),this.o=a.o}else a&&(t=String(a).match(Ne))?(this.h=!!b,Me(this,t[1]||"",!0),this.s=qe(t[2]||""),this.g=qe(t[3]||"",!0),Fe(this,t[4]),this.l=qe(t[5]||"",!0),Le(this,t[6]||"",!0),this.o=qe(t[7]||"")):(this.h=!!b,this.i=new ze(null,this.h))}function Re(a){return new Oe(a)}function Me(a,b,t){a.j=t?qe(b,!0):b,a.j&&(a.j=a.j.replace(/:$/,""))}function Fe(a,b){if(b){if(b=Number(b),isNaN(b)||0>b)throw Error("Bad port number "+b);a.m=b}else a.m=null}function Le(a,b,t){b instanceof ze?(a.i=b,function(a,b){b&&!a.j&&(We(a),a.i=null,a.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(He(this,e),Xe(this,n,t))}),a)),a.j=b}(a.i,a.h)):(t||(b=Ue(b,$e)),a.i=new ze(b,a.h))}function Ve(a,b,t){a.i.set(b,t)}function Pe(a){return Ve(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),a}function qe(a,b){return a?b?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function Ue(a,b,t){return"string"==typeof a?(a=encodeURI(a).replace(b,Be),t&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function Be(a){return"%"+((a=a.charCodeAt(0))>>4&15).toString(16)+(15&a).toString(16)}Oe.prototype.toString=function(){var a=[],b=this.j;b&&a.push(Ue(b,je,!0),":");var t=this.g;return(t||"file"==b)&&(a.push("//"),(b=this.s)&&a.push(Ue(b,je,!0),"@"),a.push(encodeURIComponent(String(t)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(t=this.m)&&a.push(":",String(t))),(t=this.l)&&(this.g&&"/"!=t.charAt(0)&&a.push("/"),a.push(Ue(t,"/"==t.charAt(0)?Ge:Ke,!0))),(t=this.i.toString())&&a.push("?",t),(t=this.o)&&a.push("#",Ue(t,Qe)),a.join("")};var je=/[#\/\?@]/g,Ke=/[#\?:]/g,Ge=/[#\?]/g,$e=/[#\?@]/g,Qe=/#/g;function ze(a,b){this.h=this.g=null,this.i=a||null,this.j=!!b}function We(a){a.g||(a.g=new Map,a.h=0,a.i&&function(a,b){if(a){a=a.split("&");for(var t=0;t<a.length;t++){var e=a[t].indexOf("="),n=null;if(0<=e){var r=a[t].substring(0,e);n=a[t].substring(e+1)}else r=a[t];b(r,n?decodeURIComponent(n.replace(/\+/g," ")):"")}}}(a.i,(function(b,t){a.add(decodeURIComponent(b.replace(/\+/g," ")),t)})))}function He(a,b){We(a),b=Je(a,b),a.g.has(b)&&(a.i=null,a.h-=a.g.get(b).length,a.g.delete(b))}function Ye(a,b){return We(a),b=Je(a,b),a.g.has(b)}function Xe(a,b,t){He(a,b),0<t.length&&(a.i=null,a.g.set(Je(a,b),S(t)),a.h+=t.length)}function Je(a,b){return b=String(b),a.j&&(b=b.toLowerCase()),b}(r=ze.prototype).add=function(a,b){We(this),this.i=null,a=Je(this,a);var t=this.g.get(a);return t||this.g.set(a,t=[]),t.push(b),this.h+=1,this},r.forEach=function(a,b){We(this),this.g.forEach((function(t,e){t.forEach((function(t){a.call(b,t,e,this)}),this)}),this)},r.oa=function(){We(this);const a=Array.from(this.g.values()),b=Array.from(this.g.keys()),t=[];for(let e=0;e<b.length;e++){const n=a[e];for(let r=0;r<n.length;r++)t.push(b[e])}return t},r.W=function(a){We(this);let b=[];if("string"==typeof a)Ye(this,a)&&(b=b.concat(this.g.get(Je(this,a))));else{a=Array.from(this.g.values());for(let t=0;t<a.length;t++)b=b.concat(a[t])}return b},r.set=function(a,b){return We(this),this.i=null,Ye(this,a=Je(this,a))&&(this.h-=this.g.get(a).length),this.g.set(a,[b]),this.h+=1,this},r.get=function(a,b){return a&&0<(a=this.W(a)).length?String(a[0]):b},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const a=[],b=Array.from(this.g.keys());for(var t=0;t<b.length;t++){var e=b[t];const r=encodeURIComponent(String(e)),o=this.W(e);for(e=0;e<o.length;e++){var n=r;""!==o[e]&&(n+="="+encodeURIComponent(String(o[e]))),a.push(n)}}return this.i=a.join("&")};function Ze(a){this.l=a||tn,l.PerformanceNavigationTiming?a=0<(a=l.performance.getEntriesByType("navigation")).length&&("hq"==a[0].nextHopProtocol||"h2"==a[0].nextHopProtocol):a=!!(l.g&&l.g.Ga&&l.g.Ga()&&l.g.Ga().$b),this.j=a?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var tn=10;function en(a){return!!a.h||!!a.g&&a.g.size>=a.j}function nn(a){return a.h?1:a.g?a.g.size:0}function rn(a,b){return a.h?a.h==b:!!a.g&&a.g.has(b)}function sn(a,b){a.g?a.g.add(b):a.h=b}function on(a,b){a.h&&a.h==b?a.h=null:a.g&&a.g.has(b)&&a.g.delete(b)}function an(a){if(null!=a.h)return a.i.concat(a.h.D);if(null!=a.g&&0!==a.g.size){let b=a.i;for(const t of a.g.values())b=b.concat(t.D);return b}return S(a.i)}function un(){}function cn(){this.g=new un}function hn(a,b,t){const e=t||"";try{ke(a,(function(t,n){let r=t;p(t)&&(r=Ct(t)),b.push(e+n+"="+encodeURIComponent(r))}))}catch(t){throw b.push(e+"type="+encodeURIComponent("_badmap")),t}}function dd(a,b,t,e,n){try{b.onload=null,b.onerror=null,b.onabort=null,b.ontimeout=null,n(e)}catch(t){}}function ln(a){this.l=a.ac||null,this.j=a.jb||!1}function dn(a,b){St.call(this),this.D=a,this.u=b,this.m=void 0,this.readyState=fn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Ze.prototype.cancel=function(){if(this.i=an(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const a of this.g.values())a.cancel();this.g.clear()}},un.prototype.stringify=function(a){return l.JSON.stringify(a,void 0)},un.prototype.parse=function(a){return l.JSON.parse(a,void 0)},T(ln,oe),ln.prototype.g=function(){return new dn(this.l,this.j)},ln.prototype.i=function(a){return function(){return a}}({}),T(dn,St);var fn=0;function mn(a){a.j.read().then(a.Ta.bind(a)).catch(a.ga.bind(a))}function gn(a){a.readyState=4,a.l=null,a.j=null,a.A=null,pn(a)}function pn(a){a.onreadystatechange&&a.onreadystatechange.call(a)}(r=dn.prototype).open=function(a,b){if(this.readyState!=fn)throw this.abort(),Error("Error reopening a connection");this.C=a,this.B=b,this.readyState=1,pn(this)},r.send=function(a){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const b={headers:this.v,method:this.C,credentials:this.m,cache:void 0};a&&(b.body=a),(this.D||l).fetch(new Request(this.B,b)).then(this.Wa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,gn(this)),this.readyState=fn},r.Wa=function(a){if(this.g&&(this.l=a,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=a.headers,this.readyState=2,pn(this)),this.g&&(this.readyState=3,pn(this),this.g)))if("arraybuffer"===this.responseType)a.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==l.ReadableStream&&"body"in a){if(this.j=a.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;mn(this)}else a.text().then(this.Va.bind(this),this.ga.bind(this))},r.Ta=function(a){if(this.g){if(this.u&&a.value)this.response.push(a.value);else if(!this.u){var b=a.value?a.value:new Uint8Array(0);(b=this.A.decode(b,{stream:!a.done}))&&(this.response=this.responseText+=b)}a.done?gn(this):pn(this),3==this.readyState&&mn(this)}},r.Va=function(a){this.g&&(this.response=this.responseText=a,gn(this))},r.Ua=function(a){this.g&&(this.response=a,gn(this))},r.ga=function(){this.g&&gn(this)},r.setRequestHeader=function(a,b){this.v.append(a,b)},r.getResponseHeader=function(a){return this.h&&this.h.get(a.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const a=[],b=this.h.entries();for(var t=b.next();!t.done;)t=t.value,a.push(t[0]+": "+t[1]),t=b.next();return a.join("\r\n")},Object.defineProperty(dn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(a){this.m=a?"include":"same-origin"}});var yn=l.JSON.parse;function wn(a){St.call(this),this.headers=new Map,this.u=a||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=vn,this.K=this.L=!1}T(wn,St);var vn="",bn=/^https?$/i,In=["POST","PUT"];function Tn(a,b){a.h=!1,a.g&&(a.l=!0,a.g.abort(),a.l=!1),a.j=b,a.m=5,En(a),_n(a)}function En(a){a.D||(a.D=!0,xt(a,"complete"),xt(a,"error"))}function td(a){if(a.h&&void 0!==h&&(!a.C[1]||4!=xn(a)||2!=a.aa()))if(a.v&&4==xn(a))Ut(a.Ha,0,a);else if(xt(a,"readystatechange"),4==xn(a)){a.h=!1;try{const c=a.aa();t:switch(c){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var b=!0;break t;default:b=!1}var t;if(!(t=b)){var e;if(e=0===c){var n=String(a.H).match(Ne)[1]||null;if(!n&&l.self&&l.self.location){var r=l.self.location.protocol;n=r.substr(0,r.length-1)}e=!bn.test(n?n.toLowerCase():"")}t=e}if(t)xt(a,"complete"),xt(a,"success");else{a.m=6;try{var o=2<xn(a)?a.g.statusText:""}catch(t){o=""}a.j=o+" ["+a.aa()+"]",En(a)}}finally{_n(a)}}}function _n(a,b){if(a.g){Sn(a);const t=a.g,e=a.C[0]?d:null;a.g=null,a.C=null,b||xt(a,"ready");try{t.onreadystatechange=e}catch(t){}}}function Sn(a){a.g&&a.K&&(a.g.ontimeout=null),a.A&&(l.clearTimeout(a.A),a.A=null)}function xn(a){return a.g?a.g.readyState:0}function Dn(a){try{if(!a.g)return null;if("response"in a.g)return a.g.response;switch(a.J){case vn:case"text":return a.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in a.g)return a.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Cn(a){let b="";return it(a,(function(t,e){b+=e,b+=":",b+=t,b+="\r\n"})),b}function An(a,b,t){t:{for(e in t){var e=!1;break t}e=!0}e||(t=Cn(t),"string"==typeof a?null!=t&&encodeURIComponent(String(t)):Ve(a,b,t))}function kn(a,b,t){return t&&t.internalChannelParams&&t.internalChannelParams[a]||b}function Nn(a){this.Ca=0,this.i=[],this.j=new zt,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=kn("failFast",!1,a),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=kn("baseRetryDelayMs",5e3,a),this.bb=kn("retryDelaySeedMs",1e4,a),this.$a=kn("forwardChannelMaxRetries",2,a),this.ta=kn("forwardChannelRequestTimeoutMs",2e4,a),this.ra=a&&a.xmlHttpFactory||void 0,this.Da=a&&a.Zb||!1,this.J=void 0,this.H=a&&a.supportsCrossDomainXhr||!1,this.I="",this.h=new Ze(a&&a.concurrentRequestLimit),this.Fa=new cn,this.O=a&&a.fastHandshake||!1,this.N=a&&a.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=a&&a.Xb||!1,a&&a.Aa&&this.j.Aa(),a&&a.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&a&&a.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function On(a){if(Mn(a),3==a.G){var b=a.U++,t=Re(a.F);Ve(t,"SID",a.I),Ve(t,"RID",b),Ve(t,"TYPE","terminate"),Vn(a,t),(b=new me(a,a.j,b,void 0)).K=2,b.v=Pe(Re(t)),t=!1,l.navigator&&l.navigator.sendBeacon&&(t=l.navigator.sendBeacon(b.v.toString(),"")),!t&&l.Image&&((new Image).src=b.v,t=!0),t||(b.g=Hn(b.l,null),b.g.da(b.v)),b.F=Date.now(),_e(b)}zn(a)}function Rn(a){a.g&&(Bn(a),a.g.cancel(),a.g=null)}function Mn(a){Rn(a),a.u&&(l.clearTimeout(a.u),a.u=null),Kn(a),a.h.cancel(),a.m&&("number"==typeof a.m&&l.clearTimeout(a.m),a.m=null)}function Fn(a){en(a.h)||a.m||(a.m=!0,Mt(a.Ja,a),a.C=0)}function Ln(a,b){var t;t=b?b.m:a.U++;const e=Re(a.F);Ve(e,"SID",a.I),Ve(e,"RID",t),Ve(e,"AID",a.T),Vn(a,e),a.o&&a.s&&An(e,a.o,a.s),t=new me(a,a.j,t,a.C+1),null===a.o&&(t.H=a.s),b&&(a.i=b.D.concat(a.i)),b=Pn(a,t,1e3),t.setTimeout(Math.round(.5*a.ta)+Math.round(.5*a.ta*Math.random())),sn(a.h,t),ve(t,e,b)}function Vn(a,b){a.ia&&it(a.ia,(function(t,e){Ve(b,e,t)})),a.l&&ke({},(function(t,e){Ve(b,e,t)}))}function Pn(a,b,t){t=Math.min(a.i.length,t);var e=a.l?q(a.l.Ra,a.l,a):null;t:{var n=a.i;let r=-1;for(;;){const o=["count="+t];-1==r?0<t?(r=n[0].h,o.push("ofs="+r)):r=0:o.push("ofs="+r);let c=!0;for(let u=0;u<t;u++){let t=n[u].h;const h=n[u].g;if(t-=r,0>t)r=Math.max(0,n[u].h-100),c=!1;else try{hn(h,o,"req"+t+"_")}catch(t){e&&e(h)}}if(c){e=o.join("&");break t}}}return a=a.i.splice(0,t),b.D=a,e}function qn(a){a.g||a.u||(a.Z=1,Mt(a.Ia,a),a.A=0)}function Un(a){return!(a.g||a.u||3<=a.A)&&(a.Z++,a.u=re(q(a.Ia,a),$n(a,a.A)),a.A++,!0)}function Bn(a){null!=a.B&&(l.clearTimeout(a.B),a.B=null)}function jn(a){a.g=new me(a,a.j,"rpc",a.Z),null===a.o&&(a.g.H=a.s),a.g.N=0;var b=Re(a.sa);Ve(b,"RID","rpc"),Ve(b,"SID",a.I),Ve(b,"CI",a.L?"0":"1"),Ve(b,"AID",a.T),Ve(b,"TYPE","xmlhttp"),Vn(a,b),a.o&&a.s&&An(b,a.o,a.s),a.J&&a.g.setTimeout(a.J);var t=a.g;a=a.ka,t.K=1,t.v=Pe(Re(b)),t.s=null,t.P=!0,be(t,a)}function Kn(a){null!=a.v&&(l.clearTimeout(a.v),a.v=null)}function Gn(a,b){var t=null;if(a.g==b){Kn(a),Bn(a),a.g=null;var e=2}else{if(!rn(a.h,b))return;t=b.D,on(a.h,b),e=1}if(0!=a.G)if(a.pa=b.Y,b.i)if(1==e){t=b.s?b.s.length:0,b=Date.now()-b.F;var n=a.C;xt(e=Xt(),new ne(e,t)),Fn(a)}else qn(a);else if(3==(n=b.o)||0==n&&0<a.pa||!(1==e&&function(a,b){return!(nn(a.h)>=a.h.j-(a.m?1:0)||(a.m?(a.i=b.D.concat(a.i),0):1==a.G||2==a.G||a.C>=(a.Za?0:a.$a)||(a.m=re(q(a.Ja,a,b),$n(a,a.C)),a.C++,0)))}(a,b)||2==e&&Un(a)))switch(t&&0<t.length&&(b=a.h,b.i=b.i.concat(t)),n){case 1:Qn(a,5);break;case 4:Qn(a,10);break;case 3:Qn(a,6);break;default:Qn(a,2)}}function $n(a,b){let t=a.Xa+Math.floor(Math.random()*a.bb);return a.l||(t*=2),t*b}function Qn(a,b){if(a.j.info("Error code "+b),2==b){var t=null;a.l&&(t=null);var e=q(a.kb,a);t||(t=new Oe("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Me(t,"https"),Pe(t)),function(a,b){const t=new zt;if(l.Image){const e=new Image;e.onload=I(dd,t,e,"TestLoadImage: loaded",!0,b),e.onerror=I(dd,t,e,"TestLoadImage: error",!1,b),e.onabort=I(dd,t,e,"TestLoadImage: abort",!1,b),e.ontimeout=I(dd,t,e,"TestLoadImage: timeout",!1,b),l.setTimeout((function(){e.ontimeout&&e.ontimeout()}),1e4),e.src=a}else b(!1)}(t.toString(),e)}else ee(2);a.G=0,a.l&&a.l.va(b),zn(a),Mn(a)}function zn(a){if(a.G=0,a.la=[],a.l){const b=an(a.h);0==b.length&&0==a.i.length||(x(a.la,b),x(a.la,a.i),a.h.i.length=0,S(a.i),a.i.length=0),a.l.ua()}}function Wn(a,b,t){var e=t instanceof Oe?Re(t):new Oe(t,void 0);if(""!=e.g)b&&(e.g=b+"."+e.g),Fe(e,e.m);else{var n=l.location;e=n.protocol,b=b?b+"."+n.hostname:n.hostname,n=+n.port;var r=new Oe(null,void 0);e&&Me(r,e),b&&(r.g=b),n&&Fe(r,n),t&&(r.l=t),e=r}return t=a.D,b=a.za,t&&b&&Ve(e,t,b),Ve(e,"VER",a.ma),Vn(a,e),e}function Hn(a,b,t){if(b&&!a.H)throw Error("Can't create secondary domain capable XhrIo object.");return(b=t&&a.Da&&!a.ra?new wn(new ln({jb:!0})):new wn(a.ra)).Ka(a.H),b}function Yn(){}function Xn(){if(V&&!(10<=Number(X)))throw Error("Environmental error: no available transport.")}function Jn(a,b){St.call(this),this.g=new Nn(b),this.l=a,this.h=b&&b.messageUrlParams||null,a=b&&b.messageHeaders||null,b&&b.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.g.s=a,a=b&&b.initMessageHeaders||null,b&&b.messageContentType&&(a?a["X-WebChannel-Content-Type"]=b.messageContentType:a={"X-WebChannel-Content-Type":b.messageContentType}),b&&b.ya&&(a?a["X-WebChannel-Client-Profile"]=b.ya:a={"X-WebChannel-Client-Profile":b.ya}),this.g.S=a,(a=b&&b.Yb)&&!A(a)&&(this.g.o=a),this.A=b&&b.supportsCrossDomainXhr||!1,this.v=b&&b.sendRawJson||!1,(b=b&&b.httpSessionIdParam)&&!A(b)&&(this.g.D=b,null!==(a=this.h)&&b in a&&(b in(a=this.h)&&delete a[b])),this.j=new nr(this)}function Zn(a){le.call(this);var b=a.__sm__;if(b){t:{for(const t in b){a=t;break t}a=void 0}(this.i=a)&&(a=this.i,b=null!==b&&a in b?b[a]:void 0),this.data=b}else this.data=a}function er(){de.call(this),this.status=1}function nr(a){this.g=a}(r=wn.prototype).Ka=function(a){this.L=a},r.da=function(a,b,t,e){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+a);b=b?b.toUpperCase():"GET",this.H=a,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ce.g(),this.C=this.u?ae(this.u):ae(ce),this.g.onreadystatechange=q(this.Ha,this);try{this.F=!0,this.g.open(b,String(a),!0),this.F=!1}catch(t){return void Tn(this,t)}if(a=t||"",t=new Map(this.headers),e)if(Object.getPrototypeOf(e)===Object.prototype)for(var n in e)t.set(n,e[n]);else{if("function"!=typeof e.keys||"function"!=typeof e.get)throw Error("Unknown input type for opt_headers: "+String(e));for(const n of e.keys())t.set(n,e.get(n))}e=Array.from(t.keys()).find((t=>"content-type"==t.toLowerCase())),n=l.FormData&&a instanceof l.FormData,!(0<=_(In,b))||e||n||t.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,n]of t)this.g.setRequestHeader(e,n);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Sn(this),0<this.B&&((this.K=function(a){return V&&H()&&"number"==typeof a.timeout&&void 0!==a.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=q(this.qa,this)):this.A=Ut(this.qa,this.B,this)),this.v=!0,this.g.send(a),this.v=!1}catch(t){Tn(this,t)}},r.qa=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,xt(this,"timeout"),this.abort(8))},r.abort=function(a){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=a||7,xt(this,"complete"),xt(this,"abort"),_n(this))},r.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),_n(this,!0)),wn.X.M.call(this)},r.Ha=function(){this.s||(this.F||this.v||this.l?td(this):this.fb())},r.fb=function(){td(this)},r.aa=function(){try{return 2<xn(this)?this.g.status:-1}catch(t){return-1}},r.fa=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},r.Sa=function(a){if(this.g){var b=this.g.responseText;return a&&0==b.indexOf(a)&&(b=b.substring(a.length)),yn(b)}},r.Ea=function(){return this.m},r.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(r=Nn.prototype).ma=8,r.G=1,r.Ja=function(a){if(this.m)if(this.m=null,1==this.G){if(!a){this.U=Math.floor(1e5*Math.random()),a=this.U++;const n=new me(this,this.j,a,void 0);let r=this.s;if(this.S&&(r?(r=ot(r),ut(r,this.S)):r=this.S),null!==this.o||this.N||(n.H=r,r=null),this.O)t:{for(var b=0,t=0;t<this.i.length;t++){var e=this.i[t];if(void 0===(e="__data__"in e.g&&"string"==typeof(e=e.g.__data__)?e.length:void 0))break;if(4096<(b+=e)){b=t;break t}if(4096===b||t===this.i.length-1){b=t+1;break t}}b=1e3}else b=1e3;b=Pn(this,n,b),Ve(t=Re(this.F),"RID",a),Ve(t,"CVER",22),this.D&&Ve(t,"X-HTTP-Session-Id",this.D),Vn(this,t),r&&(this.N?b="headers="+encodeURIComponent(String(Cn(r)))+"&"+b:this.o&&An(t,this.o,r)),sn(this.h,n),this.Ya&&Ve(t,"TYPE","init"),this.O?(Ve(t,"$req",b),Ve(t,"SID","null"),n.Z=!0,ve(n,t,null)):ve(n,t,b),this.G=2}}else 3==this.G&&(a?Ln(this,a):0==this.i.length||en(this.h)||Ln(this))},r.Ia=function(){if(this.u=null,jn(this),this.$&&!(this.K||null==this.g||0>=this.P)){var a=2*this.P;this.j.info("BP detection timer enabled: "+a),this.B=re(q(this.eb,this),a)}},r.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,ee(10),Rn(this),jn(this))},r.cb=function(){null!=this.v&&(this.v=null,Rn(this),Un(this),ee(19))},r.kb=function(a){a?(this.j.info("Successfully pinged google.com"),ee(2)):(this.j.info("Failed to ping google.com"),ee(1))},(r=Yn.prototype).xa=function(){},r.wa=function(){},r.va=function(){},r.ua=function(){},r.Ra=function(){},Xn.prototype.g=function(a,b){return new Jn(a,b)},T(Jn,St),Jn.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var a=this.g,b=this.l,t=this.h||void 0;ee(0),a.V=b,a.ia=t||{},a.L=a.Y,a.F=Wn(a,null,a.V),Fn(a)},Jn.prototype.close=function(){On(this.g)},Jn.prototype.u=function(a){var b=this.g;if("string"==typeof a){var t={};t.__data__=a,a=t}else this.v&&((t={}).__data__=Ct(a),a=t);b.i.push(new class{constructor(a,b){this.h=a,this.g=b}}(b.ab++,a)),3==b.G&&Fn(b)},Jn.prototype.M=function(){this.g.l=null,delete this.j,On(this.g),delete this.g,Jn.X.M.call(this)},T(Zn,le),T(er,de),T(nr,Yn),nr.prototype.xa=function(){xt(this.g,"a")},nr.prototype.wa=function(a){xt(this.g,new Zn(a))},nr.prototype.va=function(a){xt(this.g,new er)},nr.prototype.ua=function(){xt(this.g,"b")},Xn.prototype.createWebChannel=Xn.prototype.g,Jn.prototype.send=Jn.prototype.u,Jn.prototype.open=Jn.prototype.m,Jn.prototype.close=Jn.prototype.close,se.NO_ERROR=0,se.TIMEOUT=8,se.HTTP_ERROR=6,ie.COMPLETE="complete",ue.EventType=he,he.OPEN="a",he.CLOSE="b",he.ERROR="c",he.MESSAGE="d",St.prototype.listen=St.prototype.N,wn.prototype.listenOnce=wn.prototype.O,wn.prototype.getLastError=wn.prototype.Oa,wn.prototype.getLastErrorCode=wn.prototype.Ea,wn.prototype.getStatus=wn.prototype.aa,wn.prototype.getResponseJson=wn.prototype.Sa,wn.prototype.getResponseText=wn.prototype.fa,wn.prototype.send=wn.prototype.da,wn.prototype.setWithCredentials=wn.prototype.Ka;var rr=c.createWebChannelTransport=function(){return new Xn},sr=c.getStatEventTarget=function(){return Xt()},ir=c.ErrorCode=se,or=c.EventType=ie,ar=c.Event=Ht,ur=c.Stat={sb:0,vb:1,wb:2,Pb:3,Ub:4,Rb:5,Sb:6,Qb:7,Ob:8,Tb:9,PROXY:10,NOPROXY:11,Mb:12,Ib:13,Jb:14,Hb:15,Kb:16,Lb:17,ob:18,nb:19,pb:20},cr=c.FetchXmlHttpFactory=ln,lr=c.WebChannel=ue,dr=c.XhrIo=wn}).call(this,n(39))},265:function(t,e,n){"use strict";n.r(e);var r=n(254),o=n(261),c=n(253),h=n(255);function l(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new o.g("invalid-argument",`Invalid options passed to function ${t}(): You cannot specify both "merge" and "mergeFields".`);return e}function d(){if("undefined"==typeof Uint8Array)throw new o.g("unimplemented","Uint8Arrays are not available in this environment.")}function f(){if(!Object(o.r)())throw new o.g("unimplemented","Blobs are unavailable in Firestore in this environment.")}class m{constructor(t){this._delegate=t}static fromBase64String(t){return f(),new m(o.b.fromBase64String(t))}static fromUint8Array(t){return d(),new m(o.b.fromUint8Array(t))}toBase64(){return f(),this._delegate.toBase64()}toUint8Array(){return d(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function y(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const object=t;for(const t of e)if(t in object&&"function"==typeof object[t])return!0;return!1}(t,["next","error","complete"])}class w{enableIndexedDbPersistence(t,e){return Object(o.F)(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return Object(o.G)(t._delegate)}clearIndexedDbPersistence(t){return Object(o.x)(t._delegate)}}class v{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof o.m||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){const e=this._delegate._getSettings();t.merge||e.host===t.host||Object(o.s)("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)}useEmulator(t,e,n={}){Object(o.A)(this._delegate,t,e,n)}enableNetwork(){return Object(o.H)(this._delegate)}disableNetwork(){return Object(o.D)(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Object(o.t)("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Object(o.lb)(this._delegate)}onSnapshotsInSync(t){return Object(o.Y)(this._delegate,t)}get app(){if(!this._appCompat)throw new o.g("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new M(this,Object(o.y)(this._delegate,t))}catch(t){throw x(t,"collection()","Firestore.collection()")}}doc(t){try{return new S(this,Object(o.E)(this._delegate,t))}catch(t){throw x(t,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new N(this,Object(o.z)(this._delegate,t))}catch(t){throw x(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Object(o.db)(this._delegate,(e=>t(new T(this,e))))}batch(){return Object(o.K)(this._delegate),new E(new o.l(this._delegate,(t=>Object(o.L)(this._delegate,t))))}loadBundle(t){return Object(o.V)(this._delegate,t)}namedQuery(t){return Object(o.W)(this._delegate,t).then((t=>t?new N(this,t):null))}}class I extends o.a{constructor(t){super(),this.firestore=t}convertBytes(t){return new m(new o.b(t))}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return S.forKey(e,this.firestore,null)}}class T{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new I(t)}get(t){const e=F(t);return this._delegate.get(e).then((t=>new A(this._firestore,new o.e(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,e.converter))))}set(t,data,e){const n=F(t);return e?(l("Transaction.set",e),this._delegate.set(n,data,e)):this._delegate.set(n,data),this}update(t,e,n,...r){const o=F(t);return 2===arguments.length?this._delegate.update(o,e):this._delegate.update(o,e,n,...r),this}delete(t){const e=F(t);return this._delegate.delete(e),this}}class E{constructor(t){this._delegate=t}set(t,data,e){const n=F(t);return e?(l("WriteBatch.set",e),this._delegate.set(n,data,e)):this._delegate.set(n,data),this}update(t,e,n,...r){const o=F(t);return 2===arguments.length?this._delegate.update(o,e):this._delegate.update(o,e,n,...r),this}delete(t){const e=F(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class _{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){const n=new o.i(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new k(this._firestore,n),null!=e?e:{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){const n=_.INSTANCES;let r=n.get(t);r||(r=new WeakMap,n.set(t,r));let o=r.get(e);return o||(o=new _(t,new I(t),e),r.set(e,o)),o}}_.INSTANCES=new WeakMap;class S{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new I(t)}static forPath(path,t,e){if(path.length%2!=0)throw new o.g("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${path.canonicalString()} has ${path.length}`);return new S(t,new o.d(t._delegate,e,new o.n(path)))}static forKey(t,e,n){return new S(e,new o.d(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new M(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new M(this.firestore,Object(o.y)(this._delegate,t))}catch(t){throw x(t,"collection()","DocumentReference.collection()")}}isEqual(t){return(t=Object(c.l)(t))instanceof o.d&&Object(o.cb)(this._delegate,t)}set(t,e){e=l("DocumentReference.set",e);try{return e?Object(o.fb)(this._delegate,t,e):Object(o.fb)(this._delegate,t)}catch(t){throw x(t,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return 1===arguments.length?Object(o.kb)(this._delegate,t):Object(o.kb)(this._delegate,t,e,...n)}catch(t){throw x(t,"updateDoc()","DocumentReference.update()")}}delete(){return Object(o.B)(this._delegate)}onSnapshot(...t){const e=D(t),n=C(t,(t=>new A(this.firestore,new o.e(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter))));return Object(o.X)(this._delegate,e,n)}get(t){let e;return e="cache"===(null==t?void 0:t.source)?Object(o.N)(this._delegate):"server"===(null==t?void 0:t.source)?Object(o.O)(this._delegate):Object(o.M)(this._delegate),e.then((t=>new A(this.firestore,new o.e(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter))))}withConverter(t){return new S(this.firestore,t?this._delegate.withConverter(_.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function x(t,e,n){return t.message=t.message.replace(e,n),t}function D(t){for(const e of t)if("object"==typeof e&&!y(e))return e;return{}}function C(t,e){var n,r;let o;return o=y(t[0])?t[0]:y(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]},{next:t=>{o.next&&o.next(e(t))},error:null===(n=o.error)||void 0===n?void 0:n.bind(o),complete:null===(r=o.complete)||void 0===r?void 0:r.bind(o)}}class A{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new S(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Object(o.hb)(this._delegate,t._delegate)}}class k extends A{data(t){const data=this._delegate.data(t);return Object(o.q)(void 0!==data,"Document in a QueryDocumentSnapshot should exist"),data}}class N{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new I(t)}where(t,e,n){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.mb)(t,e,n)))}catch(t){throw x(t,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.Z)(t,e)))}catch(t){throw x(t,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.T)(t)))}catch(t){throw x(t,"limit()","Query.limit()")}}limitToLast(t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.U)(t)))}catch(t){throw x(t,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.jb)(...t)))}catch(t){throw x(t,"startAt()","Query.startAt()")}}startAfter(...t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.ib)(...t)))}catch(t){throw x(t,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.J)(...t)))}catch(t){throw x(t,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new N(this.firestore,Object(o.ab)(this._delegate,Object(o.I)(...t)))}catch(t){throw x(t,"endAt()","Query.endAt()")}}isEqual(t){return Object(o.bb)(this._delegate,t._delegate)}get(t){let e;return e="cache"===(null==t?void 0:t.source)?Object(o.Q)(this._delegate):"server"===(null==t?void 0:t.source)?Object(o.R)(this._delegate):Object(o.P)(this._delegate),e.then((t=>new R(this.firestore,new o.j(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot))))}onSnapshot(...t){const e=D(t),n=C(t,(t=>new R(this.firestore,new o.j(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot))));return Object(o.X)(this._delegate,e,n)}withConverter(t){return new N(this.firestore,t?this._delegate.withConverter(_.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}class O{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new k(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class R{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new N(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map((t=>new k(this._firestore,t)))}docChanges(t){return this._delegate.docChanges(t).map((t=>new O(this._firestore,t)))}forEach(t,e){this._delegate.forEach((n=>{t.call(e,new k(this._firestore,n))}))}isEqual(t){return Object(o.hb)(this._delegate,t._delegate)}}class M extends N{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){const t=this._delegate.parent;return t?new S(this.firestore,t):null}doc(t){try{return new S(this.firestore,void 0===t?Object(o.E)(this._delegate):Object(o.E)(this._delegate,t))}catch(t){throw x(t,"doc()","CollectionReference.doc()")}}add(data){return Object(o.u)(this._delegate,data).then((t=>new S(this.firestore,t)))}isEqual(t){return Object(o.cb)(this._delegate,t._delegate)}withConverter(t){return new M(this.firestore,t?this._delegate.withConverter(_.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function F(t){return Object(o.p)(t,o.d)}class L{constructor(...t){this._delegate=new o.f(...t)}static documentId(){return new L(o.o.keyField().canonicalString())}isEqual(t){return(t=Object(c.l)(t))instanceof o.f&&this._delegate._internalPath.isEqual(t._internalPath)}}class V{constructor(t){this._delegate=t}static serverTimestamp(){const t=Object(o.eb)();return t._methodName="FieldValue.serverTimestamp",new V(t)}static delete(){const t=Object(o.C)();return t._methodName="FieldValue.delete",new V(t)}static arrayUnion(...t){const e=Object(o.w)(...t);return e._methodName="FieldValue.arrayUnion",new V(e)}static arrayRemove(...t){const e=Object(o.v)(...t);return e._methodName="FieldValue.arrayRemove",new V(e)}static increment(t){const e=Object(o.S)(t);return e._methodName="FieldValue.increment",new V(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}}const P={Firestore:v,GeoPoint:o.h,Timestamp:o.k,Blob:m,Transaction:T,WriteBatch:E,DocumentReference:S,DocumentSnapshot:A,Query:N,QueryDocumentSnapshot:k,QuerySnapshot:R,CollectionReference:M,FieldPath:L,FieldValue:V,setLogLevel:function(t){Object(o.gb)(t)},CACHE_SIZE_UNLIMITED:o.c};var U,B;U=r.a,B=(t,e)=>new v(t,e,new w),U.INTERNAL.registerComponent(new h.a("firestore-compat",(t=>{const e=t.getProvider("app-compat").getImmediate(),n=t.getProvider("firestore").getImmediate();return B(e,n)}),"PUBLIC").setServiceProps(Object.assign({},P))),U.registerVersion("@firebase/firestore-compat","0.3.0")}}]);